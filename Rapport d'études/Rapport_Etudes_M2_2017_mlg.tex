\documentclass{bredele}
\usepackage{supertabular}
\usepackage{textcomp}
\usepackage{array}
\usepackage{color}
\usepackage{listings, xcolor}
\usepackage{pdfpages} 
\makeatletter\@addtoreset{chapter}{part}\makeatother

\definecolor{dkgreen}{rgb}{0,.6,0}
\definecolor{dkblue}{rgb}{0,0,.6}
\definecolor{dkyellow}{cmyk}{0,0,.8,.3}
\definecolor{myblue}{rgb}{0.101,0.133,0.207}
\definecolor{mypink}{rgb}{0.255,0,0.102}
\hypersetup{
colorlinks=true, %colorise les liens
breaklinks=true, %permet le retour à la ligne dans les liens trop longs
urlcolor= blue, %couleur des hyperliens
linkcolor= blue, %couleur des liens internes
citecolor=blue}   %couleur des liens de citati}

% ********* Table layout **************
\usepackage{booktabs}	  	%design of table, has an excellent documentation
%\usepackage{lscape}			%use this if you want to rotate the table together with the lines around the table
% ********* Header and Footer **********
\usepackage{listings, xcolor}
% ********* Header and Footer **********
\lstset{
  language        = HTML,
	upquote					= true,
  basicstyle      = \scriptsize,
  keywordstyle    = \color{dkblue},
  commentstyle    = \color{gray},
  breaklines,
	rulecolor				=\color{mypink},
	backgroundcolor	=\color{myblue!5},
	showspaces 			= false,
	showtabs				= false,
	alsodigit				=	{.:;},
	numbers					= left,
	stepnumber			= 5,
	firstnumber			= 1,
	numberfirstline = true,
	frame						= lines,
	columns					= fullflexible
	}
%################ End Preferences, Begin Document #####################
\usepackage{vmargin} %This give you full control over the used page arae, it maybe not the idea od Latex to do so, but I wanted to reduce to amount of white space on the page
\setpapersize{A4}
\title{Rapport d'études}
%% REMERCIEMENTS %%

\lesoustitre{}
\discipline{Master 2 Démographie}
\jury{
\begin{description}
		\item[Maître de stage~:] Loïc \textsc{Bourriquen}, Directeur d'études, AUDIAR
		\item[Tuteur pédagogique~:] Philippe \textsc{Cordazzo}, Prof. des Universit\'{e}s, Unistra
		\item[Lecteur~:] Nicolas \textsc{Cauchi-Duval}, Maître de Conférence, Unistra
\end{description}
}
\author{Marine Le Gall}
\date{\\\centering{28 Septembre 2017}}
\logouniversite{logo_univ} %nom du fichier
\scalelogouniversite{0.7} % mise a l'echelle de l'image (0.5=50% par exemple)
\logolabo{logo_labo}
\scalelogolabo{0.7}
\unite{\large{Institut de Démographie de l'Université de Strasbourg}}
\ecoledoc{\Large{Université de Strasbourg}}

\lstdefinelanguage{JavaScript}{
  keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
  keywordstyle	=\color{blue}\bfseries,
  ndkeywords		={class, export, boolean, throw, implements, import, this},
  ndkeywordstyle=\color{darkgray}\bfseries,
  identifierstyle=\color{black},
  sensitive			=false,
  comment				=[l]{//},
  morecomment		=[s]{/*}{*/},
  commentstyle	=\color{purple}\ttfamily,
  stringstyle		=\color{red}\ttfamily,
  morestring		=[b]',
  morestring		=[b]"
}
\lstset{frame		= tb,
language				=R,
keywordstyle		=\color{blue},
alsoletter			={.},
showtabs				=false
}

\begin{document}
\clearpage
\maketitle
\clearemptydoublepage
\addcontentsline{toc}{part}{Avant propos}
Ce document est le \textit{Rapport d'Etudes} de mon stage effectué au sein de l'Agence d'Urbanisme et de Développement Intercommunal de l'Agglomération Rennaise (AUDIAR) au cours du premier semestre 2017, dans le cadre de mon Master 2 de Démographie auprès de l'Université de Strasbourg. Ici sont présentés les éléments produits durant le stage, constituant les éléments nécessaires au projet. Les éléments de contexte sont présents dans un document complémentaire intitulé \textit{Rapport de Stage}.\\\\\\
L'ensemble est disponible sur un espace de dépôt en accès libre, à l'adresse qui suit :\\
\begin{center}
\href{www.github.com/mlegall/GIT1}{\ttfamily{\textbf{www.github.com/mlegall/GIT1}}}
\end{center}
\\\\Bons nombres de contenus étant informatiques, il est possible de les retrouver à travers les différents items se trouvant dans la racine définie ci-dessus.
Les liens directs vers ces documents au format PDF sont :\\\\
\ldots \href{https://github.com/mlegall/GIT1/blob/master/Rappor/RELANCESTAGE2.pdf}{\Large{Rapport de Stage}}\\
\\
\ldots \href{https://github.com/mlegall/GIT1/blob/master/Rappor/RELANCESTAGE2.pdf}{\Large{Rapport d'Etudes}}\\
\\
\begin{flushright}
Contact : \href{mailto:marine-legall@orange.fr}{\ttfamily{marine-legall@orange.fr}}
\end{flushright}
\tableofcontents
\clearemptydoublepage
\mainmatter
\part[Simulateur Démographique]{Simulateur démographique}
\includepdfmerge[nup=1x2, angle=90, linktodoc, scale = 0.80, offset =30mm -30mm, frame = true]
	{initial/synthese_stage_V5.pdf, 2-1,
	initial/synthese_stage_v5.pdf, 4-3}
\clearemptydoublepage
\chapter[Phase d'appropriation]{Appropriation}
\begin{lstlisting}[caption =Script R permettant d'insérer des données issues d'une requête stockée sur serveur MySql, keywordstyle=\color{blue}, stringstyle= \color{mypink}, commentstyle=\color{dkgreen}, frame =lines, language =R]
---
title: 'Importer ses données depuis MySql dans R'
author : 'Marine'
output: pdf_document
params:
  minimum: 100
  region: east
  data: results.csv
eval : false
---

/!\ Ne pas oublier de déconnecter en faisant tourner la dernière ligne 

1 - Mise en place des packages nécessaires
```{r eval= FALSE}
install.packages("RMySQL")
library("RMySQL")
```

2 - Connecting to MySQL
ICI remplir les champs : type de serveur, user, password, la base à charger, et le serveur 
```{r eval= FALSE}
mydb = dbConnect(MySQL(), user='root', password='', dbname='rc2009', host='localhost')
```

Visualisation de l importation de données
Listing Tables and Fields, i.e. tables dans la BDD de chargée
```{r eval= FALSE}
dbListTables(mydb)
```
-	Variables de la table choisie, A REMPLIR
```{r eval= FALSE}
dbListFields(mydb, 'fd_logemtzc_2013')
```

Importation des données nécessaires
- Ecrire dans objet R1 la requête en SQL des éléments à sélectionner, tout ou partie
```{r eval= FALSE}
Ri <- "SELECT * FROM rc2009.fd_logemtzc_2009 where commune='35278' "
```

- Récupération des éléments décrits dans la requête Ri
```{r eval= FALSE}
Bi <- dbGetQuery(mydb, R2)
```
 
4 bis - Création d une autre sous-base : copier coller bloc n°4 et ajouter +1 à Ri & Bi
```{r eval= FALSE}

```


DECONNEXION !!
```{r eval= FALSE}
dbDisconnect (mydb)
```
\end{lstlisting}
\newpage
\begin{figure}
\centering
\includegraphics[width=\textwidth]{initial/de_mysqlar.pdf}
\caption{Notice réalisée pour l'extraction ciblée de données SQL dans environnement R, générée depuis un format Markdown}
\end{figure}
\clearemptydoublepage
\chapter[Construction de la base de données]{Construction de la base de données}
\lstset{
  language        = HTML,
	upquote					= true,
  basicstyle      = \scriptsize,
  keywordstyle    = \color{dkblue},
  commentstyle    = \color{gray},
  breaklines,
	rulecolor				=\color{mypink},
	backgroundcolor	=\color{myblue!5},
	showspaces 			= False,
	showstringspaces= false,
	showtabs				= False,
	alsodigit				=	{.:;},
	numbers					= left,
	stepnumber			= 5,
	firstnumber			= 1,
	numberfirstline = true,
	frame						= lines,
	columns					= fullflexible
	}
Les scripts qui suivent sont en réalité consolidés en un seul fichier, ils ne pourraient être autonomes, mais la présentation suivante les distingue selon les étapes décrites dans le rapport de stage.
\begin{table}
\begin{tabular}{|l|p{9cm}|}
\hline
\large{Commande} & \large{Description} \\ \hline
\$nnn & Déclaration d'une variable nnn \\ \hline
mysqli\_query(\$CON, \$R1) & Envoi d'une requête SQL R1, pour interroger la base définie par les paramètres de connexion \$CON\\ \hline
\$row=mysqli\_fetch\_array(\$R1) & \$row est un curseur qui est souvent ou index, souvent associé avec un while, c'est à dire tant qu'il y a des lignes dans le tableau issu de  \$R1, execution de la commande qui suit {...}\\ \hline
echo (...) & Impression d'une valeur, texte prédifini ou résultant d'une variable. La pluspart permettent de voir s'il y a des erreurs et sont associés dans des boucles conditionnelles.\\ \hline
\$a++ ou \$a-- & Permet d'incrémenter / décrementer une variable \$a, notamment dans les boulces while.\\ \hline
\end{tabular}
\caption{Note de lecture concernant les principales commandes php utilisées dans le traitement des données}
\end{table}
\newpage
\section{Mise en place}
\begin{lstlisting}[caption = Parametrage de la page html pour faire des sorties test sur les étapes de création,  language = HTML]
<html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//FR"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<head>
	<title>
		OBJET : DESAGRAGATION PRE-PROJECTION
	</title>
	<style>
		body{ background-color: pink;}
	</style>

</head>
<body>
	<style>
		body{ background-color: #93B874;}
	</style>
\end{lstlisting}
\lstset{
  language        = php,
  basicstyle      = \tiny,
  keywordstyle    = \color{dkblue},
  identifierstyle = \color{dkgreen},
  commentstyle    = \color{gray},
  emph            =[1]{php},
  emphstyle       =[1]\color{black},
  emph            =[2]{if,and,or,else},
  emphstyle       =[2]\color{dkyellow},
	showspaces 			= false,
	}
\section{Etape n\textsuperscript{o}1 : Création des bases}
\begin{lstlisting}[caption = Création des bases et architecture des données, language = php]
<?php 
#0 INIT.
ini_set('memory_limit', '10000M');
ini_set('max_execution_time', '4000');	
header('Content-type: text/html; charset=iso-8859-1');
echo 'OBJET : DeSAGRAGATION PRE-PROJECTION <br/> INDIVIDU < MENAGE < LOGEMENT < comMUNE < CANTVILLE';

#1 CONNEXION
echo '<br/><br/>CONNEXION';
##1.0 Identifiants
$hostname = "localhost";
$username = "root";
$password = "";
$con = mysqli_connect($hostname, $username, $password, 'rc2013')or die(mysqli_error());

if (mysqli_connect_errno()) {
printf("Échec de la connexion : %s\n", mysqli_connect_error());
exit();
	}
else echo ("<br/>Connexion ok<br/>");

##1.1 Choix de la base de données
$db = "rc2013";
mysqli_SELECT_db($con, $db); 
	
#2 BASE DE TRAVAIL : individus / rc2013.menages / LOGEMENTS 
echo ' <br/> <br/>BASE DE TRAVAIL<br/>';
##2.0 Creation base Espace x Temps : OUI/NON
$AAAA="2013";
$ZONE="c";
$DEPT="35";
		
$creerBaseLogtMen=true;
#	$creerBaseLogtMen=false;
		
if ($creerBaseLogtMen)	
{	##2.1 Duplicata, sous-pop.
	$SQL_2_100 ="	DROP TABLE IF EXISTS rc2013.global_2013;";
	mysqli_query($con,$SQL_2_100)or die("Error in query : SQL_2_100. ".mysqli_error($con));	
	$SQL_2_101 ="	CREATE TABLE rc2013.global_2013 LIKE rc2013.fd_logemtzc_2013;";
	mysqli_query($con,$SQL_2_101)or die("Error in query : SQL_2_101. ".mysqli_error($con));	
	$SQL_2_102 ="	INSERT INTO rc2013.global_2013 SELECT * FROM rc2013.fd_logemtzc_2013 WHERE com like '$DEPT%'; ";
	mysqli_query($con,$SQL_2_102)or die("Error in query :  SQL_2_102. ".mysqli_error($con));	
			
	##2.3	Separation base logements & rc2013.menages
	### Localisation unique : recompostition code IRIS 
	$SQL_2_300 ="	ALTER TABLE rc2013.global_2013 ADD IRIS_2013 varchar(9); ";
	mysqli_query($con,$SQL_2_300)or die("Error in query :  SQL_2_300. ".mysqli_error($con));
	$SQL_2_301 ="	UPDATE rc2013.global_2013 SET IRIS = CONCAT(com ,'0000') WHERE IRIS = 'ZZZZZZZZZ';";
	mysqli_query($con,$SQL_2_301)or die("Error in query :  SQL_2_301. ".mysqli_error($con));
			
	###	Création tables
	####	Logements
	$SQL_2_305 ="	DROP TABLE IF EXISTS rc2013.logements;";
	mysqli_query($con,$SQL_2_305)or die("Error in query :  SQL_2_305. ".mysqli_error($con));
	$SQL_2_306 ="	CREATE TABLE rc2013.logements (id bigint(20) NOT NULL, IRIS_2013 varchar(9),CATL_2013 varchar(2),ACHL 	varchar(3),ASCEN varchar(2),BAIN varchar(2),BATI varchar(2),CHAU varchar(2),CHFL varchar(2),CHOS varchar(2),CLIM varchar(2),CMBL varchar(2),CUIS varchar(2),EAU varchar(2),EGOUL varchar(2),ELEC varchar(2), GARL varchar(2),HLML varchar(2),IPONDL varchar(20),NBPI varchar(2),SANI varchar(2),STOCD varchar(2),SURF varchar(2),TYPC varchar(2),TYPL varchar(2),WC varchar(2),IPONDLPT float, id_log varchar(8))";
		mysqli_query($con,$SQL_2_306)or die("Error in query :  SQL_2_306. ".mysqli_error($con));
		$SQL_2_307 ="	ALTER TABLE RC2013.logements ADD PRIMARY KEY (`id`), ADD KEY `id_log` (`id_log`);";
		mysqli_query($con,$SQL_2_307)or die("Error in query :  SQL_2_307. ".mysqli_error($con));
		$SQL_2_308 ="	ALTER TABLE rc2013.logements MODIFY `id` bigint(20) NOT NULL AUTO_INCREMENT;";
		mysqli_query($con,$SQL_2_308)or die("Error in query :  SQL_2_308. ".mysqli_error($con));
		echo "Data frame de Table logements créé </br>";

	####	Menages
	$SQL_2_309 ="	DROP TABLE IF EXISTS rc2013.menages;";
	mysqli_query($con,$SQL_2_309)or die("Error in query :  SQL_2_309. ".mysqli_error($con));
	$SQL_2_310 ="	CREATE TABLE rc2013.menages(id bigint(20) NOT NULL, IRIS_2013 varchar(9), AEMM int,AEMMR varchar(2),agemen8 varchar(2),ANEM varchar(3),ANEMR varchar(2),CATLM varchar(2),DEROU varchar(2),DIPLM_15 varchar(2),EMPLM varchar(2),HLML varchar(2),ILETUDM varchar(2),ILTM varchar(2),IMMIM varchar(2),INAIM varchar(2),INEEM varchar(2),inp11M varchar(2),inp16M varchar(2),inp18M varchar(2),inp19M varchar(2),inp24M varchar(2),inp3M varchar(2),inp60M varchar(2),inp65M varchar(2),inp6M varchar(2),inp75M varchar(2),inpAM varchar(2),inper varchar(2),inper1 varchar(2),inper2 varchar(2),inpOM varchar(2),inpSM varchar(2),IPONDL varchar(20),IRANM varchar(2), RECHM varchar(2),SEXEM varchar(2),STAT_CONJM varchar(2),TACTM varchar(2),TPM varchar(2),TRANSM varchar(2),VOIT varchar(2),IPONDLPT float, id_men varchar(8), trm int default null, M1 int default null, P1 int default null, binf int default null, bmax int default null, trm2 int default null, tactm2 varchar(4) default null );";
	mysqli_query($con,$SQL_2_310)or die("Error in query :  SQL_2_310. ".mysqli_error($con));
	$SQL_2_311 ="	ALTER TABLE rc2013.menages ADD PRIMARY KEY (`id`)  , ADD KEY `id_men` (`id_men`)";
	mysqli_query($con,$SQL_2_311)or die("Error in query :  SQL_2_311. ".mysqli_error($con));
	$SQL_2_312 ="	ALTER TABLE rc2013.menages MODIFY `id` bigint(20) NOT NULL AUTO_INCREMENT;";
	mysqli_query($con,$SQL_2_312)or die("Error in query :  SQL_2_312. ".mysqli_error($con));
	echo "Data frame de Table rc2013.menages créée </br> </br>";
	### INSERT data 
	#### logements
	$SQL_2_313 ="	INSERT INTO rc2013.logements (IRIS_2013,CATL_2013,ACHL,ASCEN,BAIN,BATI,CHAU,CHFL,CHOS,CLIM,CMBL,CUIS,EAU,EGOUL,ELEC,GARL,HLML,NBPI,SANI,STOCD,SURF,TYPC,TYPL,WC,IPONDL,IPONDLPT,id_log)  SELECT IRIS, CATL, ACHL,ASCEN,BAIN,BATI,CHAU,CHFL,CHOS,CLIM,CMBL,CUIS,EAU,EGOUL, ELEC,GARL,HLML,NBPI,SANI,STOCD,SURF,TYPC,TYPL,WC,IPONDL, IPONDL, id FROM rc2013.global_2013;";
	mysqli_query($con,$SQL_2_313)or die("Error in query :  SQL_2_313. ".mysqli_error($con));
	echo "Table logements rechargée </br>";
	#### rc2013.menages
	$SQL_2_314 ="	INSERT INTO rc2013.menages (IRIS_2013, AEMM ,AEMMR , agemen8, ANEM , ANEMR, CATLM , DEROU, DIPLM_15,EMPLM , HLML , ILETUDM, ILTM ,IMMIM, INAIM, INEEM , inp11M , inp16M , inp18M , inp19M , inp24M, inp3M, inp60M, inp65M , inp6M , inp75M , inpAM , inper, inper1, inper2, inpOM, inpSM, IPONDL, IRANM, RECHM, SEXEM, STAT_CONJM, TACTM, TPM, TRANSM , VOIT, IPONDLPT , id_men ) SELECT IRIS, AEMM ,AEMMR , agemen8, ANEM , ANEMR, CATL , DEROU, DIPLM_15, EMPLM , HLML , ILETUDM, ILTM , IMMIM, INAIM, INEEM , inp11M,inp16M , inp18M , inp19M , inp24M, inp3M, inp60M, inp65M , inp6M , inp75M , inpAM , inper, inper1, inper2, inpOM, inpSM, IPONDL, IRANM, RECHM, SEXEM,STAT_CONJM, TACTM, TPM, TRANSM , VOIT, IPONDLPT , Id FROM rc2013.global_2013";	
	mysqli_query($con,$SQL_2_314)or die("Error in query :  SQL_2_314 ".mysqli_error($con));
	echo "Table menages rechargée </br>";}
		
else {echo"Votre base était deja creee</br>";};

	##2.3  ECLATEMENT DES MENAGES EN INDIVIDUS
	echo "</br>ECLATEMENT DES MENAGES EN INDIVIDUS</br>";	
	##2.2	individus : Data frame vierge
	$SQL_2_200="DROP TABLE IF EXISTS rc2013.individus";
	mysqli_query($con,$SQL_2_200)or die("Error in query :  SQL_2_200. ".mysql_error($con));	
	$SQL_2_201 ="	CREATE TABLE rc2013.individus(id bigint(20) NOT NULL, NUMMI varchar(11), AEMM varchar(6), AGED varchar(4), ager20 varchar(3),AGEREV int, AGEREVQ varchar(2),ANAI int,APAF varchar(2),ARM varchar(2),COUPLE varchar(2),CS1 varchar(2),DEROU varchar(2),DIPL_15 varchar(2),DNAI varchar(2),EMPL varchar(2),ETUD varchar(1),ILETUD varchar(2),ILT varchar(2), IMMI varchar(2),INAI varchar(2),INATC varchar(2),INFAM varchar(2),IPONDI float,IRAN  varchar(2),LIENF varchar(2),LPRF varchar(2),LPRM varchar(2),MOCO varchar(2),MODV varchar(2),NA17 varchar(2),NA5 varchar(2),NAIDT varchar(2),ORIDT varchar(2), RECH varchar(2),SEXE varchar(1), SFM varchar(2),STAT_CONJ varchar(2),STATR varchar(2),TACT varchar(2),TACTD16 varchar(3),TP varchar(2),TRANS varchar(2), indic_inp int, rang int(2) default null);";
	mysqli_query($con,$SQL_2_201)or die("Error in query :  SQL_2_201. ".mysql_error($con));
	$SQL_2_202 ="	ALTER TABLE RC2013.individus ADD PRIMARY KEY (`id`), ADD KEY `NUMMI` (`NUMMI`); ";
	mysqli_query($con,$SQL_2_202)or die("Error in query :  SQL_2_202. ".mysql_error($con));
	$SQL_2_203 ="	ALTER TABLE rc2013.individus MODIFY `id` bigint(20) NOT NULL AUTO_INCREMENT;";
	mysqli_query($con,$SQL_2_203)or die("Error in query :  SQL_2_203. ".mysql_error($con));
	echo 'Data frame de la table individus crée </br>'; $
\end{lstlisting}
\section{Etape n\textsuperscript{o}2 : Dislocation}
\begin{lstlisting}[caption = Script php permettant de créer la nouvelle base intégrant individus et ménages par déduction du fichier ménage, language = php]
#3	INPUTATION DIRECTE ( DEPUIS FICHIER MENAGE)
#	AGE
## 	Prepration de PRM dans table ménages
### BORNES NUMERIQUES DE agemen8 POUR PRM
//	
$SQL_PREP_AGE_PRM_01 ="	UPDATE rc2013.menages SET M1 = 00 WHERE agemen8 = '00';";
$SQL_PREP_AGE_PRM_02="	UPDATE rc2013.menages SET M1 = 15 WHERE agemen8 = '15';";
$SQL_PREP_AGE_PRM_03="	UPDATE rc2013.menages SET M1 = 20 WHERE agemen8 = '20';";
$SQL_PREP_AGE_PRM_04="	UPDATE rc2013.menages SET M1 = 25 WHERE agemen8 = '25';";
$SQL_PREP_AGE_PRM_05="	UPDATE rc2013.menages SET M1 = 40 WHERE agemen8 = '40';";
$SQL_PREP_AGE_PRM_06="	UPDATE rc2013.menages SET M1 = 55 WHERE agemen8 = '55';";
$SQL_PREP_AGE_PRM_07="	UPDATE rc2013.menages SET M1 = 65 WHERE agemen8 = '65';";
$SQL_PREP_AGE_PRM_08="	UPDATE rc2013.menages SET M1 = 80 WHERE agemen8 = '80';";
			
$SQL_PREP_AGE_PRM_09 ="	UPDATE rc2013.menages SET P1 = 14 WHERE agemen8 = '00';";
$SQL_PREP_AGE_PRM_10 ="	UPDATE rc2013.menages SET P1 = 19 WHERE agemen8 = '15';";
$SQL_PREP_AGE_PRM_11 ="	UPDATE rc2013.menages SET P1 = 24 WHERE agemen8 = '20';";
$SQL_PREP_AGE_PRM_12 ="	UPDATE rc2013.menages SET P1 = 39 WHERE agemen8 = '25';";
$SQL_PREP_AGE_PRM_13 ="	UPDATE rc2013.menages SET P1 = 54 WHERE agemen8 = '40';";
$SQL_PREP_AGE_PRM_14 ="	UPDATE rc2013.menages SET P1 = 64 WHERE agemen8 = '55';";
$SQL_PREP_AGE_PRM_15 ="	UPDATE rc2013.menages SET P1 = 79 WHERE agemen8 = '65';";
$SQL_PREP_AGE_PRM_16 ="	UPDATE rc2013.menages SET P1 = 99 WHERE agemen8= '80';";
			
mysqli_query($con,$SQL_PREP_AGE_PRM_01)or die("Error in query :  SQL_PREP_AGE_PRM_01. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_02)or die("Error in query :  SQL_PREP_AGE_PRM_02. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_03)or die("Error in query :  SQL_PREP_AGE_PRM_03. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_04)or die("Error in query :  SQL_PREP_AGE_PRM_04. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_05)or die("Error in query :  SQL_PREP_AGE_PRM_05. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_06)or die("Error in query :  SQL_PREP_AGE_PRM_06. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_07)or die("Error in query :  SQL_PREP_AGE_PRM_07. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_08)or die("Error in query :  SQL_PREP_AGE_PRM_08. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_09)or die("Error in query :  SQL_PREP_AGE_PRM_09. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_10)or die("Error in query :  SQL_PREP_AGE_PRM_10. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_11)or die("Error in query :  SQL_PREP_AGE_PRM_11. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_12)or die("Error in query :  SQL_PREP_AGE_PRM_12. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_13)or die("Error in query :  SQL_PREP_AGE_PRM_13. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_14)or die("Error in query :  SQL_PREP_AGE_PRM_14. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_15)or die("Error in query :  SQL_PREP_AGE_PRM_15. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_PRM_16)or die("Error in query :  SQL_PREP_AGE_PRM_16. ".mysql_error($con));
//			
###		TRM : Tranche d'âge la plus significative du chef de ménage, optimisation des bornes inf et max observées a travres agemen 8 et inpm
####	inper = 1, DONC DEDUCTION IMMEDIATE
$SQL_PREP_AGE_inp1_01 ="	UPDATE rc2013.menages SET binf = 100000 WHERE inper = '1';";
$SQL_PREP_AGE_inp1_02 ="	UPDATE rc2013.menages SET binf = 00 WHERE (binf = 100000 AND inp3M ='1');";
$SQL_PREP_AGE_inp1_03 ="	UPDATE rc2013.menages SET binf = 04 WHERE (binf = 100000 AND inp3M ='0'AND inp6M ='1');";
$SQL_PREP_AGE_inp1_04 ="	UPDATE rc2013.menages SET binf = 07 WHERE (binf = 100000 AND inp6M ='0'AND inp11M ='1');";
$SQL_PREP_AGE_inp1_05 ="	UPDATE rc2013.menages SET binf = 12 WHERE (binf = 100000 AND inp11M ='0'AND inp16M ='1');";
$SQL_PREP_AGE_inp1_06 ="	UPDATE rc2013.menages SET binf = 17 WHERE (binf = 100000 AND inp16M ='0'AND inp18M ='1');";
$SQL_PREP_AGE_inp1_07 ="	UPDATE rc2013.menages SET binf = 19 WHERE (binf = 100000 AND inp19M ='1'AND inp24M ='1');";
$SQL_PREP_AGE_inp1_08 ="	UPDATE rc2013.menages SET binf = 25 WHERE (binf = 100000 AND inp19M ='1'AND inp24M ='0'AND inp60M ='0');";
$SQL_PREP_AGE_inp1_09 ="	UPDATE rc2013.menages SET binf = 60 WHERE (binf = 100000 AND inp60M ='1'AND inp65M ='0');";
$SQL_PREP_AGE_inp1_10 ="	UPDATE rc2013.menages SET binf = 65 WHERE (binf = 100000 AND inp65M ='1'AND inp75M ='0');";
$SQL_PREP_AGE_inp1_11 ="	UPDATE rc2013.menages SET binf = 75 WHERE (binf = 100000 AND inp75M ='1');";
			
$SQL_PREP_AGE_inp1_12 ="	UPDATE rc2013.menages SET bmax = 100000 WHERE inper='1';";
$SQL_PREP_AGE_inp1_13 ="	UPDATE rc2013.menages SET bmax = 03 WHERE (bmax = 100000 AND inp3M ='1');";
$SQL_PREP_AGE_inp1_14 ="	UPDATE rc2013.menages SET bmax = 06 WHERE (bmax = 100000 AND inp3M ='0'AND inp6M ='1');";
$SQL_PREP_AGE_inp1_15 ="	UPDATE rc2013.menages SET bmax = 11 WHERE (bmax = 100000 AND inp6M ='0'AND inp11M ='1');";
$SQL_PREP_AGE_inp1_16 ="	UPDATE rc2013.menages SET bmax = 16 WHERE (bmax = 100000 AND inp11M ='0'AND inp16M ='1');";
$SQL_PREP_AGE_inp1_17 ="	UPDATE rc2013.menages SET bmax = 18 WHERE (bmax = 100000 AND inp16M ='0'AND inp18M ='1');";
$SQL_PREP_AGE_inp1_18 ="	UPDATE rc2013.menages SET bmax = 24 WHERE (bmax = 100000 AND inp19M ='1'AND inp24M ='1');";
$SQL_PREP_AGE_inp1_19 ="	UPDATE rc2013.menages SET bmax = 59 WHERE (bmax = 100000 AND inp19M ='1'AND inp24M ='0'AND inp60M ='0');";
$SQL_PREP_AGE_inp1_20 ="	UPDATE rc2013.menages SET bmax = 64 WHERE (bmax = 100000 AND inp60M ='1'AND inp65M ='0');";
$SQL_PREP_AGE_inp1_21 ="	UPDATE rc2013.menages SET bmax = 74 WHERE (bmax = 100000 AND inp65M ='1'AND inp75M ='0');";
$SQL_PREP_AGE_inp1_22 ="	UPDATE rc2013.menages SET bmax = 99 WHERE (bmax = 100000 AND inp75M ='1');";
			
$SQL_PREP_AGE_inp1_23 ="	UPDATE rc2013.menages SET trm = CONCAT(IF(M1<=binf,binf,M1),IF(P1<=bmax,P1,bmax)) WHERE inper='1';";
			
mysqli_query($con,$SQL_PREP_AGE_inp1_01)or die("Error in query :  SQL_PREP_AGE_inp1_01. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_02)or die("Error in query :  SQL_PREP_AGE_inp1_02. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_03)or die("Error in query :  SQL_PREP_AGE_inp1_03. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_04)or die("Error in query :  SQL_PREP_AGE_inp1_04. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_05)or die("Error in query :  SQL_PREP_AGE_inp1_05. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_06)or die("Error in query :  SQL_PREP_AGE_inp1_06. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_07)or die("Error in query :  SQL_PREP_AGE_inp1_07. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_08)or die("Error in query :  SQL_PREP_AGE_inp1_08. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_09)or die("Error in query :  SQL_PREP_AGE_inp1_09. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_10)or die("Error in query :  SQL_PREP_AGE_inp1_10. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_11)or die("Error in query :  SQL_PREP_AGE_inp1_11. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_12)or die("Error in query :  SQL_PREP_AGE_inp1_12. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_13)or die("Error in query :  SQL_PREP_AGE_inp1_13. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_14)or die("Error in query :  SQL_PREP_AGE_inp1_14. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_15)or die("Error in query :  SQL_PREP_AGE_inp1_15. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_16)or die("Error in query :  SQL_PREP_AGE_inp1_16. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_17)or die("Error in query :  SQL_PREP_AGE_inp1_17. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_18)or die("Error in query :  SQL_PREP_AGE_inp1_18. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_19)or die("Error in query :  SQL_PREP_AGE_inp1_19. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_20)or die("Error in query :  SQL_PREP_AGE_inp1_20. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_21)or die("Error in query :  SQL_PREP_AGE_inp1_21. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_22)or die("Error in query :  SQL_PREP_AGE_inp1_22. ".mysql_error($con));
mysqli_query($con,$SQL_PREP_AGE_inp1_23)or die("Error in query :  SQL_PREP_AGE_inp1_23. ".mysql_error($con));
		
###	inper = 2, DIVISION DES CAS POSSIBLES
####	CLASSE D'AGE SUR inp DES DEUX INDVIDUS IDENTIQUES : 2 002
##### 	RANG 2	(NON PRM)
$SQL_PREP_AGE_inp2B_01 ="	UPDATE rc2013.menages SET trm2 = 2002 WHERE inper = '2';";
$SQL_PREP_AGE_inp2B_02 ="	UPDATE rc2013.menages SET trm2 = 0003 WHERE trm2 = 2002 AND inp3M = '2';";
$SQL_PREP_AGE_inp2B_03 ="	UPDATE rc2013.menages SET trm2 = 0406 WHERE trm2 = 2002 AND inp6M = '2'AND inp3M ='0';";
$SQL_PREP_AGE_inp2B_04 ="	UPDATE rc2013.menages SET trm2 = 0711 WHERE trm2 = 2002 AND inp11M = '2'AND inp16M ='0';";
$SQL_PREP_AGE_inp2B_05 ="	UPDATE rc2013.menages SET trm2 = 1216 WHERE trm2 = 2002 AND inp16M = '2'AND inp11M ='0';";
$SQL_PREP_AGE_inp2B_06 ="	UPDATE rc2013.menages SET trm2 = 1718 WHERE trm2 = 2002 AND inp18M = '2'AND inp16M ='0';";
$SQL_PREP_AGE_inp2B_07 ="	UPDATE rc2013.menages SET trm2 = 1924 WHERE trm2 = 2002 AND inp24M = '2' AND inp19M ='2' AND inp18M ='0';";
$SQL_PREP_AGE_inp2B_08 ="	UPDATE rc2013.menages SET trm2 = 2559 WHERE trm2 = 2002 AND inp19M = '2' AND inp24M ='0'AND inp60M ='0';";
$SQL_PREP_AGE_inp2B_09 ="	UPDATE rc2013.menages SET trm2 = 6064 WHERE trm2 = 2002 AND inp60M = '1'AND inp65M ='0';";
$SQL_PREP_AGE_inp2B_10 ="	UPDATE rc2013.menages SET trm2 = 6574 WHERE trm2 = 2002 AND inp65M = '2'AND inp75M ='0';";
$SQL_PREP_AGE_inp2B_10 ="	UPDATE rc2013.menages SET trm2 = 7599 WHERE trm2 = 2002 AND inp75M = '2';";
			
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_01)or die("Error in query :  SQL_PREP_AGE_inp2B_01".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_02)or die("Error in query :  SQL_PREP_AGE_inp2B_02".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_03)or die("Error in query :  SQL_PREP_AGE_inp2B_03".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_04)or die("Error in query :  SQL_PREP_AGE_inp2B_04".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_05)or die("Error in query :  SQL_PREP_AGE_inp2B_05".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_06)or die("Error in query :  SQL_PREP_AGE_inp2B_06".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_07)or die("Error in query :  SQL_PREP_AGE_inp2B_07".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_08)or die("Error in query :  SQL_PREP_AGE_inp2B_08".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_09)or die("Error in query :  SQL_PREP_AGE_inp2B_09".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_10)or die("Error in query :  SQL_PREP_AGE_inp2B_10".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2B_11)or die("Error in query :  SQL_PREP_AGE_inp2B_11".mysqli_error($con));
		
#####	RANG 1	(PRM)
$SQL_PREP_AGE_inp2A_01 ="	UPDATE rc2013.menages SET binf = 000 WHERE inper='2';";
$SQL_PREP_AGE_inp2A_02 ="	UPDATE rc2013.menages SET binf = 00 WHERE (binf = 000 AND inp3M ='2');";
$SQL_PREP_AGE_inp2A_03 ="	UPDATE rc2013.menages SET binf = 04 WHERE (binf = 000 AND inp3M ='0'AND inp6M ='2');";
$SQL_PREP_AGE_inp2A_04 ="	UPDATE rc2013.menages SET binf = 07 WHERE (binf = 000 AND inp6M ='0'AND inp11M ='2');";
$SQL_PREP_AGE_inp2A_05 ="	UPDATE rc2013.menages SET binf = 12 WHERE (binf = 000 AND inp11M ='0'AND inp16M ='2');";
$SQL_PREP_AGE_inp2A_06 ="	UPDATE rc2013.menages SET binf = 17 WHERE (binf = 000 AND inp16M ='0'AND inp18M ='2');";
$SQL_PREP_AGE_inp2A_07 ="	UPDATE rc2013.menages SET binf = 19 WHERE (binf = 000 AND inp19M ='2'AND inp24M ='2' AND inp18M ='0');";
$SQL_PREP_AGE_inp2A_08 ="	UPDATE rc2013.menages SET binf = 25 WHERE (binf = 000 AND inp19M ='2'AND inp24M ='0'AND inp60M ='0');";
$SQL_PREP_AGE_inp2A_09 ="	UPDATE rc2013.menages SET binf = 60 WHERE (binf = 000 AND inp60M ='2'AND inp65M ='0');";
$SQL_PREP_AGE_inp2A_10 ="	UPDATE rc2013.menages SET binf = 65 WHERE (binf = 000 AND inp65M ='2'AND inp75M ='0');";
$SQL_PREP_AGE_inp2A_11 ="	UPDATE rc2013.menages SET binf = 75 WHERE (binf = 000 AND inp75M ='2');";
			
$SQL_PREP_AGE_inp2A_12 ="	UPDATE rc2013.menages SET bmax = 000 WHERE inper ='2';";
$SQL_PREP_AGE_inp2A_13 ="	UPDATE rc2013.menages SET bmax = 03 WHERE (bmax = 000 AND inp3M ='2');";
$SQL_PREP_AGE_inp2A_14 ="	UPDATE rc2013.menages SET bmax = 06 WHERE (bmax = 000 AND inp3M ='0'AND inp6M ='2');";
$SQL_PREP_AGE_inp2A_15 ="	UPDATE rc2013.menages SET bmax = 11 WHERE (bmax = 000 AND inp6M ='0'AND inp11M ='2');";
$SQL_PREP_AGE_inp2A_16 ="	UPDATE rc2013.menages SET bmax = 16 WHERE (bmax = 000 AND inp11M ='0'AND inp16M ='2');";
$SQL_PREP_AGE_inp2A_17 ="	UPDATE rc2013.menages SET bmax = 18 WHERE (bmax = 000 AND inp16M ='0'AND inp18M ='2');";
$SQL_PREP_AGE_inp2A_18 ="	UPDATE rc2013.menages SET bmax = 24 WHERE (bmax = 000 AND inp19M ='2'AND inp24M ='2' AND inp18M ='0');";
$SQL_PREP_AGE_inp2A_19 ="	UPDATE rc2013.menages SET bmax = 59 WHERE (bmax = 000 AND inp19M ='2'AND inp24M ='0'AND inp60M ='0');";
$SQL_PREP_AGE_inp2A_20 ="	UPDATE rc2013.menages SET bmax = 64 WHERE (bmax = 000 AND inp60M ='2'AND inp65M ='0');";
$SQL_PREP_AGE_inp2A_21 ="	UPDATE rc2013.menages SET bmax = 74 WHERE (bmax = 000 AND inp65M ='2'AND inp75M ='0');";
$SQL_PREP_AGE_inp2A_22 ="	UPDATE rc2013.menages SET bmax = 99 WHERE (bmax = 000 AND inp75M ='2');";			

$SQL_PREP_AGE_inp2A_23 ="	UPDATE rc2013.menages SET trm = CONCAT(IF(M1<=binf,binf,M1),IF(P1<=bmax,P1,bmax)) WHERE inper='2';";
			
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_01)or die("Error in query :  SQL_PREP_AGE_inp2A_01".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_02)or die("Error in query :  SQL_PREP_AGE_inp2A_02".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_03)or die("Error in query :  SQL_PREP_AGE_inp2A_03".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_04)or die("Error in query :  SQL_PREP_AGE_inp2A_04".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_05)or die("Error in query :  SQL_PREP_AGE_inp2A_05".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_06)or die("Error in query :  SQL_PREP_AGE_inp2A_06".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_07)or die("Error in query :  SQL_PREP_AGE_inp2A_07".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_08)or die("Error in query :  SQL_PREP_AGE_inp2A_08".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_09)or die("Error in query :  SQL_PREP_AGE_inp2A_09".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_10)or die("Error in query :  SQL_PREP_AGE_inp2A_10".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_11)or die("Error in query :  SQL_PREP_AGE_inp2A_11".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_12)or die("Error in query :  SQL_PREP_AGE_inp2A_12".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_13)or die("Error in query :  SQL_PREP_AGE_inp2A_13".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_14)or die("Error in query :  SQL_PREP_AGE_inp2A_14".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_15)or die("Error in query :  SQL_PREP_AGE_inp2A_15".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_16)or die("Error in query :  SQL_PREP_AGE_inp2A_16".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_17)or die("Error in query :  SQL_PREP_AGE_inp2A_17".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_18)or die("Error in query :  SQL_PREP_AGE_inp2A_18".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_19)or die("Error in query :  SQL_PREP_AGE_inp2A_19".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_20)or die("Error in query :  SQL_PREP_AGE_inp2A_20".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_21)or die("Error in query :  SQL_PREP_AGE_inp2A_21".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_22)or die("Error in query :  SQL_PREP_AGE_inp2A_22".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2A_23)or die("Error in query :  SQL_PREP_AGE_inp2A_23".mysqli_error($con));	
		
####	UN ADULTE(19 ou +), UN ENFANT(18 ou -) : CAS 202
##### 	MISE A JOUR DE L'AGE DE L'ENFANT RANG 2
$SQL_PREP_AGE_inp202B_01 ="	UPDATE menages SET trm2 = 202 WHERE inper='2' AND inp19M ='1';";
$SQL_PREP_AGE_inp202B_02 ="	UPDATE rc2013.menages SET trm2 = 0003 WHERE trm2 = 202 AND inp3M ='1';";
$SQL_PREP_AGE_inp202B_03 ="	UPDATE rc2013.menages SET trm2 = 0406 WHERE trm2 = 202 AND inp6M ='1'AND inp3M ='0';";
$SQL_PREP_AGE_inp202B_04 ="	UPDATE rc2013.menages SET trm2 = 0711 WHERE trm2 = 202 AND inp11M ='1'AND inp16M ='0';";
$SQL_PREP_AGE_inp202B_05 ="	UPDATE rc2013.menages SET trm2 = 1216 WHERE trm2 = 202 AND inp16M ='1'AND inp11M ='0';";
$SQL_PREP_AGE_inp202B_06 ="	UPDATE rc2013.menages SET trm2 = 1718 WHERE trm2 = 202 AND inp18M ='1'AND inp16M ='0';";
			
mysqli_multi_query($con,$SQL_PREP_AGE_inp202B_01)or die("Error in query :  SQL_PREP_AGE_inp202B_01".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202B_02)or die("Error in query :  SQL_PREP_AGE_inp202B_02".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202B_03)or die("Error in query :  SQL_PREP_AGE_inp202B_03".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202B_04)or die("Error in query :  SQL_PREP_AGE_inp202B_04".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202B_05)or die("Error in query :  SQL_PREP_AGE_inp202B_05".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202B_06)or die("Error in query :  SQL_PREP_AGE_inp202B_06".mysqli_error($con));
		
##### 	MISE A JOUR DE L'AGE DE L'ADULTE RANG 1
$SQL_PREP_AGE_inp202A_01 ="	UPDATE rc2013.menages SET binf = 88 WHERE inper ='2' AND inp19M ='1';";
$SQL_PREP_AGE_inp202A_02 ="	UPDATE rc2013.menages SET binf = 19 WHERE (binf = 88 AND inp24M ='2');";
$SQL_PREP_AGE_inp202A_03 ="	UPDATE rc2013.menages SET binf = 25 WHERE (binf = 88 AND inp24M ='1'AND inp60M ='0');";
$SQL_PREP_AGE_inp202A_04 ="	UPDATE rc2013.menages SET binf = 60 WHERE (binf = 88 AND inp60M ='1'AND inp65M ='0');";
$SQL_PREP_AGE_inp202A_05 ="	UPDATE rc2013.menages SET binf = 65 WHERE (binf = 88 AND inp65M ='1'AND inp75M ='0');";
$SQL_PREP_AGE_inp202A_06 ="	UPDATE rc2013.menages SET binf = 75 WHERE (binf = 88 AND inp75M ='1');";
			
$SQL_PREP_AGE_inp202A_07 ="	UPDATE rc2013.menages SET bmax = 88 WHERE inper ='2' AND inp19M = '1';";
$SQL_PREP_AGE_inp202A_08 ="	UPDATE rc2013.menages SET bmax = 24 WHERE (bmax = 88 AND inp24M ='2');";
$SQL_PREP_AGE_inp202A_09 ="	UPDATE rc2013.menages SET bmax = 59 WHERE (bmax = 88 AND inp24M ='1'AND inp60M ='0');";
$SQL_PREP_AGE_inp202A_10 ="	UPDATE rc2013.menages SET bmax = 64 WHERE (bmax = 88 AND inp60M ='1'AND inp65M ='0');";
$SQL_PREP_AGE_inp202A_11 ="	UPDATE rc2013.menages SET bmax = 74 WHERE (bmax = 88 AND inp65M ='1'AND inp75M ='0');";
$SQL_PREP_AGE_inp202A_12 ="	UPDATE rc2013.menages SET bmax = 99 WHERE (bmax = 88 AND inp75M ='1');";
			
$SQL_PREP_AGE_inp202A_13 ="	UPDATE rc2013.menages SET trm = CONCAT(IF(M1<=binf,binf,M1),IF(P1<=bmax,P1,bmax)) WHERE inper='2';";
			
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_01)or die("Error in query :  SQL_PREP_AGE_inp202A_01".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_02)or die("Error in query :  SQL_PREP_AGE_inp202A_02".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_03)or die("Error in query :  SQL_PREP_AGE_inp202A_03".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_04)or die("Error in query :  SQL_PREP_AGE_inp202A_04".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_05)or die("Error in query :  SQL_PREP_AGE_inp202A_05".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_06)or die("Error in query :  SQL_PREP_AGE_inp202A_06".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_07)or die("Error in query :  SQL_PREP_AGE_inp202A_07".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_08)or die("Error in query :  SQL_PREP_AGE_inp202A_08".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_09)or die("Error in query :  SQL_PREP_AGE_inp202A_09".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_10)or die("Error in query :  SQL_PREP_AGE_inp202A_10".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_11)or die("Error in query :  SQL_PREP_AGE_inp202A_11".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_12)or die("Error in query :  SQL_PREP_AGE_inp202A_12".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp202A_13)or die("Error in query :  SQL_PREP_AGE_inp202A_13".mysqli_error($con));
		
####	DEUX ENFANTS : CAS 2003 = CASE 2002 + inp24M=2
#####	MISE A JOUR DE L'AGE DE L'ENFANT RANG 2 (LE PLUS JEUNE)
$SQL_PREP_AGE_inp2003B_01 ="	UPDATE rc2013.menages SET trm2 = 2003 WHERE trm2 = 2002 AND inp24M = 2;";
$SQL_PREP_AGE_inp2003B_02 ="	UPDATE rc2013.menages SET trm2 = 1718 WHERE trm2 = 2003 AND inp18M = 1 AND inp16M = 0;";
$SQL_PREP_AGE_inp2003B_03 ="	UPDATE rc2013.menages SET trm2 = 1216 WHERE trm2 = 2003 AND inp16M = 1 AND inp11M = 0;";
$SQL_PREP_AGE_inp2003B_04 ="	UPDATE rc2013.menages SET trm2 = 0711 WHERE trm2 = 2003 AND inp11M = 1 AND inp6M = 0;";
$SQL_PREP_AGE_inp2003B_05 ="	UPDATE rc2013.menages SET trm2 = 0406 WHERE trm2 = 2003 AND inp6M = 1  AND inp3M = 0;";
$SQL_PREP_AGE_inp2003B_06 ="	UPDATE rc2013.menages SET trm2 = 0003 WHERE trm2 = 2003 AND inp3M = 1;";
			
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003B_01)or die("Error in query :  SQL_PREP_AGE_inp2003B_01".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003B_02)or die("Error in query :  SQL_PREP_AGE_inp2003B_02".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003B_03)or die("Error in query :  SQL_PREP_AGE_inp2003B_03".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003B_04)or die("Error in query :  SQL_PREP_AGE_inp2003B_04".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003B_05)or die("Error in query :  SQL_PREP_AGE_inp2003B_05".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003B_06)or die("Error in query :  SQL_PREP_AGE_inp2003B_06".mysqli_error($con));
		
#####	MISE A JOUR DE L'AGE DE L'ENFANT RANG 1 (LE PLUS AGE)
$SQL_PREP_AGE_inp2003A_01 ="	UPDATE rc2013.menages SET binf = 77 WHERE inper ='2' AND inp24M ='2'AND binf=000;";
$SQL_PREP_AGE_inp2003A_02 ="	UPDATE rc2013.menages SET binf = 19 WHERE (binf = 77 AND inp24M ='2'AND inp18M =1);";
$SQL_PREP_AGE_inp2003A_03 ="	UPDATE rc2013.menages SET binf = 17 WHERE (binf = 77 AND inp18M ='2'AND inp16M ='1');";
$SQL_PREP_AGE_inp2003A_04 ="	UPDATE rc2013.menages SET binf = 12 WHERE (binf = 77 AND inp16M ='2'AND inp11M ='1');";
$SQL_PREP_AGE_inp2003A_05 ="	UPDATE rc2013.menages SET binf = 07 WHERE (binf = 77 AND inp11M ='2'AND inp6M ='1');";
$SQL_PREP_AGE_inp2003A_06 ="	UPDATE rc2013.menages SET binf = 04 WHERE (binf = 77 AND inp6M ='2' AND inp3M ='1');";
			
$SQL_PREP_AGE_inp2003A_07 ="	UPDATE rc2013.menages SET bmax = 77 WHERE inper ='2' AND inp24M ='2' AND bmax=000;";
$SQL_PREP_AGE_inp2003A_08 ="	UPDATE rc2013.menages SET bmax = 24 WHERE (bmax = 77 AND inp24M ='2'AND inp18M =1);";
$SQL_PREP_AGE_inp2003A_09 ="	UPDATE rc2013.menages SET bmax = 18 WHERE (bmax = 77 AND inp18M ='2'AND inp16M ='1');" ;
$SQL_PREP_AGE_inp2003A_10 ="	UPDATE rc2013.menages SET bmax = 16 WHERE (bmax = 77 AND inp16M ='2'AND inp11M ='1');";
$SQL_PREP_AGE_inp2003A_11 ="	UPDATE rc2013.menages SET bmax = 11 WHERE (bmax = 77 AND inp11M ='2'AND inp6M ='1');";
$SQL_PREP_AGE_inp2003A_12 ="	UPDATE rc2013.menages SET bmax = 06 WHERE (bmax = 77 AND inp6M ='2' AND inp3M ='1');";
			
$SQL_PREP_AGE_inp2003A_13 ="	UPDATE rc2013.menages SET trm = CONCAT(IF(M1<=binf,binf,M1),IF(P1<=bmax,P1,bmax)) WHERE inper='2';";
			
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_01)or die("Error in query : SQL_PREP_AGE_inp2003A_01".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_02)or die("Error in query : SQL_PREP_AGE_inp2003A_02".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_03)or die("Error in query : SQL_PREP_AGE_inp2003A_03".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_04)or die("Error in query : SQL_PREP_AGE_inp2003A_04".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_05)or die("Error in query : SQL_PREP_AGE_inp2003A_05".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_06)or die("Error in query : SQL_PREP_AGE_inp2003A_06".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_07)or die("Error in query : SQL_PREP_AGE_inp2003A_07".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_08)or die("Error in query : SQL_PREP_AGE_inp2003A_08".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_09)or die("Error in query : SQL_PREP_AGE_inp2003A_09".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_10)or die("Error in query : SQL_PREP_AGE_inp2003A_10".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_11)or die("Error in query : SQL_PREP_AGE_inp2003A_11".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_12)or die("Error in query : SQL_PREP_AGE_inp2003A_12".mysqli_error($con));
mysqli_multi_query($con,$SQL_PREP_AGE_inp2003A_13)or die("Error in query : SQL_PREP_AGE_inp2003A_13".mysqli_error($con));	
		
//	#### 	DEUX ADULTES AGES DIFFERENTS : LITIGE
// #TRM dans menages > 2
$SCL_AU_011=" SELECT code_iris FROM localisation WHERE au2010 = 011;";
$EXE_AU_011=mysqli_query($con,$SCL_AU_011)  or die(mysqli_error($con)."_SCL_AU_011");
if(!$EXE_AU_011){echo "Problème selection des iris de AU 011";}
else
	{while ($row=mysqli_fetch_array($EXE_AU_011)){
		$IRIS13 = $row["code_iris"];
		$SLC_ENf="SELECT id_men FROM `menages` WHERE inper > 1 AND iris_2013  LIKE '35281%'";
		$EXE_SLC_ENF=mysqli_query($con,$SLC_ENf)  or die(mysqli_error($con)."SLC_EN");
		if(!$EXE_SLC_ENF)	{echo "lose";}

	else{
	while ($row=mysqli_fetch_array($EXE_SLC_ENF))
	{$ID=$row["id_men"];		
	 $aia="SELECT inp3M,inp6M, inp11M, inp16M, inp18M, inp19M, inp24M, inpER FROM menages WHERE id_men='$ID'  ";
	 $EXE_SLC_aia=mysqli_query($con,$aia)  or die(mysqli_error($con)."_aia");
	 if (!$EXE_SLC_aia){ echo "Loooooooooseur";}
		else{
		while($row=mysqli_fetch_array($EXE_SLC_aia))
		{$inper =$row["inpER"];
		 $i = $row["inpER"];
		 $inp3m  = $row["inp3M"];
		 $inp6m  = $row["inp6M"];
		 $inp11m = $row["inp11M"];
		 $inp16m = $row["inp16M"];
		 $inp18m = $row["inp18M"];
		 $inp19m = $row["inp19M"];
		 $inp24m = $row["inp24M"];
		 echo $ID."_$inper</br>";
			if($inp18m > 0) 
				{$r = ($inper - $inp18m + 1); 
				$j = $r -1;}
			else 
				{$r = 0; 
				$j =$inper;}// $rang du dernier adulte// Rang du premier enfant
				#echo "_".$ID."_.$inper.</br>"; // ____NBENF_$inp24m</br>R_ADULTEMAX_$j.</br>R_ENFANTmin $r</br>";
							
			 if($inp18m > 0)
				{
				while($i >= $r AND $i > 1 ){
				$a = $inp18m - ($i-$inp19m)  ; // rang fraterie
				#echo "R$i.__a_".$a;"</br>"; 
				$b = $a + 1 ; // rang + 1
				#echo "__b_".$b."</br>";
								
				$aa=" UPDATE menages SET trm$i = '0003' WHERE  id_men = '$ID' AND inp3m >= $b ";
				mysqli_query($con,$aa)  or die(mysqli_error($con)."_ZZZZa");
								
				$bb=" UPDATE menages SET trm$i = '0406' WHERE  id_men = '$ID' AND inp3m <= $a AND inp6m >= $b ";
				mysqli_query($con,$bb)  or die(mysqli_error($con)."_ZZZZb");
								
				$cc=" UPDATE menages SET trm$i = '0711' WHERE  id_men = '$ID' AND inp6m <= $a AND inp11m >= $b ";
				mysqli_query($con,$cc)  or die(mysqli_error($con)."_ZZZZc");
								
				$dd=" UPDATE menages SET trm$i = '1216' WHERE  id_men = '$ID' AND inp11m <= $a AND inp16m >= $b ";
				mysqli_query($con,$dd)  or die(mysqli_error($con)."_ZZZZd");
								
				$ee=" UPDATE menages SET trm$i = '1718' WHERE  id_men = '$ID' AND inp16m <= $a AND inp18m >= $b ";
				mysqli_query($con,$ee)  or die(mysqli_error($con)."_ZZZZe");
								
				echo "R$i._</br>";
				$i--;}
				}
				if($inp19m > 0)
				{$h =$inp24m - $inp18m;	
				while($j > 1){
					while($h > 0 AND $j > 1){
					$pp ="UPDATE menages SET trm$j= '1924' WHERE id_men = '$ID'";
					mysqli_query($con,$pp)  or die(mysqli_error($con)."_ZZZZm");
					$h--;
					$j--;
					echo "R$j.</br>";}					
					while($j > 1){
					$mm="	UPDATE menages SET trm$j = '2559' WHERE inp19m >= $j AND inp60m < $j AND id_men = '$ID' ";
					mysqli_query($con,$mm)  or die(mysqli_error($con)."_ZZZZo");
							
					$hh="	UPDATE menages SET trm$j = '6064' WHERE inp60m >= $j AND inp65m < $j AND id_men = '$ID' ";
					mysqli_query($con,$hh)  or die(mysqli_error($con)."_ZZZZp");
											
					$ii="	UPDATE menages SET trm$j = '6574' WHERE inp65m >= $j AND inp75m < $j AND id_men = '$ID'";
					mysqli_query($con,$ii)  or die(mysqli_error($con)."_ZZZZq");
											
					$jj="	UPDATE menages SET trm$j = '7599' WHERE inp75m >= $j AND id_men = '$ID' ";
					mysqli_query($con,$jj)  or die(mysqli_error($con)."_ZZZZr");
					$j--;							
					}
				}
				if($j=1){
				$nn="	UPDATE menages SET binf = '25' WHERE inp19m >= $j AND inp60m < $j AND id_men = '$ID' ";
				mysqli_query($con,$nn)  or die(mysqli_error($con)."_ZZZZn");
				$nn2="	UPDATE menages SET bmax = '59' WHERE inp19m >= $j AND inp60m < $j AND id_men = '$ID' ";
				mysqli_query($con,$nn2)  or die(mysqli_error($con)."_ZZZZn");
											
				$oo="	UPDATE menages SET binf = '60' WHERE inp60m >= $j AND inp65m < $j AND id_men = '$ID' ";
				mysqli_query($con,$oo)  or die(mysqli_error($con)."_ZZZZo");
				$oo2="	UPDATE menages SET bmax = '64' WHERE inp60m >= $j AND inp65m < $j AND id_men = '$ID' ";
				mysqli_query($con,$oo2)  or die(mysqli_error($con)."_ZZZZo");
											
				$pp="	UPDATE menages SET binf = '65' WHERE inp65m >= $j AND inp75m < $j AND id_men = '$ID'";
				mysqli_query($con,$pp)  or die(mysqli_error($con)."_ZZZZp");
				$pp2="	UPDATE menages SET bmax= '74' WHERE inp65m >= $j AND inp75m < $j AND id_men = '$ID' ";
				mysqli_query($con,$pp2)  or die(mysqli_error($con)."_ZZZZp");
											
				$qq="	UPDATE menages SET  binf= '75' WHERE inp75m >= $j AND id_men = '$ID' ";
				mysqli_query($con,$qq)  or die(mysqli_error($con)."_ZZZZr");
				$qq2="	UPDATE menages SET  bmax= '99' WHERE inp75m >= $j AND id_men = '$ID' ";
				mysqli_query($con,$qq2)  or die(mysqli_error($con)."_ZZZZr");
				$j--;
				}}}}}}}}
	
$SQL_PREP_AGE_inp1_23="	UPDATE rc2013.menages SET trm = CONCAT(IF(M1<=binf,binf,M1),IF(P1<=bmax,P1,bmax)) ;";
mysqli_query($con,$SQL_PREP_AGE_inp1_23)  or die(mysqli_error($con)."_ZZZZr");
//
#4		PHASE TEST, REMPLISSAGE PARTIEL
//		
$ERASE="TRUNCATE TABLE rc2013.individus"; // Vider la table d'essai
$REQ_ERASE= mysqli_query($con,$ERASE)  or die(mysqli_error($con)." Error in query $ERASE ");
//		
#####	disloc_menage
//	
$SELECT_IRIS="SELECT code_iris, cv FROM localisation WHERE code_iris like '35024%' or code_iris like '35281%'  ;";
$REQ_SELECT_IRIS= mysqli_query($con,$SELECT_IRIS)  or die(mysqli_error($con)." Error in query SELECT_CANT ");
if (!$REQ_SELECT_IRIS)
	{echo "Aucun iris sélectionné"; 
	exit;
	}		
else{
	while($row = mysqli_fetch_array($REQ_SELECT_IRIS)){
	$IRIS13 = $row["code_iris"]; echo"Iris chargé : $IRIS13</br>";
	$SQL211a="SELECT * FROM rc2013.menages WHERE IRIS_2013 = $IRIS13 AND inper < 13";
	$req_exe211a = mysqli_query($con,$SQL211a)  or die(mysqli_error($con)." Error in query SQL211a ");
		if ($req_exe211a){
		 while ($row = mysqli_fetch_array($req_exe211a)){
			$inp 		=		$row["inpER"];
			$ID  		=		$row["id_men"];
			$IRIS 	= 	$row["IRIS_2013"];
			$aged 	= 	$row["trm"];
			$dipl_15= 	$row["DIPLM_15"];
			$empl		= 	$row["EMPLM"];
			$iletud =		$row["ILETUDM"];
			$ilt 		=		$row["ILTM"]; 
			$immi 	=		$row["IMMIM"];
			$inai 	=		$row["INAIM"];
			$iran 	=		$row["IRANM"];
			$rech 	=		$row["RECHM"]; 
			$sexe 	=		$row["SEXEM"];
			$stat_conj =$row["STAT_CONJM"]; 
			$tact 	=		$row["TACTM"]; 
			$trans	=		$row["TRANSM"]; 
			$aemm		=		$row["AEMM"];
							
			$SQL211b="INSERT INTO rc2013.individus (indic_inp, iris_2013, nummi, aged, dipl_15,empl,iletud,ilt,immi,inai,iran, rech, sexe, stat_conj, tact, trans, aemm, rang) VALUES ('".$inp."',	 '".$IRIS."', 	'".$ID."' , '".$aged."'*1,'".$dipl_15."','".$empl."','".$iletud."','".$ilt."','$immi' ,'$inai','$iran','".$rech."','".$sexe."', '".$stat_conj."','".$tact."', '".$trans."','".$aemm."', '1')";
			mysqli_query($con,$SQL211b)  or die(mysqli_error($con)."Error in query SQL211b ");	// Remplissage PRM direct		
			
			$r =$row["inpER"];		
			while($r > 1){
			$trm=$row["trm$r"];
								
			$SQL212b="INSERT INTO rc2013.individus (indic_inp, 	iris_2013, 	nummi, 		aged, 	 rang) VALUES ('".$inp."',	 '".$IRIS."', 	'".$ID."' , '".$trm."', '".$r."')";
			mysqli_query($con,$SQL212b)  or die(mysqli_error($con)."Error in query SQL212b ");	// Remplissage PRM direct	
			$r--;
			}			
		}
}	
		else{
		die(mysql_error($con)." Error in query SQL211a : $SQL211  ");
		}
		echo "</br>Fin analyse menages _ligne de fin : _</br>Insertion_";		
}}
//
#	LPRM
$SQL_LPRM2="	UPDATE rc2013.individus SET lprm = '02' WHERE rang = '2' AND couple = '01'";
mysqli_query($con,$SQL_LPRM2)  or die(mysqli_error($con)."Error in query SQL_LPRM2");
	
#	RECADARAGE TRM <> EMMENAGEMENT
$SQL_AEMMTRMa="	UPDATE rc2013.individus SET aged = CONCAT(IF(2013 - aemm > left(aged,2), 2013 - aemm ,left(aged,2)),right(aged,2)) WHERE rang = 1";
mysqli_query($con,$SQL_AEMMTRMa)  or die(mysqli_error($con)."Error in query SQL_AEMMTRMa");
$SQL_AEMMTRMb="	UPDATE rc2013.individus SET aemm = IF(2013 - right(aged,2) > aemm,2013 - right(aged,2), IF(2013 - right(aged,2) <= aemm, aemm, NULL)) WHERE rang <> 1";
mysqli_query($con,$SQL_AEMMTRMb)  or die(mysqli_error($con)."Error in query SQL_AEMMTRMb");	
\end{lstlisting}
\section{Etape n\textsuperscript{o}3 : Rapprochement}
\begin{lstlisting}[caption = Script php permettant d'insérer les lignes du fichier détails individus dans la base de projection, language = php]
####																																		####
#	CLEFS DE MISE EN RELATION DES INDIVIDUS DU FICHIER AU QUART
echo ( "</br>CLEFS DE MISE EN RELATION DES INDIVIDUS DU FICHIER AU QUART </br> </br>");
#	TABLE INDIVIDUS INSEE
##	CLEF_LOGEMENT
	
$SQL_QUART_CLEFLOG_a="	ALTER TABLE rc$AAAA.fd_indcvizc_$AAAA ADD `CLEF_LOGEMENT` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
	#UPDATE fd_indcvizc_2013 SET NBPI = CONCAT(0,NBPI) WHERE NBPI != 'ZZ' and NBPI <10 
$SQL_QUART_CLEFLOG_b=" 	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET clef_logement = CONCAT (achlr, ascen, chfl, garl, hlml, nbpi, sani, stocd, surf, typc, typl);";
		
mysqli_query($con,$SQL_QUART_CLEFLOG_a)  or die(mysqli_error($con)."Error in query SQL210da ");
mysqli_query($con,$SQL_QUART_CLEFLOG_b)  or die(mysqli_error($con)."Error in query SQL210da ");

//	##	CLEF_MENAGE
		
$SQL_QUART_CLEFMEN_a ="	ALTER TABLE rc$AAAA.fd_indcvizc_$AAAA ADD `CLEF_MENAGE` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
$SQL_QUART_CLEFMEN_b ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET clef_menage = CONCAT ( aemmr, catl, inper, voit);";
mysqli_query($con,$SQL_QUART_CLEFMEN_a)  or die(mysqli_error($con)."Error in query SQL210da ");
mysqli_query($con,$SQL_QUART_CLEFMEN_b)  or die(mysqli_error($con)."Error in query SQL210da ");

##	CLEF_PRM
		
$SQL_QUART_CLEFPRM_a ="	ALTER TABLE rc$AAAA.fd_indcvizc_$AAAA ADD `CLEF_PRM` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
		
$SQL_QUART_CLEFPRM_b ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET ager20 = '00' WHERE ager20 = '02' OR ager20 = '05' OR ager20 = '10' OR ager20 = '14';";
$SQL_QUART_CLEFPRM_c ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET ager20 = '15' WHERE ager20 = '17' OR ager20 = '19';";
$SQL_QUART_CLEFPRM_d ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET ager20 = '20' WHERE ager20 = '24';";
$SQL_QUART_CLEFPRM_e ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET ager20 = '25' WHERE ager20 = '29' OR ager20 = '39';";
$SQL_QUART_CLEFPRM_f ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET ager20 = '40' WHERE ager20 = '54';";
$SQL_QUART_CLEFPRM_g ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET ager20 = '55' WHERE ager20 = '64';";
$SQL_QUART_CLEFPRM_h ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET ager20 = '65' WHERE ager20 = '79';";
$SQL_QUART_CLEFPRM_i ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET ager20 = '80' WHERE ager20 = '80';";		
$SQL_QUART_CLEFPRM_j=" 	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET clef_prm = CONCAT ( ager20, dipl_15, empl, iletud, ilt, immi, inai, iran, rech, sexe, stat_conj, tact, tp, trans) WHERE lprm ='1';";
		
mysqli_query($con,$SQL_QUART_CLEFPRM_a)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_a ");
mysqli_query($con,$SQL_QUART_CLEFPRM_b)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_b ");
mysqli_query($con,$SQL_QUART_CLEFPRM_c)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_c ");
mysqli_query($con,$SQL_QUART_CLEFPRM_d)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_d ");
mysqli_query($con,$SQL_QUART_CLEFPRM_e)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_e ");
mysqli_query($con,$SQL_QUART_CLEFPRM_f)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_f ");
mysqli_query($con,$SQL_QUART_CLEFPRM_g)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_g ");
mysqli_query($con,$SQL_QUART_CLEFPRM_h)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_h ");
mysqli_query($con,$SQL_QUART_CLEFPRM_i)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_i ");
mysqli_query($con,$SQL_QUART_CLEFPRM_j)  or die(mysqli_error($con)."Error in query SQL_QUART_CLEFPRM_j ");

##	CLEF_PONDER
		
$SQL_QUART_POND_a ="	ALTER TABLE rc$AAAA.fd_indcvizc_$AAAA ADD `CLEF_PONDER` VARCHAR(15) NULL DEFAULT NULL AFTER `id`;";
$SQL_QUART_POND_b ="	UPDATE rc$AAAA.fd_indcvizc_$AAAA SET clef_ponder = ROUND(ipondi, 12)  ;";
		
mysqli_query($con,$SQL_QUART_POND_a)  or die(mysqli_error($con)."Error in query SQL_QUART_POND_a");
mysqli_query($con,$SQL_QUART_POND_b)  or die(mysqli_error($con)."Error in query SQL_QUART_POND_b");

#	TABLE LOGEMENT SCINDEE
##	CLEF_LOGEMENT
		
$SQL_LOG_LOG_a ="	ALTER TABLE rc$AAAA.logements ADD `CLEF_LOGEMENT` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
$SQL_LOG_LOG_b ="	ALTER TABLE rc$AAAA.logements ADD `ACHLR` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;"	
$SQL_LOG_LOG_c ="	UPDATE rc$AAAA.logements SET achlr = '1' WHERE achl = '111';";
$SQL_LOG_LOG_d ="	UPDATE rc$AAAA.logements SET achlr = '2' WHERE achl = '112';";
$SQL_LOG_LOG_e ="	UPDATE rc$AAAA.logements SET achlr = '3' WHERE achl = '211';";
$SQL_LOG_LOG_f ="	UPDATE rc$AAAA.logements SET achlr = '4' WHERE achl = '212';";
$SQL_LOG_LOG_g ="	UPDATE rc$AAAA.logements SET achlr = '5' WHERE achl = '311';";
$SQL_LOG_LOG_h ="	UPDATE rc$AAAA.logements SET achlr = '6' WHERE achl = '312' OR achl = '313' OR achl = '314' OR achl = '315' OR achl = '316';";
$SQL_LOG_LOG_i ="	UPDATE rc$AAAA.logements SET achlr = '7' WHERE achl = '323' OR achl = '324' OR achl = '325' OR achl = '326' OR achl = '327';";
		
$SQL_LOG_LOG_j =" 	UPDATE rc$AAAA.logements SET clef_logement = CONCAT (achlr, ascen, chfl, garl, hlml, nbpi, sani, stocd, surf, typc, typl);";
		
mysqli_query($con,$SQL_LOG_LOG_a)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_a");
mysqli_query($con,$SQL_LOG_LOG_b)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_b");
mysqli_query($con,$SQL_LOG_LOG_c)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_c");
mysqli_query($con,$SQL_LOG_LOG_d)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_d");
mysqli_query($con,$SQL_LOG_LOG_e)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_e");
mysqli_query($con,$SQL_LOG_LOG_f)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_f");
mysqli_query($con,$SQL_LOG_LOG_g)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_g");
mysqli_query($con,$SQL_LOG_LOG_h)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_h");
mysqli_query($con,$SQL_LOG_LOG_i)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_i");
mysqli_query($con,$SQL_LOG_LOG_j)  or die(mysqli_error($con)."Error in query SQL_LOG_LOG_j");
	
//	#	TABLE MENAGES
$SQL_MEN_LOG_a ="	UPDATE menages SET CLEF_LOGEMENT = (SELECT clef_logement FROM logements WHERE logements.id_log = menages.id_men)";		
mysqli_query($con,$SQL_MEN_LOG_a)  or die(mysqli_error($con)."Error in query SQL_MEN_LOG_a");

##	CLEF_MENAGE		
$SQL_MEN_MEN_a ="	ALTER TABLE rc$AAAA.menages ADD `clef_menage` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
$SQL_MEN_MEN_b ="	UPDATE menages SET clef_menage = CONCAT ( aemmr, catlM, inper, voit) WHERE 1;";		
mysqli_query($con,$SQL_MEN_MEN_a)  or die(mysqli_error($con)."Error in query SQL_MEN_MEN_a");
mysqli_query($con,$SQL_MEN_MEN_b)  or die(mysqli_error($con)."Error in query SQL_MEN_MEN_b");

##	CLEF_PRM		
$SQL_MEN_LOG_a ="	ALTER TABLE `MENAGES` ADD `CLEF_PRM` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
$SQL_MEN_LOG_b =" 	UPDATE menages SET clef_prm = CONCAT ( agemen8, diplm_15, emplm, iletudm, iltm, immim, inaim, iranm, rechm, sexem, stat_conjm, tactm, tpm, transm) ;";		
mysqli_query($con,$SQL_MEN_LOG_a)  or die(mysqli_error($con)."Error in query SQL_MEN_LOG_a");
mysqli_query($con,$SQL_MEN_LOG_b)  or die(mysqli_error($con)."Error in query SQL_MEN_LOG_b");
//			
##	CLEF_PONDER
$SQL_MEN_PON_a ="	ALTER TABLE `menages` ADD `CLEF_PONDER` VARCHAR(15) NULL DEFAULT NULL AFTER `id`;";
$SQL_MEN_PON_b =" 	UPDATE menages SET clef_ponder  = IF(An_Collecte = '2018' OR An_Collecte = '2017' OR An_Collecte = '2021', ROUND(ipondl * 4 , 12), IF(An_Collecte = '2019' OR An_Collecte = '2020', ROUND (ipondl * 5 , 12), round(ipondl,12)))  ;";	
mysqli_query($con,$SQL_MEN_PON_a)  or die(mysqli_error($con)."Error in query SQL_MEN_PON_a");
mysqli_query($con,$SQL_MEN_PON_b)  or die(mysqli_error($con)."Error in query SQL_MEN_PON_b");

//	#	TABLE INDIVIDUS SAUCE AUDIAR		
$SQL_IND_LOG_a ="	ALTER TABLE rc$AAAA.individus ADD `CLEF_LOGEMENT` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
$SQL_IND_MEN_a ="	ALTER TABLE rc$AAAA.individus ADD `CLEF_MENAGE` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
$SQL_IND_PON_a ="	ALTER TABLE rc$AAAA.individus ADD `CLEF_PONDER` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
$SQL_IND_PRM_a ="	ALTER TABLE rc$AAAA.individus ADD `CLEF_PRM` VARCHAR(50) NULL DEFAULT NULL AFTER `id`;";
$SQL_IND_CAN_a ="	ALTER TABLE rc$AAAA.individus ADD `CANTONVILLE` VARCHAR(5) NULL AFTER `AEMM`;";
	
$SQL_IND_PON_b ="	UPDATE rc$AAAA.individus SET clef_ponder  = ( SELECT menages.clef_ponder FROM menages WHERE menages.id_men = individus.nummi);";
$SQL_IND_MEN_b =" 	UPDATE rc$AAAA.individus SET clef_menage  = ( SELECT menages.clef_menage FROM menages WHERE menages.id_men = individus.nummi);";
$SQL_IND_LOG_b =" 	UPDATE rc$AAAA.individus SET clef_logement= ( SELECT menages.clef_logement FROM menages WHERE menages.id_men = individus.nummi);";
$SQL_IND_PRM_b =" 	UPDATE rc$AAAA.individus SET clef_prm     = ( SELECT menages.clef_prm FROM menages WHERE menages.id_men = individus.nummi);";
$SQL_IND_CAN_b =" 	UPDATE rc$AAAA.individus SET cantonville  = ( SELECT localisation.cv FROM localisation WHERE localisation.CODE_IRIS = individus.iris_2013);";
		
mysqli_query($con,$SQL_IND_MEN_a)  or die(mysqli_error($con)."Error in query SQL_IND_MEN_a");
mysqli_query($con,$SQL_IND_MEN_b)  or die(mysqli_error($con)."Error in query SQL_IND_MEN_b");
mysqli_query($con,$SQL_IND_PRM_a)  or die(mysqli_error($con)."Error in query SQL_IND_PON_a");
mysqli_query($con,$SQL_IND_PRM_b)  or die(mysqli_error($con)."Error in query SQL_IND_PON_b");
mysqli_query($con,$SQL_IND_LOG_a)  or die(mysqli_error($con)."Error in query SQL_IND_LOG_a");
mysqli_query($con,$SQL_IND_LOG_b)  or die(mysqli_error($con)."Error in query SQL_IND_LOG_b");
mysqli_query($con,$SQL_IND_CAN_a)  or die(mysqli_error($con)."Error in query SQL_IND_CAN_a");
mysqli_query($con,$SQL_IND_CAN_b)  or die(mysqli_error($con)."Error in query SQL_IND_CAN_b");
mysqli_query($con,$SQL_IND_PON_a)  or die(mysqli_error($con)."Error in query SQL_IND_PON_a");
mysqli_query($con,$SQL_IND_PON_b)  or die(mysqli_error($con)."Error in query SQL_IND_PON_b");
		
echo ("Creation & mise a jour des 5 clefs relatives OK !  </br>");
#	GESTION DOUBLONS
//		
$SQL_IND_DOUB_a="UPDATE individus T1 SET DOUBLON = (SELECT COUNT(*) FROM (SELECT CANTONVILLE, CLEF_PRM, CLEF_MENAGE, CLEF_PONDER, CLEF_LOGEMENT, rang, id FROM individus) T2 WHERE T2.CANTONVILLE = T1.CANTONVILLE AND T2.CLEF_PRM = T1.CLEF_PRM AND T2.CLEF_LOGEMENT= T1.CLEF_LOGEMENT AND T2.CLEF_MENAGE = T1.CLEF_MENAGE AND T2.CLEF_PRM = T1.CLEF_PRM AND T2.RANG= T1.rang AND T2.CLEF_PONDER = T1.CLEF_PONDER AND t1.id > T2.ID )";
	
$SQL_QUART_DOUB_a="UPDATE fd_indcvizc_2013 T1 SET DOUBLON = (SELECT COUNT(*) FROM (SELECT CANTVILLE, CLEF_PRM, CLEF_MENAGE, CLEF_PONDER, CLEF_LOGEMENT, rang, id FROM fd_indcvizc_2013) T2 WHERE T2.CANTVILLE = T1.CANTVILLE AND T2.CLEF_PRM = T1.CLEF_PRM AND T2.CLEF_LOGEMENT= T1.CLEF_LOGEMENT AND T2.CLEF_MENAGE = T1.CLEF_MENAGE AND T2.CLEF_PRM = T1.CLEF_PRM AND T2.RANG= T1.rang AND T2.CLEF_PONDER = T1.CLEF_PONDER and t1.id > T2.ID )";
mysqli_query($con, $SQL_IND_DOUB_a)  or die(mysqli_error($con)."Error in query SQL_IND_DOUB_a");
mysqli_query($con, $SQL_QUART_DOUB_a)  or die(mysqli_error($con)."Error in query SQL_QUART_DOUB_a");
//
$MAJ="SELECT nummi, clef_PRM FROM fd_indcvizc_2013 WHERE iris like '35042%' or iris like '35281%' AND clef_PRM is not null GROUP by nummi, CLEF_PRM ";
$MAJ_BSTJ=mysqli_query($con,$MAJ)or die(mysqli_error($con)."Error in query MAJ");

while($row=mysqli_fetch_array($MAJ_BSTJ))
	{$NUMMI	 =	$row["nummi"];
	$CPRM	   =	$row["clef_PRM"];
	$YOYO    ="	UPDATE fd_indcvizc_2013 SET clef_PRM = '".$CPRM."' WHERE nummi = '".$NUMMI."' ";
	mysqli_query($con,$YOYO)  or die(mysqli_error($con)."Error in query YOYO");
	echo "</br>$NUMMI._.$CPRM";}

//	#	INSERTION DES DONNEES POUR INDIVIDUS IDENTIFIES
$B1 = " SELECT cantonville from individus group by cantonville;";
$B2 = mysqli_query($con, $B1)  or die(mysqli_error($con)."Error in query SQL_B1");
if(!$B2) echo "pb B2";
else{
	while($row=mysqli_fetch_array($B2)){
	$CANT=$row["cantonville"];

	$SQL_insertindquart_a="	UPDATE individus T1 set FICH_IND = (SELECT id T2 FROM fd_indcvizc_2013 T2 WHERE T1.CLEF_PONDER = T2.CLEF_PONDER AND T1.CLEF_PRM = T2.CLEF_PRM AND T1.CLEF_MENAGE = T2.CLEF_MENAGE AND T1.rang = T2.rang AND T1.DOUBLON = T2.DOUBLON and T1.CANTONVILLE = T2.CANTVILLE AND T1.CLEF_LOGEMENT = T2.CLEF_LOGEMENT)
WHERE IRIS_2013 like '35024%' OR iris_2013 like '35281%'  ";	
	mysqli_query($con,$SQL_insertindquart_a)  or die(mysqli_error($con)."Error in query SQL_insertindquart_a");
	echo "</br> CANTON_$CANT </br>";
	
	$SQL_insertindquart_c="UPDATE rc2013.individus T1  SET 
	aged 	= (SELECT aged 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	ager20 	= (SELECT ager20 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	agerev 	= (SELECT agerev 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	agerevq = (SELECT agerevq 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),	
	anai 	= (SELECT anai 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	apaf 	= (SELECT apaf 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	couple 	= (SELECT couple 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	cs1 	= (SELECT cs1 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	dipl_15 = (SELECT dipl_15 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	dnai 	= (SELECT dnai 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	empl 	= (SELECT empl 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	iletud 	= (SELECT iletud 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	ilt 	= (SELECT ilt 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	immi 	= (SELECT immi 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	inai 	= (SELECT inai 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	inatc 	= (SELECT inatc 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	infam 	= (SELECT infam 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	iran 	= (SELECT iran 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	lienf 	= (SELECT lienf		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	lprf 	= (SELECT lprf 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	lprm 	= (SELECT lprm 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	moco 	= (SELECT moco		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	modv 	= (SELECT modv 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	na17	= (SELECT na17 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	na5 	= (SELECT na5	 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	naidt 	= (SELECT naidt 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	moco 	= (SELECT moco 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	moco 	= (SELECT moco 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	oridt 	= (SELECT oridt 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	rech 	= (SELECT rech 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	sexe 	= (SELECT sexe 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	sfm 	= (SELECT sfm	 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	stat_conj  = (SELECT stat_conj	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	statr 	= (SELECT statr 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	tact 	= (SELECT tact 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	tactd16 = (SELECT tactd16	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	tp 	= (SELECT tp 		FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	trans 	= (SELECT trans 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id ),
	aemm 	= (SELECT aemmr 	FROM rc2013.fd_indcvizc_2013 T2 WHERE T1.fich_ind = T2.id )
	WHERE	 fich_ind  IS NOT NULL AND cantonville = $CANT ;";
		
	mysqli_query($con,$SQL_insertindquart_c)  or die(mysqli_error($con)."Error in query SQL_insertindquart_c");
	}}
	echo ( "Insertion du quart des individus OK!  </br>");
	//
	$SQL_insertindquart_a="SELECT CANTVILLE FROM fd_indcvizc_2013 WHERE iris like '35024%' or iris like '35281%' GROUP BY cantville ";
	$SEL_CANT=mysqli_query($con,$SQL_insertindquart_a)  or die(mysqli_error($con)."Error in query SQL_insertindquart_a");
	$row=mysqli_fetch_array($SEL_CANT);
	while($row){
	$CANT = $row["CANTVILLE"];
	$SEL_CANT="SELECT * FROM rc2013.fd_indcvizc_2013 WHERE CANTVILLE = '".$CANT."' ; ";
	$SEL_INDIV = mysqli_query($con,$SEL_CANT)  or die(mysqli_error($con)."Error in query SEL_CANT");
	$row =mysqli_fetch_array($SEL_INDIV);
	while($row)
		{$CPRM=$row["CLEF_PRM"];
		$CPOND=$row["CLEF_PONDER"];
		$CLOG=$row["CLEF_LOGEMENT"];
		$CMEN=$row["CLEF_MENAGE"];
		$CRANG=$row["rang"];
		$CDOUB=$row["DOUBLON"];
		$SQL_insertindquart_b="UPDATE  rc2013.individus T1
		SET  T1.aged = 		T2.aged,
			T1.ager20 = 	T2.ager20,
			T1.agerev = 	T2.agerev,
			T1.agerevq = 	T2.agerevq,
			T1.anai = 	T2.anai,
			T1.apaf = 	T2.apaf,
			T1.couple = 	T2.couple,
			T1.cs1 = 	T2.cs1,
			T1.dipl_15 = 	T2.dipl_15,
			T1.dnai = 	T2.dnai,
			T1.empl = 	T2.empl,
			T1.iletud = 	T2.iletud,
			T1.ilt = 	T2.ilt,
			T1.immi = 	T2.immi,
			T1.inai =	T2.inai,
			T1.inatc = 	T2.inatc,
			T1.infam =	T2.infam,
			T1.iran = 	T2.iran,
			T1.lienf = 	T2.lienf,
			T1.lprf = 	T2.lprf,
			T1.lprm = 	T2.lprm,
			T1.moco =	T2.moco,
			T1.oridt = 	T2.oridt,
			T1.rech =	T2.rech,
			T1.sexe = 	T2.sexe,
			T1.sfm = 	T2.sfm,
			T1.statconj =	T2.statconj,
			T1.statr = 	T2.statr,
			T1.tact = 	T2.tact,
			T1.tp = 	T2.tp,
			T1.trans = 	T2.trans,
			T1.aemm = 	T2.aemm
			
		FROM  rc2013.fd_indcvizc_2013 T2
		WHERE   
			T1.CLEF_PRM 		= $CPRM
			AND T1.CLEF_MENAGE 	= '".$CMEN."' 
			AND T1.CLEF_logement 	= '".$CLOG."'
			AND T1.CANTONVILLE 	= '".$CANT."'
			AND individus.rang 	='".$CRANG."'
			AND individus.doublon 	= '".$CDOUB."' 
			AND individus.CLEF_PONDER = ".$CPOND."";
		mysqli_query($con,$SQL_insertindquart_b)  or die(mysqli_error($con)."Error in query SQL_insertindquart_b");
		}
	}
\end{lstlisting}
\section{Etape n\textsuperscript{o}4 : Remplissage}	
\begin{lstlisting}[caption = Script php permettant de remplir les données manquantes selon les lois de probabilités sur le Reste à Distribuer, language = php]

#	Age
//
"(CREATE TABLE rc2013.agequinq (
 ageq_rec01rpop2013s1 int DEFAULT 0	, ageq_rec01rpop2013s2 int DEFAULT 0	, ageq_rec02rpop2013s1 int DEFAULT 0	, ageq_rec02rpop2013s2 int DEFAULT 0	, ageq_rec03rpop2013s1 int DEFAULT 0	, ageq_rec03rpop2013s2 int DEFAULT 0	, ageq_rec04rpop2013s1 int DEFAULT 0	, ageq_rec04rpop2013s2 int DEFAULT 0	, ageq_rec05rpop2013s1 int DEFAULT 0	, ageq_rec05rpop2013s2 int DEFAULT 0	, ageq_rec06rpop2013s1 int DEFAULT 0	, ageq_rec06rpop2013s2 int DEFAULT 0	, ageq_rec07rpop2013s1 int DEFAULT 0	, ageq_rec07rpop2013s2 int DEFAULT 0	, ageq_rec08rpop2013s1 int DEFAULT 0	, 
ageq_rec08rpop2013s2 int DEFAULT 0	, ageq_rec09rpop2013s1 int DEFAULT 0	, ageq_rec09rpop2013s2 int DEFAULT 0	, ageq_rec10rpop2013s1 int DEFAULT 0	, ageq_rec10rpop2013s2 int DEFAULT 0	, ageq_rec11rpop2013s1 int DEFAULT 0	, ageq_rec11rpop2013s2 int DEFAULT 0	, ageq_rec12rpop2013s1 int DEFAULT 0	, ageq_rec12rpop2013s2 int DEFAULT 0	, ageq_rec13rpop2013s1 int DEFAULT 0	, ageq_rec13rpop2013s2 int DEFAULT 0	, ageq_rec14rpop2013s1 int DEFAULT 0	, ageq_rec14rpop2013s2 int DEFAULT 0	, ageq_rec15rpop2013s1 int DEFAULT 0	, ageq_rec15rpop2013s2 int DEFAULT 0	, 
ageq_rec16rpop2013s1 int DEFAULT 0	, ageq_rec16rpop2013s2 int DEFAULT 0	, ageq_rec17rpop2013s1 int DEFAULT 0	, ageq_rec17rpop2013s2 int DEFAULT 0	, ageq_rec18rpop2013s1 int DEFAULT 0	, ageq_rec18rpop2013s2 int DEFAULT 0	, ageq_rec19rpop2013s1 int DEFAULT 0	, ageq_rec19rpop2013s2 int DEFAULT 0	, ageq_rec20rpop2013s1 int DEFAULT 0	, ageq_rec20rpop2013s2 int DEFAULT 0, CODE_COM varchar(5)  PRIMARY KEY);" // inserer fichier age détaillé à la commune. Le fichier va servir de base relative, on fait donc l hypothèse quelle reste la meme puisque les intra-extra sont proportionelles et de fait peut importe le millésime sur cette période

//	$INDIV_COMMUNE="	SELECT cantonville, LEFT(iris_2013,5) AS COM, COUNT(LEFT(iris_2013,5))  FROM individus WHERE RIGHT(iris_2013,9) = '353510000' GROUP BY cantonville, LEFT(iris_2013,5);"; // COMMUNES NON IRISEES
	$EXE_INDIV_IRIS= mysqli_query($con,$INDIV_COMMUNE)  or die(mysqli_error($con)."INDIV_COMMUNE");
	if(!$EXE_INDIV_IRIS){
	echo "Requete vide INDIV_COMMUNE"; 
	exit;
	}
	else{
	 while($row = mysqli_fetch_array($EXE_INDIV_IRIS)){
		$COM=$row["COM"];
		$CANT=$row["cantonville"];
		echo "</br></br>IRIS EN TRAITEMENT : $COM </br> ";

	$SEXE = 2;
	while($SEXE > 0){
	 $QUINQ= 19; 
		while($QUINQ > 0 ){
		if($QUINQ < 3){
		$_00 = ($QUINQ * 5) - 5; $_11 = ($QUINQ * 5) - 4; $_22 = ($QUINQ * 5) - 3; $_33 = ($QUINQ * 5) - 2; $_44 = ($QUINQ * 5) - 1; echo "</br>LES QUINQ_$_00.$_11.$_22.$_33.$_44";
		$essai="SELECT SEXE".$SEXE."_AGED10000".$_00." AS e0 , SEXE".$SEXE."_AGED10000".$_11." AS e1, SEXE".$SEXE."_AGED10000".$_22." AS e2, SEXE".$SEXE."_AGED10000".$_33." AS e3,  SEXE".$SEXE."_AGED10000".$_44." AS e4 FROM pop1B_bis WHERE codgeo ='".$COM."' ";
		$test=mysqli_query($con,$essai)  or die(mysqli_error($con)."essai");
		$row=mysqli_fetch_array($test);
				
		$_0 = $row["e0"];
		$_1 = $row["e1"];
		$_2 = $row["e2"];
		$_3 = $row["e3"];
		$_4 = $row["e4"];
		$UPD_RAD5="UPDATE agequinq SET ageq_rec0$QUINQ"."rpop2013s$SEXE = $_0 + $_1 + $_2 + $_3 + $_4 WHERE code_com = '".$COM."';";
		mysqli_query($con,$UPD_RAD5)  or die(mysqli_error($con)."UPD_RAD5");

		$QUINQ--;
		}
		else{
		 if($QUINQ < 10){
		$_00 = ($QUINQ * 5) - 5; $_11 = ($QUINQ * 5) - 4; $_22 = ($QUINQ * 5) - 3; $_33 = ($QUINQ * 5) - 2; $_44 = ($QUINQ * 5) - 1; echo "</br>LES QUINQ_$_00.$_11.$_22.$_33.$_44";
		$essai="SELECT SEXE".$SEXE."_AGED1000".$_00." AS e0 , SEXE".$SEXE."_AGED1000".$_11." AS e1, SEXE".$SEXE."_AGED1000".$_22." AS e2, SEXE".$SEXE."_AGED1000".$_33." AS e3,  SEXE".$SEXE."_AGED1000".$_44." AS e4 FROM pop1B_bis WHERE codgeo ='".$COM."' ";
		$test=mysqli_query($con,$essai)  or die(mysqli_error($con)."essai");
		$row=mysqli_fetch_array($test);
				
		$_0 = $row["e0"];
		$_1 = $row["e1"];
		$_2 = $row["e2"];
		$_3 = $row["e3"];
		$_4 = $row["e4"];
		$UPD_RAD5 ="UPDATE agequinq SET ageq_rec0$QUINQ"."rpop2013s$SEXE = $_0 + $_1 + $_2 + $_3 + $_4 WHERE code_com = '".$COM."';";
		mysqli_query($con,$UPD_RAD5)  or die(mysqli_error($con)."UPD_RAD5");
				
		$QUINQ--;
		}
		 else{
		$_00 = ($QUINQ * 5) - 5; $_11 = ($QUINQ * 5) - 4; $_22 = ($QUINQ * 5) - 3; $_33 = ($QUINQ * 5) - 2; $_44 = ($QUINQ * 5) - 1; echo "</br>LES QUINQ_$_00.$_11.$_22.$_33.$_44";
		$essai="SELECT SEXE".$SEXE."_AGED1000".$_00." AS e0 , SEXE".$SEXE."_AGED1000".$_11." AS e1, SEXE".$SEXE."_AGED1000".$_22." AS e2, SEXE".$SEXE."_AGED1000".$_33." AS e3,  SEXE".$SEXE."_AGED1000".$_44." AS e4 FROM pop1B_bis WHERE codgeo ='".$COM."' ";
		$test = mysqli_query($con,$essai)  or die(mysqli_error($con)."essai");
		$row = mysqli_fetch_array($test);
				
		$_0 = $row["e0"];
		$_1 = $row["e1"];
		$_2 = $row["e2"];
		$_3 = $row["e3"];
		$_4 = $row["e4"];
		$UPD_RAD5="UPDATE agequinq SET ageq_rec$QUINQ"."rpop2013s$SEXE = $_0 + $_1 + $_2 + $_3 + $_4 WHERE code_com = '".$COM."';";
		mysqli_query($con,$UPD_RAD5)  or die(mysqli_error($con)."UPD_RAD5");
				
		$QUINQ--;
		}
	}
	}
	$SEXE--;
}		
	$SEXE = 2;
		while($SEXE >0){
		echo "</br>SEXE_$SEXE </br>";
		$AGE_REL =" SELECT ageq_rec06rpop2013s$SEXE 	AS T25, ageq_rec07rpop2013s$SEXE 	AS T30, ageq_rec08rpop2013s$SEXE 	AS T35, ageq_rec09rpop2013s$SEXE	AS T40, ageq_rec10rpop2013s$SEXE 	AS T45, ageq_rec11rpop2013s$SEXE	AS T50, ageq_rec12rpop2013s$SEXE	AS T55, ageq_rec13rpop2013s$SEXE	AS T60, ageq_rec14rpop2013s$SEXE	AS T65, ageq_rec15rpop2013s$SEXE	AS T70, ageq_rec16rpop2013s$SEXE	AS T75, ageq_rec17rpop2013s$SEXE	AS T80, ageq_rec18rpop2013s$SEXE	AS T85,ageq_rec19rpop2013s$SEXE	AS T90, ageq_rec20rpop2013s$SEXE	AS T95 FROM 	agequinq WHERE code_com = $COM ;";
		$EXE_AGE_REL= mysqli_query($con,$AGE_REL)  or die(mysqli_error($con)."AGE_REL");
		$row = mysqli_fetch_array($EXE_AGE_REL);
		$T25 = $row["T25"]; echo "T25_$T25</br>";
		$T30 = $row["T30"]; echo "T30_$T30</br>";
		$T35 = $row["T35"]; echo "T35_$T35</br>";
		$T40 = $row["T40"]; echo "T40_$T40</br>";
		$T45 = $row["T45"]; echo "T45_$T45</br>";
		$T50 = $row["T50"]; echo "T50_$T50</br>";
		$T55 = $row["T55"]; echo "T55_$T55</br>";
		$T60 = $row["T60"]; echo "T60_$T60</br>";
		$T65 = $row["T65"]; echo "T65_$T65</br>";
		$T70 = $row["T70"]; echo "T70_$T70</br>";
		$T75 = $row["T75"]; echo "T75_$T75</br>";
		$T80 = $row["T80"]; echo "T80_$T80</br>";
		$T85 = $row["T85"]; echo "T85_$T85 </br>";
		$T90 = $row["T90"]; echo "T90_$T90</br>";
		$T95 = $row["T95"]; echo "T95_$T95</br>";
			
		// PROBA 25-39
		echo "</br>Proba 25-39</br>";
		$RAND_2539 =" UPDATE individus SET aged =  RAND() WHERE fich_ind IS NULL AND aged = '2539' AND LEFT(iris_2013,5) = '".$COM."' AND RIGHT(iris_2013,4) = '0000'";
		mysqli_query($con,$RAND_2539)  or die(mysqli_error($con)."RAND_2539");
		$T_2539 = $T25 + $T30 + $T35; echo "TOTAL_2539_$T_2539</br>";
		$P2539_2529 = $T25 / $T_2539 + 0.000000000001; echo "PB_2539_2529_$P2539_2529</br>";
		$P2539_3034 = ( $T25 + $T30 ) / $T_2539 + 0.000000000001; echo "PB_2539_3034_$P2539_3034</br>";
		$P2539_3539 = ( $T25 + $T30 + $T35) /$T_2539 + 0.000000000001; echo "PB_2539_3539_$P2539_3539</br>";
		$UPD_2539_2529= "	UPDATE individus SET aged = 2529 WHERE aged > 0 			AND aged <= $P2539_2529 AND fich_ind IS NULL ;";
		$UPD_2539_3034="	UPDATE individus SET aged = 3034 WHERE aged > $P2539_2529 	AND aged <= $P2539_3034 AND fich_ind IS NULL ;";
		$UPD_2539_3539="	UPDATE individus SET aged = 3539 WHERE aged > $P2539_3034 	AND aged <= $P2539_3539 AND fich_ind IS NULL ;";
		mysqli_query($con,$UPD_2539_2529)  or die(mysqli_error($con)."UPD_2539_2529");
		mysqli_query($con,$UPD_2539_3034)  or die(mysqli_error($con)."UPD_2539_3034");
		mysqli_query($con,$UPD_2539_3539)  or die(mysqli_error($con)."UPD_2539_3539");
			
		// PROBA 40-54
		echo "</br>Proba 40 - 54</br>";
		$RAND_4054 =" UPDATE individus SET aged =  RAND() WHERE fich_ind IS NULL AND aged = '4054' AND LEFT(iris_2013,5) = '".$COM."' AND RIGHT(iris_2013,4) = '0000' ";
		mysqli_query($con,$RAND_4054)  or die(mysqli_error($con)."RAND_4054");
			
		$T_4054 = $T40 + $T45 + $T50; echo "TOTAL_4054_$T_4054</br>";
			
		$P4054_4044 = ($T40) / $T_4054 + 0.000000000001; echo "PB_4054_4044_$P4054_4044 </br>";
		$P4054_4549 = ($T40 + $T45) / $T_4054  + 0.000000000001; echo "PB_4054_4549_$P4054_4549</br>";
		$P4054_5054 = ($T40 + $T45 + $T50) / $T_4054  + 0.000000000001; echo "PB_4054_5054_$P4054_5054</br>";
			
		$UPD_4054_4044= "	UPDATE individus SET aged = 4044 WHERE aged > 0 			AND aged <= $P4054_4044 AND fich_ind IS NULL ;";
		$UPD_4054_4549="	UPDATE individus SET aged = 4549 WHERE aged > $P4054_4044 	AND aged <= $P4054_4549 AND fich_ind IS NULL ;;";
		$UPD_4054_5054="	UPDATE individus SET aged = 5054 WHERE aged > $P4054_4549 	AND aged <= $P4054_5054 AND fich_ind IS NULL ;;";
			
		mysqli_query($con,$UPD_4054_4044)  or die(mysqli_error($con)."UPD_4054_4044");
		mysqli_query($con,$UPD_4054_4549)  or die(mysqli_error($con)."UPD_4054_4549");
		mysqli_query($con,$UPD_4054_5054)  or die(mysqli_error($con)."UPD_4054_5054");
			
		// PROBA 55 - 64
		echo "</br>Proba 55 - 64</br>";
			
		$RAND_5564 =" UPDATE individus SET aged =  RAND() WHERE fich_ind IS NULL AND aged = '5564' AND LEFT(iris_2013,5) = '".$COM."' AND RIGHT(iris_2013,4) = '0000'";
		mysqli_query($con,$RAND_5564)  or die(mysqli_error($con)."RAND_5564");
			
		$T_5564 = $T55 + $T60;  echo "TOTAL_5564_$T_5564</br>";
			
		$P5564_5559 = ($T55) / $T_5564 + 0.000000000001; echo "PB_5564_5559_$P5564_5559 </br>";
		$P5564_6064 = ($T55 + $T60) / $T_5564  + 0.000000000001; echo "PB_5564_6064_$P5564_6064</br>";
			
		$UPD_5564_5559= "	UPDATE individus SET aged = 5559 WHERE aged > 0 			AND aged <= $P5564_5559 AND fich_ind IS NULL ;";
		$UPD_5564_6064="	UPDATE individus SET aged = 6064 WHERE aged > $P5564_5559	AND aged <= $P5564_6064 AND fich_ind IS NULL ;";
			
		mysqli_query($con,$UPD_5564_5559)  or die(mysqli_error($con)."UPD_5564_5559");
		mysqli_query($con,$UPD_5564_6064)  or die(mysqli_error($con)."UPD_5564_6064");
			
		// PROBA 65 - 74
		echo "</br>Proba 65 - 74</br>";
			
		$RAND_6574 =" UPDATE individus SET aged =  RAND() WHERE fich_ind IS NULL AND aged = '6574' AND LEFT(iris_2013,5) = '".$COM."' AND RIGHT(iris_2013,4) = '0000'";
		mysqli_query($con,$RAND_6574)  or die(mysqli_error($con)."RAND_6574");
			
		$T_6574 = $T65 + $T70;  echo "TOTAL_6574_$T_6574</br>";
			
		$P6574_6569 = ($T65) / $T_6574 + 0.000000000001; echo "PB_6574_6569_$P6574_6569 </br>";
		$P6574_7074 = ($T65 + $T70) / $T_6574  + 0.000000000001; echo "PB_6574_7074_$P6574_7074</br>";
			
		$UPD_6574_6569= "	UPDATE individus SET aged = 6569 WHERE aged > 0 			AND aged <= $P6574_6569  AND fich_ind IS NULL ;";
		$UPD_6574_7074="	UPDATE individus SET aged = 7074 WHERE aged > $P6574_6569	AND aged <= $P6574_7074  AND fich_ind IS NULL ;";
			
		mysqli_query($con,$UPD_6574_6569)  or die(mysqli_error($con)."UPD_6574_6569");
		mysqli_query($con,$UPD_6574_7074)  or die(mysqli_error($con)."UPD_6574_7074");
			
		// PROBA 75 - 99
		echo "</br>Proba 75 - 99</br>";
			
		$RAND_7599 =" UPDATE individus SET aged =  RAND() WHERE fich_ind IS NULL AND aged = '7599' AND LEFT(iris_2013,5) = '".$COM."' AND RIGHT(iris_2013,4) = '0000'";
		mysqli_query($con,$RAND_7599)  or die(mysqli_error($con)."RAND_7599");
			
		$T_7599 = $T75 + $T80 + $T85 + $T90 + $T95; echo "TOTAL_7599_$T_7599</br>";
			
		$P7599_7579 = ($T75) / $T_7599  + 0.000000000001; echo "PB_7599_7579_$P7599_7579</br>";
		$P7599_8084 = ($T75 + $T80) / $T_7599  + 0.000000000001; echo "PB_7599_8084_$P7599_8084</br>";
		$P7599_8589 = ($T75 + $T80 + $T85) / $T_7599  + 0.000000000001; echo "PB_7599_8589_$P7599_8589</br>";
		$P7599_9094 = ($T75 + $T80 + $T85 + $T90) / $T_7599  + 0.000000000001; echo "PB_7599_9094_$P7599_9094</br>";
		$P7599_9599 = ($T75 + $T80 + $T85 + $T90 + $T95) / $T_7599  + 0.000000000001; echo "PB_7599_9599_$P7599_9599</br>";
			
		$UPD_7599_7579= "	UPDATE individus SET aged = 7579 WHERE aged > 0 			AND aged <= $P7599_7579 AND fich_ind IS NULL ;";
		$UPD_7599_8084="	UPDATE individus SET aged = 8084 WHERE aged > $P7599_7579 	AND aged <= $P7599_8084 AND fich_ind IS NULL ;";
		$UPD_7599_8589="	UPDATE individus SET aged = 8589 WHERE aged > $P7599_8084 	AND aged <= $P7599_8589 AND fich_ind IS NULL ;";
		$UPD_7599_9094="	UPDATE individus SET aged = 9094 WHERE aged > $P7599_8589 	AND aged <= $P7599_9094 AND fich_ind IS NULL ;";
		$UPD_7599_9599="	UPDATE individus SET aged = 9599 WHERE aged > $P7599_9094 	AND aged <= $P7599_9599 AND fich_ind IS NULL ;";
			
		mysqli_query($con,$UPD_7599_7579)  or die(mysqli_error($con)."UPD_7559_7579");
		mysqli_query($con,$UPD_7599_8084)  or die(mysqli_error($con)."UPD_7559_8084");
		mysqli_query($con,$UPD_7599_8589)  or die(mysqli_error($con)."UPD_7559_8589");
		mysqli_query($con,$UPD_7599_9094)  or die(mysqli_error($con)."UPD_7559_9094");
		mysqli_query($con,$UPD_7599_9599)  or die(mysqli_error($con)."UPD_7559_9599");
			
		// PROBA 80 - 99
		echo "</br>Proba 80 - 99</br>";
			
		$RAND_8099 =" UPDATE individus SET aged =  RAND() WHERE fich_ind IS NULL AND aged = '8099' AND LEFT(iris_2013,5) = '".$COM."' AND RIGHT(iris_2013,4) = '0000'";
		mysqli_query($con,$RAND_8099)  or die(mysqli_error($con)."RAND_8099");
		$T_8099 = $T80 + $T85 + $T90 + $T95; echo "TOTAL_8099_$T_8099</br>";
		$P8099_8084 = ($T80) / $T_8099  + 0.000000000001; echo "PB_8099_8084_$P8099_8084</br>";
		$P8099_8589 = ($T80 + $T85) / $T_8099  + 0.000000000001; echo "PB_8099_8589_$P8099_8589</br>";
		$P8099_9094 = ($T80 + $T85 + $T90) / $T_8099  + 0.000000000001; echo "PB_8099_9094_$P8099_9094</br>";
		$P8099_9599 = ($T80 + $T85 + $T90 + $T95) / $T_8099  + 0.000000000001; echo "PB_8099_9599_$P8099_9599</br>";
		$UPD_8099_8084="	UPDATE individus SET aged = 8084 WHERE aged > 0			AND aged <= $P8099_8084 AND fich_ind IS NULL ;";
		$UPD_8099_8589="	UPDATE individus SET aged = 8589 WHERE aged > $P8099_8084 	AND aged <= $P8099_8589 AND fich_ind IS NULL ;";
		$UPD_8099_9094="	UPDATE individus SET aged = 9094 WHERE aged > $P8099_8589 	AND aged <= $P8099_9094 AND fich_ind IS NULL ;";
		$UPD_8099_9599="	UPDATE individus SET aged = 9599 WHERE aged > $P8099_9094 	AND aged <= $P8099_9599 AND fich_ind IS NULL ;";
		mysqli_query($con,$UPD_8099_8084)  or die(mysqli_error($con)."UPD_8059_8084");
		mysqli_query($con,$UPD_8099_8589)  or die(mysqli_error($con)."UPD_8059_8589");
		mysqli_query($con,$UPD_8099_9094)  or die(mysqli_error($con)."UPD_9059_9094");
		mysqli_query($con,$UPD_8099_9599)  or die(mysqli_error($con)."UPD_8059_9599");
				
		$SEXE--;
			
		// PROBA 25-59
		echo "</br>Proba 25 - 59</br>";
		$RAND_2559 =" UPDATE individus SET aged =  RAND() WHERE fich_ind IS NULL AND aged = '2559' AND LEFT(iris_2013,5) = '".$COM."' AND RIGHT(iris_2013,4) = '0000'";
		mysqli_query($con,$RAND_2559)  or die(mysqli_error($con)."RAND_2559");
		$T_2559 = $T25 + $T30 + $T35 + $T40 + $T45 + $T50 + $T55; echo "TOTAL_2559_$T_2559</br>";
		$P2559_2529 = ( $T25 ) / $T_2559  + 0.000000000001; echo "PB_2559_2529_$P2559_2529 </br>";
		$P2559_3034 = ( $T25 + $T30 ) / $T_2559  + 0.000000000001; echo "PB_2559_3034_$P2559_3034</br>";
		$P2559_3539 = ( $T25 + $T30 + $T35 ) / $T_2559  + 0.000000000001; echo "PB_2559_3539_$P2559_3539</br>";
		$P2559_4044 = ( $T25 + $T30 + $T35 + $T40 ) / $T_2559  + 0.000000000001; echo "PB_2559_4044_$P2559_4044</br>";
		$P2559_4549 = ( $T25 + $T30 + $T35 + $T40 + $T45 ) / $T_2559  + 0.000000000001; echo "PB_2559_4549_$P2559_4549</br>";
		$P2559_5054 = ( $T25 + $T30 + $T35 + $T40 + $T45 + $T50 ) / $T_2559  + 0.000000000001; echo "PB_2559_5054_$P2559_5054</br>";
		$P2559_5559 = ( $T25 + $T30 + $T35 + $T40 + $T45 + $T50 + $T55 ) / $T_2559  + 0.000000000001; echo "PB_2559_5559_$P2559_5559</br>";
		$UPD_2559_2529="	UPDATE individus SET aged = 2529 WHERE aged > 0 			AND aged <= $P2559_2529 AND fich_ind IS NULL ;";
		$UPD_2559_3034="	UPDATE individus SET aged = 3034 WHERE aged > $P2559_2529 	AND aged <= $P2559_3034 AND fich_ind IS NULL ;";
		$UPD_2559_3539="	UPDATE individus SET aged = 3539 WHERE aged > $P2559_3034 	AND aged <= $P2559_3539 AND fich_ind IS NULL ;";
		$UPD_2559_4044="	UPDATE individus SET aged = 4044 WHERE aged > $P2559_3539 	AND aged <= $P2559_4044 AND fich_ind IS NULL ;";
		$UPD_2559_4549="	UPDATE individus SET aged = 4549 WHERE aged > $P2559_4044 	AND aged <= $P2559_4549 AND fich_ind IS NULL ;";
		$UPD_2559_5054="	UPDATE individus SET aged = 5054 WHERE aged > $P2559_4549 	AND aged <= $P2559_5054 AND fich_ind IS NULL ;";
		$UPD_2559_5559="	UPDATE individus SET aged = 5559 WHERE aged > $P2559_5054 	AND aged <= $P2559_5559 AND fich_ind IS NULL ;";
		mysqli_query($con,$UPD_2559_2529)  or die(mysqli_error($con)."UPD_2559_2529");
		mysqli_query($con,$UPD_2559_3034)  or die(mysqli_error($con)."UPD_2559_3034");
		mysqli_query($con,$UPD_2559_3539)  or die(mysqli_error($con)."UPD_2559_3539");
		mysqli_query($con,$UPD_2559_4044)  or die(mysqli_error($con)."UPD_2559_4044");
		mysqli_query($con,$UPD_2559_4549)  or die(mysqli_error($con)."UPD_2559_4549");
		mysqli_query($con,$UPD_2559_5054)  or die(mysqli_error($con)."UPD_2559_5054");
		mysqli_query($con,$UPD_2559_5559)  or die(mysqli_error($con)."UPD_2559_5559");	
			
	}
//
	#	ALEA DANS LA TRANCHE QUINQUENNALE		
	$ALEA_03="UPDATE individus SET aged = 0 + floor(4*rand()) WHERE aged = 3 AND LEFT(iris_2013,5) = '".$COM."' AND fich_ind is null ";
	mysqli_query($con,$ALEA_03)  or die(mysqli_error($con)."ALEA_TRM");
	$ALEA_406="UPDATE individus SET aged = 4 + floor(3*rand()) WHERE aged = 406 AND LEFT(iris_2013,5) ='".$COM."' AND fich_ind is null";
	mysqli_query($con,$ALEA_406)  or die(mysqli_error($con)."ALEA_TRM");
	$ALEA_711="UPDATE individus SET aged = 7 + floor(5*rand()) WHERE aged = 711 AND LEFT(iris_2013,5) = '".$COM."'AND fich_ind is null";
	mysqli_query($con,$ALEA_711)  or die(mysqli_error($con)."ALEA_TRM");
	$ALEA_6465="UPDATE individus SET aged = 64 + floor(2*rand()) WHERE aged = 6564 AND LEFT(iris_2013,5) ='".$COM."'AND fich_ind is null";
	mysqli_query($con,$ALEA_6465)  or die(mysqli_error($con)."ALEA_TRM");
	$ALEA_2519="UPDATE individus SET aged = 19 + floor(7*rand()) WHERE aged = 2519 AND LEFT(iris_2013,5) = '".$COM."' AND fich_ind is null";
	mysqli_query($con,$ALEA_2519)  or die(mysqli_error($con)."ALEA_TRM");
	$ALEA_2524="UPDATE individus SET aged = 24 + floor(2*rand()) WHERE aged = 2524 AND LEFT(iris_2013,5) = '".$COM."' AND fich_ind is null";
	mysqli_query($con,$ALEA_2524)  or die(mysqli_error($con)."ALEA_TRM");
	echo "</br>Attribution des âges détaillés terminée pour iris $COM !!!!!</br>";
	$delta_trm = 5; // DELTA MAX SUR 19 - 24
	while($delta_trm > -1){
		$D= $delta_trm + 1;
		$ALEA_TRM = "UPDATE individus SET aged = left(aged, 2) + floor($D*rand()) WHERE right(aged,2) - left(aged,2) = 		$delta_trm AND aged IS NOT NULL AND fich_ind IS NULL AND LEFT(iris_2013,5) = '".$COM."';";
		mysqli_query($con,$ALEA_TRM)  or die(mysqli_error($con)."ALEA_TRM");
		$delta_trm --;
		}
//		
		$REV_MILL ="SELECT agerev, nummi, rang FROM individus WHERE fich_ind IS NOT NULL";
		$LOL=mysqli_query($con,$REV_MILL)  or die(mysqli_error($con)."_REV_mill");
		while($row=mysqli_fetch_array($LOL)){
		$agerev =	  $row["agerev"];
		$nummi  =		$row["nummi"];
		$rang   =		$row["rang"];
		$UPD="UPDATE individus SET aged = $agerev WHERE nummi=$nummi AND rang=$rang";
		mysqli_query($con,$UPD)  or die(mysqli_error($con)."_UPS");
		}				
		$HIHI="UPDATE individus SET agerevq = concat(left(aged,1),0) WHERE  right(aged,1) = 0 OR right(aged,1) = 1 OR right(aged,1) = 2 OR right(aged,1) = 3 OR right(aged,1) = 4";
		$HUHU="UPDATE individus SET agerevq = concat(left(aged,1),5) WHERE  right(aged,1) = 5 OR right(aged,1) = 6 OR right(aged,1) = 7 OR right(aged,1) = 8 OR right(aged,1) = 9";
		$HOHO="UPDATE individus SET agerevq = 0 WHERE  aged < 5";
		$HEHE="UPDATE individus SET agerevq = 5 WHERE  aged >= 5 AND aged < 10";
		mysqli_query($con,$HIHI)  or die(mysqli_error($con)."_HIHI");
		mysqli_query($con,$HUHU)  or die(mysqli_error($con)."_HUHU");
		mysqli_query($con,$HOHO)  or die(mysqli_error($con)."_HIHI");
		mysqli_query($con,$HEHE)  or die(mysqli_error($con)."_HUHU");
//
		# RANG 1 par taille de ménage
		$COM = '35032'; $CANT= '3512';
		$INPER_max = " SELECT max(indic_inp) AS inper_max FROM individus WHERE left(IRIS_2013,5)='".$COM."'";
		$EXE_INPER_max = mysqli_query($con,$INPER_max)  or die(mysqli_error($con)."INPER_max");
		$row = mysqli_fetch_array($EXE_INPER_max);
		$INPER = $row["inper_max"];
		echo "Inper_ max_:_.$INPER";
				
		while($INPER > 1){
		echo "</br>INPER_=_.$INPER </br> ";
		echo "Effectifs</br>";
		//	21_COUPLE SANS ENFANT
		$moco21 =	"SELECT  count(moco)  AS tot21 FROM `individus` WHERE rang= 1 ANDfich_ind is not null and indic_inp= '".$INPER."' AND moco = '21' AND left(iris_2013,5) ='".$COM."' "; 
		$EXE_moco21 = mysqli_query($con,$moco21)  or die(mysqli_error($con)."Moco21");
		$row = mysqli_fetch_array($EXE_moco21);
		$a21 = $row["tot21"];
		echo "a21_=_.$a21 </br>";
		//	22_COUPLE AVEC ENFANT	
		$moco22 =	"SELECT count(moco) AS tot22 FROM `individus` WHERE rang= 1 AND fich_ind = 1 and indic_inp= '".$INPER."' AND moco = '22' AND left(iris_2013,5) = '".$COM."' ;";
		$EXE_moco22 = mysqli_query($con,$moco22)  or die(mysqli_error($con)."Moco22");
		$row = mysqli_fetch_array($EXE_moco22);
		$a22 = $row["tot22"];
		echo "a22_=_.$a22 </br>";
		//	23_ADULTE FAMILLE MONO	
		$moco23 =	"SELECT count(moco) AS tot23 FROM `individus` WHERE rang= 1 AND fich_ind = 1 and indic_inp= '".$INPER."' AND moco = '23' AND left(iris_2013,5) = '".$COM."';";
		$EXE_moco23 = mysqli_query($con,$moco23)  or die(mysqli_error($con)."Moco23");
		$row = mysqli_fetch_array($EXE_moco23);
		$a23 = $row["tot23"];
		echo "a23_=_.$a23</br>";
		//	31_HORS FAMILLE DANS MENAGE DE PLUSIEURS PERSONNES	
		$moco31 =	"SELECT count(moco) AS tot31 FROM `individus` WHERE rang= 1 AND fich_ind = 1 and indic_inp= '".$INPER."' AND moco = '31' AND left(iris_2013,5) = '".$COM."' ";
		$EXE_moco31 = mysqli_query($con,$moco31)  or die(mysqli_error($con)."Moco31");
		$row = mysqli_fetch_array($EXE_moco31);
		$a31 = $row["tot31"];
		echo "a31_=_.$a31 </br>";
					
		$A = $a21 + $a22 + $a23 + $a31;
			if ($A > 0) echo "A_=_.$A </br>";{
			echo "</br>Proportions</br>";
			$A21_max = $a21 / $A;
			echo "A21_max_=_.$A21_max </br>";
			$A22_max = (($a21 + $a22) / $A) + 0.000000000001;
			echo "A22_max_=_.$A22_max </br>";
			$A23_max = (($a21 +$a22 +$a23) / $A) + 0.000000000001;
			echo "A23_max_=_.$A23_max </br>";
			$A31_max = (($a21 +$a22 +$a23 + $a31) / $A) + 0.000000000001;
			echo "A31_max_=_.$A31_max </br>";
						
		  $UPD_moco	="	UPDATE individus SET moco =  RAND() 	WHERE indic_inp = $INPER 	AND fich_ind IS NULL 				AND left(iris_2013,5) = $COM ";
			$UPD_moco21 ="	UPDATE individus SET moco = 21 WHERE fich_ind IS NULL AND rang = 1 AND indic_inp = $INPER AND 0	<= moco AND moco < '".$A21_max."' ;"; 
			$UPD_moco22 ="	UPDATE individus SET moco = 22 WHERE fich_ind IS NULL AND rang = 1 AND indic_inp = $INPER	AND  '".$A21_max."' 	<= moco  AND moco < '".$A22_max."' AND left(iris_2013,5) = '".$COM."' ;";
			$UPD_moco23 ="	UPDATE individus SET moco = 23 WHERE fich_ind IS NULL 	AND rang = 1 AND indic_inp = $INPER AND '".$A22_max."' <= moco  AND moco < '".$A23_max."' AND left(iris_2013,5) = '".$COM."' ;";
			$UPD_moco31 ="	UPDATE individus SET moco = 31 WHERE fich_ind IS NULL AND rang = 1 AND indic_inp = $INPER	AND  '".$A23_max."'	<= moco  AND moco < '".$A31_max."' AND left(iris_2013,5) = '".$COM."' ;";
						
			mysqli_query($con,$UPD_moco)  	or die(mysqli_error($con)."UPD_moco");
			mysqli_query($con,$UPD_moco21)  or die(mysqli_error($con)."UPD_moco21");
			mysqli_query($con,$UPD_moco22)  or die(mysqli_error($con)."UPD_moco22");
			mysqli_query($con,$UPD_moco23)  or die(mysqli_error($con)."UPD_moco23");
			mysqli_query($con,$UPD_moco31)  or die(mysqli_error($con)."UPD_moco31");
			}
			$INPER--;
		}	
		$UPD_MOCO_32 ="UPDATE individus SET moco = 32 WHERE rang =1 AND indic_inp = 1 AND left(iris_2013,5) = $COM;";
		mysqli_query($con,$UPD_MOCO_32)  or die(mysqli_error($con)."UPD_moco_32");
				
		# RANG 2_ Deduction immédiate
		echo "</br>Déduction de Moco pour les Rang 2</br>";
		$moco_r1 = "	SELECT cantonville, nummi, moco FROM individus WHERE rang = 1 AND left(iris_2013,5) = $COM ;";
		$EXE_moco_r1 = mysqli_query($con,$moco_r1)  or die(mysqli_error($con)."moco_r1");
		$count = 0;
		if(!$EXE_moco_r1){
			echo "Requete vide $moco_r1"; 
			exit;
			}
		else{
			while($row = mysqli_fetch_array($EXE_moco_r1)){
			$MOCO1 = $row["moco"];
			$nummi = $row["nummi"];
			$cantonville = $row["cantonville"];
			#echo "$cantonville.$nummi.$MOCO1/";
			$UPD_moco_r2="UPDATE individus SET moco = IF('".$MOCO1."' = 21, 21, IF('".$MOCO1."' = 22, 22, IF('".$MOCO1."' = 23, 12, 31))) WHERE rang = 2 AND nummi ='".$nummi."' AND left(IRIS_2013,5)='".$COM."';";
			mysqli_query($con,$UPD_moco_r2)  or die(mysqli_error($con)."UPD_moco_r2");
			$count++;
			}
			echo "</br>Nombre de rang 2 mis à jour : $count";
		}
// PERMUTATIONS SUR RANG 2
echo "</br>PERMUTATIONS DE RANG 2</br>";
//// Un 22 contre un 12
echo"</br>22 CONTRE 12</br>";
$permut_moco_2212="SELECT nummi, count(nummi) AS C FROM individus WHERE moco = 22 AND aged <= 18 AND fich_ind IS NULL AND left(IRIS_2013,5)='".$COM."' GROUP BY nummi;";
$UPD_permut_moco_2212= mysqli_query($con,$permut_moco_2212)  or die(mysqli_error($con)."permut_moco_2212");
$row = mysqli_fetch_array($UPD_permut_moco_2212);
$count=$row["C"];
	if(!$UPD_permut_moco_2212){
	echo "Aucune incohérence enfant mono attribué à conjoint";
	}
	else{
		while($count > 0){
			$NUM = $row["nummi"];
			$actu_moco_2212 =" UPDATE individus SET moco = 12  WHERE nummi = '".$NUM."' AND left(IRIS_2013,5)='".$COM."' AND rang = 2;";
			mysqli_query($con,$actu_moco_2212)  or die(mysqli_error($con)."UPD_moco_2212");
			$actu_moco_r1_2212 =" UPDATE individus SET moco = 23  WHERE nummi = $NUM AND left(IRIS_2013,5)='".$COM."' AND rang = 1;";
			mysqli_query($con,$actu_moco_r1_2212)  or die(mysqli_error($con)."UPD_moco_r1");
			$count--;
			echo '</br> Permutations '.$count;
			}
		}		
				
		$permut_moco_2_2212=" SELECT nummi AS N  FROM individus AS A  WHERE moco = 12 AND rang = 2 AND fich_ind IS NULL AND aged >= 25 AND left(iris_2013,5) = '".$COM."' ORDER BY aged DESC  LIMIT 0, $count ";
		$UPD_permut_moco_2_2212= mysqli_query($con,$permut_moco_2_2212)  or die(mysqli_error($con)."permut_moco_2_221");
		$indic = 0;
		echo "</br>".$a = mysqli_num_rows($UPD_permut_moco_2_2212);
		if($a=0){
		echo "Aucune incohérence enfant mono attribué à conjoint";
		}
		else{
			while ($row=mysqli_fetch_array($UPD_permut_moco_2_2212)){
			$NUM = $row["N"];
			$actu_moco_2_2212 =" UPDATE individus SET moco = 22  WHERE nummi = '".$NUM."' AND left(iris_2013,5) ='".$COM."' AND rang = 2";
			mysqli_query($con,$actu_moco_2_2212)  or die(mysqli_error($con)."UPD_moco_2_2212");
			$actu_moco_2_r1_2212 =" UPDATE individus SET moco = 22  WHERE nummi = '".$NUM."' AND left(iris_2013,5) = '".$COM."' AND rang = 1;";
			mysqli_query($con,$actu_moco_r1_2212)  or die(mysqli_error($con)."UPD_moco_r1");
			$indic++;
			echo "</br>Permutations $indic.Menage$NUM</br>";
			}
		}
///// Un 21 contre un 12
echo"</br>21 CONTRE 12</br>";
$permut_moco="SELECT nummi, count(nummi) AS C FROM individus WHERE moco = 21 AND aged <= 18 AND aged is not null AND fich_ind IS NULL AND left(iris_2013,5) = '".$COM."' GROUP BY nummi ;";
$UPD_permut_moco= mysqli_query($con,$permut_moco)  or die(mysqli_error($con)."permut_moco");
$row = mysqli_fetch_array($UPD_permut_moco);
$count = $row["C"];

if(!$UPD_permut_moco){
echo "Aucune incohérence enfant mono attribué à conjoint";
}
else{
	while($count > 0){
	 $NUM = $row["nummi"];
	 $actu_moco =" UPDATE individus SET moco = 12  WHERE nummi = '".$NUM."' AND left(iris_2013,5) = '".$COM."'  AND rang = 1;";
	 mysqli_query($con,$actu_moco)  or die(mysqli_error($con)."UPD_moco_r2");
	 $actu_moco_r1 =" UPDATE individus SET moco = 23  WHERE nummi = '".$NUM."' AND left(iris_2013,5) = '".$COM."' AND rang = 2;";
	 mysqli_query($con,$actu_moco_r1)  or die(mysqli_error($con)."UPD_moco_r1");
	 $count--;
	 echo '</br> Permutations '.$count;
	}
}
			
$permut_moco_2=" SELECT nummi AS N  FROM individus AS A  WHERE moco LIKE '12' AND rang = 2 AND fich_ind IS NULL AND aged >= 25 AND left(iris_2013,5) = $COM  ORDER BY aged DESC  LIMIT 0,$count ";
$UPD_permut_moco_2= mysqli_query($con,$permut_moco_2)  or die(mysqli_error($con)."permut_moco_2");
$indic = 0;
echo "</br>".$a = mysqli_num_rows($UPD_permut_moco_2);
if($a=0){
echo "Aucune incohérence enfant mono attribué à conjoint";
}
else{
	while ($row=mysqli_fetch_array($UPD_permut_moco_2)){
		$NUM = $row["N"];
		$actu_moco_2 =" UPDATE individus SET moco = 21  WHERE nummi = '".$NUM;"' AND left(iris_2013,5) ='".$COM."' AND rang = 1 ";
		mysqli_query($con,$actu_moco_2)  or die(mysqli_error($con)."UPD_moco_2");
		$actu_moco_2_r1 =" UPDATE individus SET moco = 21  WHERE nummi = '".$NUM."' ANd left(iris_2013,5) = '".$COM."' AND rang = 2;";
		mysqli_query($con,$actu_moco_r1)  or die(mysqli_error($con)."UPD_moco_r1");
		$indic++;
		echo "</br>Permutations $indic.Menage$NUM</br>";
	}
}	//
# Rang  3 et plus 
# Enfant 1 du couple
$SLC_2_22="SELECT nummi FROM individus where rang  = 2 and left(iris_2013,5) = '".$COM."' AND moco = 22 AND indic_inp > 2 AND fich_ind IS NULL";
$UPD_SLC_2_22=mysqli_query($con,$SLC_2_22)  or die(mysqli_error($con)."SLC_2_22");
$count=0;
if(!$row=mysqli_fetch_array($UPD_SLC_2_22)) {
echo "Aucun parent en couple apparent";
	}
else{
	while($row=mysqli_fetch_array($UPD_SLC_2_22)){
		$NUM=$row["nummi"];
		$MOCO_3_11="UPDATE individus SET moco = 11 WHERE nummi = '".$NUM."' ANd left(iris_2013,5) = '".$COM."' AND rang > 2 AND fich_ind IS NULL;";
		mysqli_query($con,$MOCO_3_11)  or die(mysqli_error($con)."MOCO_3_11");
		$count++;
	}
	echo "</br>Nb de premier enfant du couple_". $count ."COMMUNE :".$COM."</br>";
	}
	# Enfant 2 de la mono	
	$SLC_2_23="SELECT nummi FROM individus where rang  = 2 and left(iris_2013,5) = '".$COM."' AND moco = 12 AND indic_inp > 2  AND fich_ind IS NULL";
	$UPD_SLC_2_23=mysqli_query($con,$SLC_2_23)  or die(mysqli_error($con)."SLC_2_23");
	$count=0;
	if(!$row=mysqli_fetch_array($UPD_SLC_2_23)){
	echo "</br>Aucune famille monoparentale de 3 personnes ou plus";
	}
	else{
		while($row=mysqli_fetch_array($UPD_SLC_2_23)){
			$NUM=$row["nummi"];
			$MOCO_3_12="	UPDATE individus SET moco = 12 WHERE nummi = '".$NUM."' ANd left(iris_2013,5) = '".$COM."' AND (rang = 3 OR rang = 4) AND fich_ind IS NULL;";
			mysqli_query($con,$MOCO_3_12)  or die(mysqli_error($con)."MOCO_3_12");
			$count++;
		}
		echo "</br>Nb de deuxime enfant de mono". $count ."</br>";
	}
//
	#	HORS FAMILLE
	$SLC_2_31="	SELECT nummi FROM individus where rang  = 2 and left(iris_2013,5) = '".$COM."' AND moco = 31 OR  moco = 21  AND indic_inp > 2 AND fich_ind IS NULL";
	$UPD_SLC_2_31=mysqli_query($con,$SLC_2_31)  or die(mysqli_error($con)."SLC_2_31");
	$count=0;
	if(!$row=mysqli_fetch_array($UPD_SLC_2_31)){
	echo "</br>Aucun ménage de 3 pers ou plus ne comportant pas de famille";
	}
	else{
		while($row=mysqli_fetch_array($UPD_SLC_2_31)){
			$NUM = $row["nummi"];
			$MOCO_3_31="UPDATE individus SET moco = 31 WHERE nummi = '".$NUM."'ANd left(iris_2013,5) = '".$COM."'AND rang > 2 AND fich_ind IS NULL;";
			mysqli_query($con,$MOCO_3_31)  or die(mysqli_error($con)."MOCO_3_31");
			$count++;
		}
		echo "</br>Nb de hors famille_". $count . $COM."</br>";
	}
	# LPRF
	echo "</br>".$COM;
	$LPRF = "	UPDATE individus SET lprf = IF(moco = 32 OR moco = 40 OR moco =31,0,IF(rang = 1,1,IF(moco LIKE '2%' AND rang = 2,2,IF( moco LIKE '1%', 3,'Z')))) WHERE left(iris_2013,5) = '$COM';";
	$UPD_LPRF=mysqli_query($con,$LPRF)  or die(mysqli_error($con)."LPRF");
			
	# SEXE
	$SEXE_ALEA	= "UPDATE individus SET sexe = rand() WHERE sexe IS NULL AND  left(iris_2013,5) = '".$COM."'";
	$SEXE_LPRM2	= "UPDATE individus SET sexe = 2 WHERE lprf = '2' AND fich_ind IS NULL AND  left(iris_2013,5) = '".$COM."';";
	$UPD_SEXE_ALEA	= mysqli_query($con,$SEXE_ALEA)  or die(mysqli_error($con)."SEXE_ALEA");
	$UPD_SEXE_LPRM2	= mysqli_query($con,$SEXE_LPRM2)  or die(mysqli_error($con)."SEXE_LPRM2");
			
	$EFF_SEXE1_LPRF3= "SELECT count(sexe) AS H FROM fd_indcvizc_2013 WHERE lprf = 3 AND sexe = 1 AND cantville = '$CANT';";
	$EXE_SEXE1_LPRF3= mysqli_query($con,$EFF_SEXE1_LPRF3)  or die(mysqli_error($con)."EFF_SEXE1_LPRF3");
	$row = mysqli_fetch_array($EXE_SEXE1_LPRF3);
	echo "</br>'Garcon_'".$LPRF3_H = $row["H"];
			
	$EFF_SEXE2_LPRF3="SELECT count(sexe) AS F FROM fd_indcvizc_2013 WHERE lprf = 3 AND sexe = 2 AND cantville = '$CANT';";
	$EXE_SEXE2_LPRF3=mysqli_query($con,$EFF_SEXE2_LPRF3)  or die(mysqli_error($con)."EFF_SEXE2_LPRF3");
	$row = mysqli_fetch_array($EXE_SEXE2_LPRF3);
	echo "</br>'Fille_'".$LPRF3_F = $row["F"];
		
	echo "</br> Sex-ratio_".$SR_LPRF3 = $LPRF3_H / ($LPRF3_H+$LPRF3_F);
	echo"</br>__";
	$UPD_SEXE_LPRF3="UPDATE individus SET sexe = IF( sexe <= $SR_LPRF3, '1','2') WHERE lprf = '3' AND sexe < 1;";
	mysqli_query($con,$UPD_SEXE_LPRF3)  or die(mysqli_error($con)."UPD_SEXE_LPRF3");
			
	# 31
	$AA ="SELECT nummi, count(nummi) FROM individus WHERE moco = 31 AND left(iris_2013,5)='".$COM."' GROUP by nummi;";
	$AAA=mysqli_query($con,$AA)  or die(mysqli_error($con)."AA");
	while($row=mysqli_fetch_array($AAA)){
		$num = $row["nummi"];
		$AB="SELECT id_men, sexem, inper, inper1, inper2, iris_2013 FROM menages WHERE id_men  = '".$COM."'";
		$ABB=mysqli_query($con,$AB)  or die(mysqli_error($con)."AA");
		$row2=mysqli_fetch_array($ABB);
		$num2 = $row2["id_men"]; echo $num2;
		$inper = $row2["inper"]; echo "_tot_".$inper;
		$H = $row2["inper1"]; echo "_H_".$H;
		$F = $row2["inper2"];echo "_F_".$F;
		$sexem = $row2["sexem"];echo "_Sex_".$sexem;
		if($sexem= 1){
			$H--;}
		else{
			$F--;}
		echo "</br> </br>_".$num."____H_".$H."_F_".$F;
				
		while($inper > 1 and ($F > 0 OR $H > 0)){
			$ACC2="UPDATE individus SET sexe = 2 WHERE rang = $inper AND nummi = $num2";
			mysqli_query($con,$ACC2)  or die(mysqli_error($con)."ACC2");
			$F--;
			$inper--;
		}
		while($inper > 1 and $H > 0){
			$ACC1="UPDATE individus SET sexe = 1 WHERE rang = $inper ANd nummi = $num2";
			mysqli_query($con,$ACC1)  or die(mysqli_error($con)."ACC1");
			$H--;
			$inper--;
		}
		echo "</br></br>Nummi_$num//Inper_$inper//H_$H//F_$F";
	}		
	//	
	#DIPLOME
	$COM= '35351';
	$SLC_DIPL_1="	SELECT nummi, dipl_15 FROM individus WHERE rang = 1 AND fich_ind IS NULL AND LEFT(iris_2013,5) = $COM;";
	$UPD_DIPL_1=mysqli_query($con,$SLC_DIPL_1)  or die(mysqli_error($con)."SLC_DIPL_1");
	if(!$row=mysqli_fetch_array($UPD_DIPL_1)){
	echo "Selection des diplomes de rang vide"; exit;
		}
	else{
		while($row=mysqli_fetch_array($UPD_DIPL_1)){
			$dipl = $row["dipl_15"];
			$num = $row["nummi"];
			$DIPL_2="	UPDATE individus SET dipl_15 = IF(aged > 15, '$dipl', 'Z') WHERE  nummi = '$num' AND left(iris_2013,5) = $COM AND rang != 1;";
			$UPD_DIPL_2=mysqli_query($con,$DIPL_2)  or die(mysqli_error($con)."DIPL_2");
			$count++;
		}
		echo "</br></br>Nombre de menages dont le diplome a été mis à jour . '$count' ";
	}
}	
}
#RESTE A DISTRIBUER
$SEXE = 2;
$COM ='35351';
while($SEXE > 0){
$a=100;
	while($a >-1){
	if($a  > 99){
	$YY="SELECT count(sexe) AS count FROM individus WHERE left(iris_2013,5) = $COM AND fich_ind is not null AND sexe = $SEXE AND aged = $a;";
	$YYY=mysqli_query($con,$YY)  or die(mysqli_error($con)."_YY");
	if(!$YYY){echo "Loose1";}
	$row=mysqli_fetch_array($YYY);
	$COUNT=$row["count"];
				
	$ZZ="SELECT SEXE".$SEXE."_AGED100".$a."  AS INIT FROM pop1B WHERE codgeo ='".$COM."'";
	$ZZZ=mysqli_query($con,$ZZ)  or die(mysqli_error($con)."_ZZ");
	$row=mysqli_fetch_array($ZZZ);
	$INIT = $row["INIT"];
				
	$XX="UPDATE pop1B_bis SET SEXE".$SEXE."_AGED100".$a." =  $INIT   - $COUNT WHERE codgeo ='".$COM."' ";
	$XXX=mysqli_query($con,$XX)  or die(mysqli_error($con)."_YY");
	echo "</br>$XX";
	echo "</br>Mise à jour de SEXE".$SEXE."_AGED10000".$a."";
	$a--;
	}
			
	else{
	if($a > 9){
		$YY="SELECT count(sexe) AS count FROM individus WHERE left(iris_2013,5) = $COM AND fich_ind is not null AND sexe = $SEXE AND aged = $a;";
		$YYY=mysqli_query($con,$YY)  or die(mysqli_error($con)."_YY");
		if(!$YYY){echo "Loose1";}
		$row=mysqli_fetch_array($YYY);
		$COUNT=$row["count"];
					
		$ZZ="SELECT SEXE".$SEXE."_AGED1000".$a."  AS INIT FROM pop1B WHERE codgeo ='".$COM."'";
		$ZZZ=mysqli_query($con,$ZZ)  or die(mysqli_error($con)."_ZZ");
		$row=mysqli_fetch_array($ZZZ);
		$INIT = $row["INIT"];
					
		$XX="UPDATE pop1B_bis SET SEXE".$SEXE."_AGED1000".$a." =  $INIT   - $COUNT WHERE codgeo ='".$COM."' ";
		$XXX=mysqli_query($con,$XX)  or die(mysqli_error($con)."_YY");
		echo "</br>$XX";
		echo "</br>Mise à jour de SEXE".$SEXE."_AGED10000".$a."";
		$a--;
	}
	else{
	$YY="SELECT count(sexe) AS count FROM individus WHERE left(iris_2013,5) = $COM AND fich_ind is not null AND sexe = $SEXE AND aged = $a;";
	$YYY=mysqli_query($con,$YY)  or die(mysqli_error($con)."_YY");
		if(!$YYY){echo "Loose1";}
		$row=mysqli_fetch_array($YYY);
		$COUNT=$row["count"];
					
		$ZZ="SELECT SEXE".$SEXE."_AGED10000".$a."  AS INIT FROM pop1B WHERE codgeo ='".$COM."'";
		$ZZZ=mysqli_query($con,$ZZ)  or die(mysqli_error($con)."_ZZ");
		$row=mysqli_fetch_array($ZZZ);
		$INIT = $row["INIT"];
					
		$XX="UPDATE pop1B_bis SET SEXE".$SEXE."_AGED10000".$a." = $INIT  - $COUNT WHERE codgeo ='".$COM."' ";
		$XXX=mysqli_query($con,$XX)  or die(mysqli_error($con)."_YY");
		echo "</br>$XX";
		echo "</br>Mise à jour de SEXE".$SEXE."_AGED10000".$a."";
		$a--;
	}
}
}
$SEXE--;
}
//
# SEXE SUR RAD
$COM ='35351'; 
$a = 99;
	
while($a > -1){
	if($a < 10){
	$HH="SELECT SEXE1_AGED10000".$a." AS TH, SEXE2_AGED10000".$a." AS TF FROM pop1B_bis WHERE codgeo = '".$COM."' ;";
	$HHH=mysqli_query($con,$HH)  or die(mysqli_error($con)."SLC_DIPL_1");
	$row=mysqli_fetch_array($HHH);
	$TH=$row["TH"];	$TF=$row["TF"];	$T = $TH +$TF + 0.1;
		
	$P = $TH / $T;	echo "</br>Age _$a SR_$P";
			
	$SEXE_ALEA=	"	UPDATE individus SET sexe = rand() WHERE fich_ind IS NULL AND aged = $a AND iris_2013 = 353510000";
	$UPD_SEXE_ALEA=	mysqli_query($con,$SEXE_ALEA)  or die(mysqli_error($con)."SEXE_A");
				
	$SEXE1="	UPDATE individus SET sexe =  1 WHERE aged=$a AND sexe <= '$P' AND iris_2013 = 353510000 AND fich_ind IS NULL;";
	mysqli_query($con,$SEXE1)  or die(mysqli_error($con)."SEXE_B");
				
	$SEXE2="			UPDATE individus SET sexe =  2 WHERE aged=$a AND sexe > $P  AND sexe < 1 AND iris_2013 = 353510000AND fich_ind IS NULL;";
	mysqli_query($con,$SEXE2)  or die(mysqli_error($con)."SEXE_B2");
	$a--;
	}
	else{
	 if($a < 100){
		$HH="SELECT SEXE1_AGED1000".$a." AS TH, SEXE2_AGED1000".$a." AS TF FROM pop1B_bis WHERE codgeo = '".$COM."' ;";
		$HHH =	mysqli_query($con,$HH)or die(mysqli_error($con)."SLC_DIPL_1");
		$row = mysqli_fetch_array($HHH);
		$TH  = $row["TH"];	$TF=$row["TF"];	$T = $TH +$TF + 0.1; $P = $TH / $T;	echo "</br>Age _$a SR_$P";
				
		$SEXE_ALEA=	"	UPDATE individus SET sexe = rand() WHERE fich_ind IS NULL AND aged = $a AND iris_2013 = 353510000";
		$UPD_SEXE_ALEA=	mysqli_query($con,$SEXE_ALEA)  or die(mysqli_error($con)."SEXE_A");
				
		$SEXE1="			UPDATE individus SET sexe =  1 WHERE aged=$a AND sexe <=  $P AND iris_2013 = 353510000 AND fich_ind IS NULL;";
		mysqli_query($con,$SEXE1)  or die(mysqli_error($con)."SEXE_B");
				
		$SEXE2="			UPDATE individus SET sexe =  2 WHERE aged=$a AND sexe > $P AND sexe < 1 AND iris_2013 = 353510000 AND fich_ind IS NULL;";
		mysqli_query($con,$SEXE2)  or die(mysqli_error($con)."SEXE_B");
				
	  $a--;
	 }
	else{
	 $HH  ="SELECT SEXE1_AGED100".$a." AS TH, SEXE2_AGED100".$a." AS TF FROM pop1B_bis WHERE codgeo = '".$COM."' ;";
	 $HHH = mysqli_query($con,$HH)  or die(mysqli_error($con)."SLC_DIPL_1");
	 $row = mysqli_fetch_array($HHH);
	 $TH=$row["TH"];	$TF=$row["TF"];	$P = $TH / ($TH + $TF);	
				
	 $SEXE_ALEA=	"	UPDATE individus SET sexe = rand() WHERE fich_ind IS NULL AND aged = $a AND iris_2013 = 353510000";
	 $UPD_SEXE_ALEA=	mysqli_query($con,$SEXE_ALEA)  or die(mysqli_error($con)."SEXE_A");		
	 $SEXE="			UPDATE individus SET sexe =  IF( sexe < '".$P."' , 7,8) WHERE aged=$a AND iris_2013 = 353510000 AND fich_ind IS NULL;";
	 mysqli_query($con,$SEXE)  or die(mysqli_error($con)."SEXE_B");
				
	 $a--;
	}
}		
}	
//
?>
</body>
</html> $
\end{lstlisting}
\clearemptydoublepage
\chapter[Construction des hypothèses de projection]{Construction des hypothèses de projection}
\section{Hypothèses de fécondité}
\boitesimple{
	\textbf{Indice Conjoncturel de Fécondité (ICF) :} Nombre moyen d'enfants par femme en âge de procréer.\\
	\textbf{Taux de fécondité par âge :} Probabilité qu'a une femme d'avoir un enfant à l'âge concerné.\\\\
	\textit{Soit $_i$ un âge révolu,\\
	Soit $_t$ une année donnée,\\
	Soit $_P$ un effectif de femmes,\\
	Soit $_N$ un nombre de naissance,
	\begin{center}
	\Large{
	\begin{equation}ICF^{t} = \sum \limits_{\underset{i}{=15}}^{50} f_i^{t}  \end{equation}
	\begin{equation}f_i^{t} =  \frac{N_i^t}{P_i^t} \end{equation}}
	\end{center}
	Soit $\Delta_{i}^{t_1;t_2}$, un coefficient d'évolution du taux de fécondité à un âge $_i$ sur la période $t_1$ à $t_2$, tel que :
	\begin{center}
	\Large{
	\begin{equation}
	\Delta_{i}^{t_1;t_2} = \frac{f_i^{t_2}}{f_i^{t_1}}
	\end{equation}}
	\end{center}
	}
}
\boitesimple{
\textit{\large{Description des hypothèses:}}\\
\begin{itemize}
	\item  \textbf{Constante} : Les taux de fécondité sont gardés aux niveaux observés en 2016.
	\item  \textbf{Continue} : Le rythme de progression observé entre 2006 et 2016 est maintenu, i.e., le recul de calendrier est des 1 an, la baisse de l'ICF de 0.1.
\end{itemize}
\textit{Ce recul de calendrier est maintenu pour les scéarios qui suivent, les niveaux en revanche correspondent aux fourchettes anticipées par l'INSEE au niveau national.}
\begin{itemize}
\item \textbf{Haute : }ICF = 2.1 enf /femme 
\item \textbf{Centrale}  : ICF = 1.95 enf /femme 
\item \textbf{Basse} : ICF = 1.8 enf /femme 
\end{itemize}
}
\newpage
\begin{table}
	\centering
	\begin{tabular}{|p{1.5cm}||p{1.5cm}|p{1.5cm}|p{1.5cm}|p{1.5cm}|p{1.5cm}|p{1.5cm}|p{1.5cm}|}
	\hline
	Âge _i	& \multicolumn{2}{|c|}{Observations}	&	 	& \multicolumn{4}{|c|}{Scénarios de projection} \\ \hline
	(atteint dans l'année)	&	2006	&	Hyp. constante 2016	&  $\Delta_{i}^{2006;2016}$ &	Hyp. continue	&	Hyp. centrale	&	Hyp. basse	&	Hyp. haute	\\	\hline
	15 ans	&	1	&	1	&	0,78	&	1	&	1	&	1	&	1	\\	\hline
	16 ans	&	2	&	2	&	0,88	&	2	&	2	&	2	&	2	\\	\hline
	17 ans	&	6	&	5	&	0,82	&	4	&	4	&	4	&	4	\\	\hline
	18 ans	&	12	&	8	&	0,72	&	6	&	6	&	6	&	7	\\	\hline
	19 ans	&	22	&	17	&	0,76	&	12	&	13	&	12	&	14	\\	\hline
	20 ans	&	33	&	26	&	0,77	&	20	&	20	&	19	&	22	\\	\hline
	21 ans	&	44	&	36	&	0,81	&	29	&	30	&	28	&	32	\\	\hline
	22 ans	&	56	&	46	&	0,81	&	37	&	38	&	35	&	41	\\	\hline
	23 ans	&	69	&	56	&	0,82	&	46	&	47	&	44	&	51	\\	\hline
	24 ans	&	85	&	69	&	0,81	&	56	&	58	&	54	&	62	\\	\hline
	25 ans	&	102	&	85	&	0,84	&	72	&	74	&	68	&	80	\\	\hline
	26 ans	&	119	&	101	&	0,85	&	86	&	89	&	82	&	95	\\	\hline
	27 ans	&	136	&	118	&	0,86	&	102	&	105	&	97	&	113	\\	\hline
	28 ans	&	147	&	131	&	0,90	&	118	&	121	&	112	&	130	\\	\hline
	29 ans	&	152	&	139	&	0,91	&	127	&	131	&	121	&	141	\\	\hline
	30 ans	&	150	&	142	&	0,95	&	134	&	138	&	128	&	149	\\	\hline
	31 ans	&	144	&	141	&	0,98	&	138	&	142	&	131	&	153	\\	\hline
	32 ans	&	131	&	133	&	1,02	&	135	&	139	&	129	&	150	\\	\hline
	33 ans	&	116	&	122	&	1,05	&	129	&	132	&	122	&	143	\\	\hline
	34 ans	&	101	&	108	&	1,08	&	116	&	120	&	111	&	129	\\	\hline
	35 ans	&	86	&	94	&	1,09	&	103	&	106	&	98	&	114	\\	\hline
	36 ans	&	73	&	83	&	1,14	&	95	&	98	&	90	&	105	\\	\hline
	37 ans	&	59	&	68	&	1,17	&	80	&	82	&	76	&	88	\\	\hline
	38 ans	&	46	&	56	&	1,21	&	67	&	69	&	64	&	75	\\	\hline
	39 ans	&	36	&	44	&	1,22	&	54	&	55	&	51	&	60	\\	\hline
	40 ans	&	26	&	33	&	1,26	&	42	&	43	&	40	&	46	\\	\hline
	41 ans	&	19	&	24	&	1,27	&	31	&	32	&	29	&	34	\\	\hline
	42 ans	&	12	&	16	&	1,32	&	21	&	21	&	20	&	23	\\	\hline
	43 ans	&	7		&	10	&	1,37	&	13	&	14	&	13	&	15	\\	\hline
	44 ans	&	4		&	6		&	1,44	&	8		&	8		&	8		&	9		\\	\hline
	45 ans	&	2		&	3		&	1,61	&	5		&	5		&	4		&	5		\\	\hline
	46 ans	&	1		&	2		&	1,50	&	2		&	2		&	2		&	2		\\	\hline
	47 ans	&	0		&	1		&	1,75	&	1		&	1		&	1		&	1		\\	\hline
	48 ans	&	0		&	0		&	2,00	&	1		&	1		&	1		&	1		\\	\hline
	49 ans	&	0		&	0		&	2,00	&	0		&	0		&	0		&	0		\\	\hline
	50 ans	&	0		&	0		&	1,00	&	0		&	0		&	0		&	0		\\	\hline \hline
	TOTAL	&	1997	&	1925 &		&	1893		&	1950	&	1800	&	2100	\\	
	\end{tabular}
	\caption{Taux de fécondité par âge selon le scénario envisagé}
	\end{table}
\newpage
On peut constater que :
\begin{center}
\begin{equation}
\large{$\Delta_{i}^{2006;2016}$ = \left \lbrace \begin{array}{l l}
$\leq 1$ &, \forall $ _i \leq 31$  \\
$\geq 1$ &,  sinon \\
\end{array} \right}
\end{equation}
\end{center}
Cela témoigne donc d'un recul de calendrier de la fécondité.\\\\
La répétition de ses coefficients sur les taux de 2016 permettent de prolonger les tendances tant en calendrier, qu'en intensité en gardant le même rythme et aboutissent à l'hypothèse continue pour 2026 exactement :
\begin{center}
\begin{equation}
\large{$f_i^{'} = f_i * \Delta_i$}
\end{equation}
\end{center}
Afin de garde les éléments de calendrier, mais d'intégrer différentes hypothèses sur l'ICF comme indiquées par l'INSEE, il est nécessaire de repartir de cette nouvelle hypothèse, la série $f^{'}$. Pendre le poids relatif de l'âge concerné pour garder la structure tout en l'appliquant au niveau désiré $ICF^{*}$ tel que :
\begin{center}
\begin{equation}
\large{$f_i^{*} = \frac{f_i^{'}}{\sum\limits_{i=15}^{50} f_i^{'}} * ICF^{*}$}
\end{equation}
\end{center}

\newpage
\begin{figure} \centering
\includegraphics[width=\textwidth]{hypothese/tauxfec.png}
\caption{Taux de fécondité selon l'âge et le scénario envisagé}
\label{Taux de fécondité}
\end{figure}
\newpage
\begin{figure} \centering
\includegraphics[width=\textwidth]{Hypothese/table_fec.png}
\caption{Vue de la table MySql des taux de fécondité dans l'interface phpMyAdmin}
\label{Taux de fécondité}
\end{figure}
\newpage
\section{Hypothèses de mortalité}
\boitesimple{
	\textbf{Quotient de mortalité :} Probabilité de décéder qu'a un individu entre deux anniversaires.\\
	\textbf{Risque relatif :} Mesure  le risque de survenue d'un événement dans un groupe par rapport à lautre.\\\\
	\textit{Soit i un âge, \\
	Soit t une année donnée,\\
	Soit d un nombre de décès, \\
	Soit P un effectif de population,}
	\begin{center} 
	\begin{equation}\large{
	Q_{(i;i+1)}^t = \frac{d_i^t}{\frac{(P_i^t + P_{(i+1)}^{(t+1)})}{2}}}
	\end{equation}
	\end{center}
	\textit{Soit s $\in \left\{1;2\right\}$, le sexe,\\
	Soit Y $\in \left\{A;B;C;D\right\}$, un niveau de diplôme atteint,\\
	Alors C est un risque relatif de décès, tq : \\
	\begin{center}
	\begin{equation} \large{
	_{(s;y)}C_{(i)}^t = \frac{_{(s;y)}Q_{(i;i+1)}^t}{_{(s)}Q_{(i;i+1)}^t} }
	\end{equation}
	\end{center}
	\\C $\in \mathbb{R}^*$ \\
	C $\geq 1$, un risque plus important de connaitre le décès à l'âge considéré \\
	C $\leq 1$, un risque moindre de connaitre le décès à l'âge considéré}
}
\newpage
\tablefirsthead{%
\hline
	&	\multicolumn{10}{|c|}{ 2013 } \\	\hline
	Âge &	 \multicolumn{2}{|c|}{Q_{i;i+1} p.100 000}&	\multicolumn{8}{|c|}{\small Risque relatif selon le sexe, du sous-groupe/Ensemble}\\	\hline
	exact &	\multicolumn{2}{|c|}{\small Ensemble}&	\multicolumn{2}{|c|}{\small Sans diplôme}&	\multicolumn{2}{|c|}{\small BEP-CAP} &	\multicolumn{2}{|c|}{\small Bac}&\multicolumn{2}{|c|}{Etudes sup.}\\	\hline
	&	 H 	&	 F 	&	 H 	&	 F 	&	 H 	&	 F 	&	 H 	&	 F 	&	 H 	&	 F 	\\	\hline}
\tablehead{%
\hline
\multicolumn{11}{|r|}{\small\sl ... Suite}\\ \hline
	&	\multicolumn{10}{|c|}{ 2013 } \\	\hline
	Âge	&	 \multicolumn{2}{|c|}{Q_{i;i+1} p.100 000}&	\multicolumn{8}{|c|}{\small Risque relatif selon le sexe, du Sous-groupe/Ensemble}\\	\hline
	exact &	\multicolumn{2}{|c|}{\small Ensemble}&	\multicolumn{2}{|c|}{\small Sans diplôme}&	\multicolumn{2}{|c|}{\small BEP-CAP} &	\multicolumn{2}{|c|}{\small Bac}&\multicolumn{2}{|c|}{\small Etudes sup.}\\	\hline
 &	 H 	&	 F 	&	 H 	&	 F 	&	 H 	&	 F 	&	 H 	&	 F 	&	 H 	&	 F 	\\	\hline}
\tablelasttail{\hline}
\tablecaption{Mortalité selon l'âge, le sexe, et le niveau de diplôme atteint en 2013}
\begin{supertabular}{|p{1.1cm}||p{1.4cm}|p{1.4cm}|p{0.8cm}|p{0.8cm}|p{0.8cm}|p{0.8cm}|p{0.8cm}|p{0.8cm}|p{0.9cm}|p{0.9cm}|} \small{
30	&	 82   	&	30	&	2,21	&	 1,96   	&	1,16	&	1,48	&	0,80	&	0,72	&	 0,48   	&	 0,48   	\\	\hline
31	&	 87   	&	33	&	2,22	&	 1,95   	&	1,17	&	1,46	&	0,81	&	0,74	&	 0,50   	&	 0,49   	\\	\hline
32	&	 92   	&	35	&	2,22	&	 1,93   	&	1,18	&	1,45	&	0,82	&	0,76	&	 0,51   	&	 0,50   	\\	\hline
33	&	 96   	&	39	&	2,25	&	 1,87   	&	1,21	&	1,40	&	0,83	&	0,75	&	 0,52   	&	 0,49   	\\	\hline
34	&	 99   	&	43	&	2,28	&	 1,84   	&	1,24	&	1,37	&	0,83	&	0,76	&	 0,53   	&	 0,52   	\\	\hline
35	&	 107   	&	45	&	2,22	&	 1,86   	&	1,22	&	1,37	&	0,82	&	0,77	&	 0,53   	&	 0,53   	\\	\hline
36	&	 116   	&	50	&	2,17	&	 1,83   	&	1,21	&	1,34	&	0,82	&	0,77	&	 0,54   	&	 0,55   	\\	\hline
37	&	 125   	&	58	&	2,12	&	 1,80   	&	1,20	&	1,31	&	0,82	&	0,00	&	 0,54   	&	 0,56   	\\	\hline
38	&	 135   	&	64	&	2,09	&	 1,78   	&	1,19	&	1,28	&	0,82	&	0,78	&	 0,54   	&	 0,58   	\\	\hline
39	&	 145   	&	70	&	2,05	&	 1,76   	&	1,18	&	1,26	&	0,81	&	0,79	&	 0,55   	&	 0,59   	\\	\hline
40	&	 162   	&	77	&	2,02	&	 1,74   	&	1,17	&	1,23	&	0,81	&	0,79	&	 0,55   	&	 0,60   	\\	\hline
41	&	 181   	&	85	&	1,99	&	 1,73   	&	1,17	&	1,21	&	0,81	&	0,79	&	 0,55   	&	 0,61   	\\	\hline
42	&	 193   	&	94	&	1,96	&	 1,71   	&	1,16	&	1,19	&	0,81	&	0,80	&	 0,55   	&	 0,62   	\\	\hline
43	&	 216   	&	106	&	1,93	&	 1,69   	&	1,15	&	1,18	&	0,81	&	0,80	&	 0,56   	&	 0,63   	\\	\hline
44	&	 230   	&	118	&	1,90	&	 1,68   	&	1,15	&	1,16	&	0,81	&	0,80	&	 0,56   	&	 0,64   	\\	\hline
45	&	 256   	&	131	&	1,88	&	 1,66   	&	1,14	&	1,14	&	0,80	&	0,81	&	 0,56   	&	 0,65   	\\	\hline
46	&	 281   	&	143	&	1,85	&	 1,65   	&	1,13	&	1,13	&	0,80	&	0,81	&	 0,57   	&	 0,66   	\\	\hline
47	&	 312   	&	164	&	1,82	&	 1,63   	&	1,13	&	1,11	&	0,80	&	0,81	&	 0,57   	&	 0,67   	\\	\hline
48	&	 342   	&	179	&	1,80	&	 1,62   	&	1,12	&	1,10	&	0,80	&	0,82	&	 0,57   	&	 0,68   	\\	\hline
49	&	 384   	&	193	&	1,77	&	 1,61   	&	1,12	&	1,08	&	0,80	&	0,82	&	 0,57   	&	 0,69   	\\	\hline
50	&	 425   	&	211	&	1,75	&	 1,59   	&	1,11	&	1,07	&	0,80	&	0,82	&	 0,58   	&	 0,70   	\\	\hline
51	&	 468   	&	231	&	1,73	&	 1,58   	&	1,11	&	1,06	&	0,80	&	0,82	&	 0,58   	&	 0,71   	\\	\hline
52	&	 514   	&	251	&	1,70	&	 1,57   	&	1,10	&	1,04	&	0,80	&	0,83	&	 0,58   	&	 0,72   	\\	\hline
53	&	 565   	&	271	&	1,68	&	 1,55   	&	1,09	&	1,03	&	0,80	&	0,83	&	 0,59   	&	 0,73   	\\	\hline
54	&	 630   	&	290	&	1,65	&	 1,54   	&	1,09	&	1,02	&	0,80	&	0,83	&	 0,59   	&	 0,74   	\\	\hline
55	&	 698   	&	312	&	1,63	&	 1,53   	&	1,08	&	1,01	&	0,79	&	0,83	&	 0,59   	&	 0,75   	\\	\hline
56	&	 752   	&	339	&	1,60	&	 1,52   	&	1,08	&	1,00	&	0,79	&	0,84	&	 0,60   	&	 0,76   	\\	\hline
57	&	 818   	&	359	&	1,58	&	 1,51   	&	1,07	&	0,99	&	0,79	&	0,84	&	 0,60   	&	 0,77   	\\	\hline
58	&	 870   	&	380	&	1,56	&	 1,50   	&	1,07	&	0,98	&	0,79	&	0,84	&	 0,60   	&	 0,78   	\\	\hline
59	&	 937   	&	409	&	1,54	&	 1,48   	&	1,06	&	0,97	&	0,79	&	0,85	&	 0,61   	&	 0,79   	\\	\hline
60	&	 1003   	&	435	&	1,51	&	 1,47   	&	1,06	&	0,97	&	0,79	&	0,85	&	 0,61   	&	 0,80   	\\	\hline
61	&	 1061   	&	460	&	1,49	&	 1,46   	&	1,05	&	0,97	&	0,79	&	0,85	&	 0,62   	&	 0,81   	\\	\hline
62	&	 1120   	&	482	&	1,47	&	 1,45   	&	1,05	&	0,97	&	0,80	&	0,85	&	 0,62   	&	 0,81   	\\	\hline
63	&	 1178   	&	516	&	1,45	&	 1,44   	&	1,04	&	0,97	&	0,80	&	0,86	&	 0,63   	&	 0,82   	\\	\hline
64	&	 1254   	&	541	&	1,43	&	 1,43   	&	1,04	&	0,97	&	0,80	&	0,86	&	 0,63   	&	 0,83   	\\	\hline
65	&	 1346   	&	586	&	1,41	&	 1,42   	&	1,03	&	0,96	&	0,80	&	0,86	&	 0,63   	&	 0,84   	\\	\hline
66	&	 1433   	&	634	&	1,39	&	 1,41   	&	1,03	&	0,95	&	0,80	&	0,85	&	 0,64   	&	 0,83   	\\	\hline
67	&	 1512   	&	669	&	1,37	&	 1,40   	&	1,03	&	0,96	&	0,80	&	0,87	&	 0,64   	&	 0,84   	\\	\hline
68	&	 1633   	&	745	&	1,35	&	 1,39   	&	1,02	&	0,95	&	0,80	&	0,84	&	 0,65   	&	 0,81   	\\	\hline
69	&	 1745   	&	801	&	1,33	&	 1,38   	&	1,02	&	0,95	&	0,80	&	0,83	&	 0,66   	&	 0,80   	\\	\hline
70	&	 1873   	&	858	&	1,32	&	 1,37   	&	1,01	&	0,94	&	0,80	&	0,84	&	 0,66   	&	 0,80   	\\	\hline
71	&	 2015   	&	940	&	1,30	&	 1,36   	&	1,01	&	0,94	&	0,81	&	0,82	&	 0,67   	&	 0,78   	\\	\hline
72	&	 2165   	&	1045	&	1,28	&	 1,34   	&	1,01	&	0,93	&	0,81	&	0,82	&	 0,67   	&	 0,79   	\\	\hline
73	&	 2401   	&	1152	&	1,26	&	 1,33   	&	1,00	&	0,93	&	0,81	&	0,82	&	 0,68   	&	 0,79   	\\	\hline
74	&	 2601   	&	1279	&	1,24	&	 1,32   	&	1,00	&	0,93	&	0,81	&	0,82	&	 0,69   	&	 0,79   	\\	\hline
75	&	 2843   	&	1409	&	1,22	&	 1,31   	&	1,00	&	0,92	&	0,82	&	0,82	&	 0,70   	&	 0,79   	\\	\hline
76	&	 3155   	&	1603	&	1,20	&	 1,30   	&	0,99	&	0,92	&	0,82	&	0,82	&	 0,70   	&	 0,79   	\\	\hline
77	&	 3482   	&	1793	&	1,20	&	 1,29   	&	0,99	&	0,92	&	0,82	&	0,82	&	 0,71   	&	 0,80   	\\	\hline
78	&	 3870   	&	2021	&	1,20	&	 1,27   	&	0,98	&	0,92	&	0,83	&	0,82	&	 0,72   	&	 0,80   	\\	\hline
79	&	 4381   	&	2306	&	1,20	&	 1,26   	&	0,98	&	0,92	&	0,82	&	0,83	&	 0,73   	&	 0,81   	\\	\hline
80	&	 4829   	&	2690	&	1,20	&	 1,25   	&	1,00	&	0,91	&	0,84	&	0,83	&	 0,76   	&	 0,81   	\\	\hline
81	&	 5391   	&	3098	&	1,20	&	 1,23   	&	1,00	&	0,91	&	0,85	&	0,83	&	 0,77   	&	 0,82   	\\	\hline
82	&	 6158   	&	3550	&	1,19	&	 1,22   	&	1,00	&	0,92	&	0,85	&	0,84	&	 0,78   	&	 0,82   	\\	\hline
83	&	 6866   	&	4115	&	1,17	&	 1,20   	&	1,00	&	0,92	&	0,86	&	0,84	&	 0,78   	&	 0,83   	\\	\hline
84	&	 7715   	&	4717	&	1,16	&	 1,19   	&	1,00	&	0,92	&	0,87	&	0,85	&	 0,78   	&	 0,83   	\\	\hline
85	&	 8657   	&	5486	&	1,14	&	 1,17   	&	1,00	&	0,92	&	0,87	&	0,85	&	 0,79   	&	 0,84   	\\	\hline
86	&	 9807   	&	6358	&	1,12	&	 1,15   	&	0,99	&	0,92	&	0,88	&	0,86	&	 0,79   	&	 0,85   	\\	\hline
87	&	 10979   	&	7284	&	1,10	&	 1,13   	&	0,99	&	0,92	&	0,89	&	0,87	&	 0,81   	&	 0,85   	\\	\hline
88	&	 12233   	&	8303	&	1,09	&	 1,12   	&	0,99	&	0,92	&	0,90	&	0,88	&	 0,82   	&	 0,86   	\\	\hline
89	&	 13678   	&	9609	&	1,07	&	 1,10   	&	0,99	&	0,93	&	0,91	&	0,89	&	 0,84   	&	 0,87   	\\	\hline
90	&	 15250   	&	11026	&	1,06	&	 1,06   	&	0,99	&	0,93	&	0,92	&	0,90	&	 0,86   	&	 0,88   	\\	\hline
91	&	 17100   	&	12511	&	1,04	&	 1,04   	&	0,99	&	0,93	&	0,93	&	0,91	&	 0,87   	&	 0,89   	\\	\hline
92	&	 18937   	&	14188	&	1,03	&	 1,02   	&	0,99	&	0,94	&	0,94	&	0,92	&	 0,89   	&	 0,90   	\\	\hline
93	&	 20691   	&	15935	&	1,02	&	 1,02   	&	0,99	&	0,94	&	0,95	&	0,93	&	 0,91   	&	 0,91   	\\	\hline
94	&	 22845   	&	18073	&	1,01	&	 1,02   	&	0,99	&	0,94	&	0,96	&	0,93	&	 0,92   	&	 0,92   	\\	\hline
95	&	 25186   	&	19737	&	1,01	&	 1,02   	&	0,99	&	0,95	&	0,96	&	0,94	&	 0,93   	&	 0,93   	\\	\hline
96	&	 27318   	&	21985	&	1,01	&	 1,02   	&	0,99	&	0,96	&	0,97	&	0,95	&	 0,94   	&	 0,93   	\\	\hline
97	&	 29237   	&	24488	&	1,01	&	 1,02   	&	0,99	&	0,96	&	0,97	&	0,95	&	 0,95   	&	 0,94   	\\	\hline
98	&	 31290   	&	26517	&	1,01	&	 1,02   	&	1,00	&	0,97	&	0,97	&	0,96	&	 0,96   	&	 0,94   	\\	\hline
99	&	 33487   	&	28740	&	1,01	&	 1,02   	&	1,00	&	0,97	&	0,97	&	0,96	&	 0,97   	&	 0,95   	\\	\hline
100	&	 35627   	&	30916	&	1,01	&	 1,02   	&	1,00	&	0,97	&	0,97	&	0,96	&	 0,97   	&	 0,95   	\\	\hline}
\end{supertabular}
\newpage
Les résultats présentés sont calculés à patir des données projetées de l'INSEE jusqu'en 2070. Les séries sont annuelles, mais pour gagner en simplicité, une seule d'entre elles a servi de référence, la série de 2030. L'horizon des projections du simulateur n'est pas fixe, mais l'ordre de grandeur est de 30 ans, c'est pourquoi l'année 2030 était relativement centrale pour l'exercice.\\\\
Plusieurs scnéarios ont été développés dans les travaux prospectifs de l'INSEE, mais ceux ayant servi aux calculs sont issus du scénario central[Cf. Tables 3.3]\\\\

\begin{table}\centering
\begin{tabular}{|l|p{2.5cm}|p{2.5cm}|}
\hline
\multicolumn{3}{|c|}{Espérance de vie à la naissance 2070 (années)} \\ \hline
Hypothèse & Femmes & Hommes \\ \hline
Centrale & 93,0 & 90,1 \\ \hline
Basse & 90,0 & 87,1 \\ \hline
Haute & 96,0 & 93,1 \\ \hline
\end{tabular}
\caption{Hypothèses de mortalité projetées par l'INSEE selon le sexe}
\begin{flushright}
\source{Champ : France, \\Source : Insee, projections de population 2013-2070,\\ \href{https://www.insee.fr/fr/statistiques/pyramide/2524484/excel/irsocprojpop1370_FECcentESPcentMIGcent.xls}{\textit{Téléchargement direct}}}
\end{flushright}
\end{table}
\boitesimple{\textbf{Esperance de vie à la naissance :} L'espérance de vie à la naissance (ou à l'âge 0) représente la durée de vie moyenne - autrement dit l'âge moyen au décès - d'une génération fictive soumise aux conditions de mortalité de l'année.(INSEE)}
\\Dans le cas présent on retrouve une esperance de 87,7 ans pour les femmes, contre 82,7 ans pour les hommes. Les quotients de mortalité correspondant constituent la série $q_i^{2030}$.
\\Afin de combiner les différents éléments d'analyse, les nouveaux taux $_{s;y}q{*}_i^{2030}$ :
\begin{center}\large{
\begin{equation}$_{s;y}q{*}_i^{2030} = _{s;y}q_i^{2030} *  _{(s;y)}C_{i}^{2013} $ \end{equation}}
\end{center}
\\Les individus nés après 1983 se verront appliqués le taux global, c'est à dire les individus pour lesquels on ne tient pas compte du diplôme, dans ce cas la $_{(s;y)}C_{i}^{2013} = 1$.
\begin{figure}\centering
\includegraphics[height=\textwidth, angle =90]{Hypothese/quotientmortalite.png}
\caption{Quotient mortalité p.100 000 individus par âge, sexe et niveau de diplôme selon la période}
\end{figure}
\newpage
\section{Gestion des migrations}
L'objectif de cette étape était de recréer des lignes individuelles consolidées en ménage afin de pouvoir les intégrer dans les projections au même titre que les individus déjà en présence. Les structures mises en place correspondent à celles observées en 2013. En revanche les hypothèses de migration se font sur les volumes et/ou le poids de chaque type de ménage, comme définie sur les 4 regroupements effectués sur TYPMR. Les caractéristiques de ménages ayant été relevées comme discriminantes dans les migrations. Il était donc nécessaire de générer ces profils pour pouvoir venir piocher dans les bases en fonction des quotas fixés dans l'interface. Le module n'est pas complétement abouti, c'est pourquoi seules les fondations sont présentées.\\\\
La méthode ayant servi pour les générer est intégrée dans Excel, les programmes sont disponbiles dans le fichier\\ $creation\_individus\_immigres.xlsb$ dans l'espace de dépôt. La logique est comme suit :
\\\\1 - On fixe un nombre total correspondant au nombre d'individus qui vont être générés. L'ordre de grandeur est de deux fois l'effectif actuel sur le type de ménage, afin de permettre une amplitude importante dans les hypothèses, et de créer une plus grande diversité d'unité statistique.
\\\\2 - A partir de ce nombre, on multiplie par deux le nombre de ménage actuels. Les ossatures sont ainsi recrées; par exemple pour les familles monoparentales qui constituent un type, il peut exister des ménages de 2 à 5 personnes (principalement). Donc si initialement il y avait 300 ménages 1 parent $+$ 1 enfant, alors on en recrée 600 et donc 1200 individus. Les identifiants sont les mêmes pour les individus d'un même ménage, ce qui permettra par la suite de garder la double lecture. La procédure est réitérée pour chaque type de ménage.
\\\\3- Ensuite, on part du tableau croisé LPRM x Age x Sexe. On distingue les lprm = 1 (Personne de référence), et les autres. Chacun de ces deux sous-groupe suit une loi de probabilité différente. L'inputation est faite à travers la confrontation d'un nombre aléatoire avec la loi de densité correspondante. Dans l'ordre sont mises en place : Sexe, puis Âge, puis diplôme.
\\\\4- La structure est validée lorsque les écarts par âge et sexe de l'ensemble des individus sont très proches (pas de test statistique effectué) de la répartition initiale, par grand type. Les écarts marginaux apparaissent de tant à autre, selon le paramètrage des nombres aléatoires. Celà est percu dans le quatrième volet, intitulé Test de Cohérence visuel qui superpose les deux courbes cumulées, observées et théoriques.
\begin{figure}\centering
\includegraphics[angle=90,height =21.5cm]{Projection/fichier_mig.png}
\caption{Vue du fichier Excel où ont été générées les lignes inviduelles des immigrés potentiels dans Rennes Métropole}
\end{figure}
\begin{figure}\centering
\includegraphics[width=\textwidth]{hypothese/table_mig.png}
\caption{Vue dans phpMyAdmin de la table MySql des migrants générés pour 2013 mais non encore intégrés}
\end{figure}
\newpage
\chapter[Projection]{Etape n\textsuperscript{o}5 : Projection}
\begin{lstlisting}[caption= Paramètrage de la page HTML générant l'interface, language = HTML]
<html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//FR"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<head>
<title>
		OBJET : Resultats des projections
</title>
<style>
body{ background-color: pink;}
	#container{
   float:right;
   height:px;
   width:1200px; 
   marginright : 100px;
}
	container2{
   float:right;
   height:auto;
   width:auto; 
}
 TAB{
   float:left; 
   height: auto;
   width: auto; }
input.button, textarea{background-color: pink;}
</style>
	
<link rel="stylesheet" href="style.css" />
<-- Logo -->
<h1>
<img alt="logo MID" src="logo_audiar_RVB.png" align="right" height="150" width="130">

<-- Titre -->
<b><i>MODULE DE PROJECTION</b></i></img>

<-- Formulaire ICF -->
<h2>
	<form action="PROJ_2905A.php" method="post">
	<p><b>ICF</b>
		<input type="float" name="ICF" /> <!-- La valeur à entrer est au format décimal -->
		<input type="submit" value="OK" class="button"/> <!-- Bouton d'envoi -->
	</p>
	</form>
</h2>
</head>
<body>	
\end{lstlisting}
\lstset{
  language        = php,
  basicstyle      = \scriptsize,
  keywordstyle    = \color{dkblue},
  identifierstyle = \color{dkgreen},
  commentstyle    = \color{gray},
  emph            =[1]{php},
  emphstyle       =[1]\color{black},
  emph            =[2]{if,and,or,else},
  emphstyle       =[2]\color{dkyellow},
	showspaces 			= false
	}
\begin{lstlisting}[language= php, caption= Programme de calcul de projection]
<?php

ini_set('memory_limit', '10000M'); <!-- Mémoire max. utilisable par le programme -->
ini_set('max_execution_time', '60'); <!-- Durée maximale autorisée pour les calculs -->
		
header('Content-type: text/html; charset=iso-8859-1');

#1 CONNEXION
#echo '<br/><br/>CONNEXION';
##1.0 Identifiants
	
$hostname = "localhost"; /* Localisation du serveur */
$username = "root"; /* Nom d'utilisateur MySql */
$password = ""; /* Mdp */
$con = mysqli_connect($hostname, $username, $password, 'projrm') or die(mysqli_error()); /* Connexion */
	
if (mysqli_connect_errno()) {
	printf("Échec de la connexion : %s\n", mysqli_connect_error());
	exit();
	} /* Message d'erreur si problème de connexion */
else echo ("<br/>Connexion ok<br/>");
		
### 	CREATION DES TABLES ANNEE
		
$A=30; %-- Etendue de la projection en années --%
$T0= 2013; %-- Annee intiale --%
$CREA = FALSE; %-- TRUE si les tables ne sont pas encore existantes --%
if($CREA ){
	while($A > -1){
		$Ti = $T0 + $A;
		$DROP_TB ="DROP TABLE IF EXISTS Projrm.T$Ti ";
		mysqli_query($con,$DROP_TB) or die ("Error in query :  $DROP_TB ".mysqli_error($con ));
		$CREA_TB ="CREATE TABLE Projrm.T$Ti (Id INT PRIMARY KEY NOT NULL, Nummi varchar(40), Aged INT NOT NULL, Dipl varchar(2) NOT NULL, Sexe varchar(2) NOT NULL, AleaM float, EtatM_0101 INT, EtatM_3112 INT, AleaF float, EtatF INT)";
		mysqli_query($con,$CREA_TB) or die ("Error in query :  $CREA_TB ".mysqli_error($con ));
		$A--;
		echo "</br> CREA_TB_$Ti</br>";
		}
	}
		
###	CREA MORT
$CREAM = FALSE;
if($CREAM ){
	$DROP_TMF ="DROP TABLE IF EXISTS Projrm.fec";
	mysqli_query($con ,$DROP_TMF ) or die ("Error in query :  $DROP_TMF ".mysqli_error($con ));
			
	$CREA_TM ="CREATE TABLE projrm.morta (code varchar(5) NOT NULL, valeur float )";
	#mysqli_query($con ,$CREA_TM ) or die ("Error in query :  $CREA_TM ".mysqli_error($con ));
			
	$CREA_TF ="CREATE TABLE projrm.fec  (Age int PRIMARY KEY NOT NULL,Poids_rel float not null,  ICF float not null , Taux_fec float not null);";
	mysqli_query($con ,$CREA_TF ) or die ("Error in query :  $CREA_TM ".mysqli_error($con ));
	}
			
### 	INSERTION INITIALE
$INSERTION = FALSE;
if( $INSERTION ){
	$ERASE = "TRUNCATE TABLE T2013";
	mysqli_query($con ,$ERASE ) or die ("ERROR IN QUERY".$ERASE );
		
	$INSERT = "INSERT INTO T2013 (Id, Nummi, Aged, Dipl, Sexe, EtatM_0101) SELECT id, nummi, aged, dipl_15, sexe, 1 FROM rc2013.individus WHERE Iris_2013 like '35080%' and indic_inp > 0";
	mysqli_query($con ,$INSERT) or die ("Error in query :  $INSERT "."</br>".mysqli_error($con));
		
	$DIPL = "UPDATE t2013 SET dipl = 'Z' where aged < 30;";
	mysqli_query($con ,$DIPL) or die ("Error in query :  $DIPL "."</br>".mysqli_error($con));
		
	echo "Insertion 2013 OK</br>";
	}	
/*	
* UPLOAD DES FICHIERS NECESSAIRES
*	Les importations de fichiers hypotheses ont été fait à la main
*/
###	MISE A JOUR ICF
if(empty($_POST ['ICF'])){ # Si aucune valeur en entrée du formulaire
	$ICF = 1.8; #	Valeur ICF par default
	} 
else {
	$ICF = $_POST ['ICF']; # Maj de la valeur ICF
	$UPD_ICF ="UPDATE fec SET ICF = $ICF";
	mysqli_query($con ,$UPD_ICF);
			
	$UPD_TF ="UPDATE fec SET Taux_fec = Poids_rel *  ICF"; # Les éléments de calendrier sont recadrés sur le nouvel ICF
	mysqli_query($con , $UPD_TF);
		
	echo "Mise a jour icf =  $ICF .</br>"; # Message de validation de l'hypothèse
	}

###	Phase Test 
	
	$DELETE_N = TRUE;
	if($DELETE_N )
		{
		$VIDE_NAIS ="DELETE  FROM t2013 WHERE id < 10000;";
		mysqli_query($con ,$VIDE_NAIS );
		}
		
		$truncate = TRUE;
		if($truncate )
		{
		echo "TRUNCATE_";
		$Ti= $T0 + $A;
			
		while($Ti > $T0)
			{
			$ERASE = "TRUNCATE TABLE T$Ti ";
			mysqli_query($con ,$ERASE ) or die ("ERROR IN QUERY".$ERASE );
			
			#echo "_$Ti ";
			$Ti--;}
			echo "</br>";}
					
##   ALEA ET ETAT POUR CHAQUE ANNEE ##

$i = 0; # Indice pour l'année
$Id_kid = 0; # Initialisation des indentifiants enfants

while($i < 30 ){ # Pour les 29 premières années
	$Ti = $T0 + $i; #Redefinir l'annee de la boucle 
	$n =	0; # Reinitialisation de n a chaque boucle

###	ALEA MORTALITE

	if($Ti < 2043){	
		$ALEAM = "UPDATE t$Ti SET aleaM = rand() WHERE  EtatM_0101= 1"; # Generer un nb alea pour les personnes vivantes
		mysqli_query($con , $ALEAM ) or die ("ERROR IN ALEAM" .mysqli_error($con ));
			
		$ALEAF = "UPDATE t$Ti SET aleaF = rand() WHERE  EtatM_0101= 1 AND sexe = 2 and aged < 51 and aged > 14";
		mysqli_query($con , $ALEAF ) or die ("ERROR IN ALEAM" .mysqli_error($con )); # Generer un nb alea pour les femmes en age de procréer
		
		$SELECT = "SELECT * FROM projrm.t$Ti ";
		$SEL = mysqli_query($con ,$SELECT ) or die ("ERROR IN selection" .mysqli_error($con ));
		
		if(!$SEL ){
			echo "LOOSE 1";
			}
		else{
			while($row = mysqli_fetch_array($SEL ))
			{
			$id =	$row ["Id"];
			$S =	$row ["Sexe"];
			$D =	$row ["Dipl"];
			$A =	$row ["Aged"];
			$M =	$row ["EtatM_0101"];
			$RAND =	$row ["AleaM"];
			$F=     $row["AleaF"];
			$N=     $row["Nummi"];

			if(is_null($F )){
				$FEC = "UPDATE t$Ti SET EtatF = 0 WHERE Id = $id ";
				mysqli_query($con ,$FEC );
				}
			else{
				$TF = "SELECT Taux_fec FROM fec WHERE age = $A ";
				$SEL_TF = mysqli_query($con ,$TF ) or die ("ERROR IN TF" .mysqli_error($con ));
				$row =	mysqli_fetch_array($SEL_TF );
				$TF =	$row["Taux_fec"];
				
				if($F > $TF ){
					$NO_NAISS = " UPDATE t$Ti SET EtatF = 0 WHERE id = $id ";
					mysqli_query($con ,$NO_NAISS ) or die ("ERROR IN $NO_NAISS ".mysqli_error($con ));
					}	
				else{
					$NAISS =" UPDATE t$Ti SET EtatF = 1 WHERE id = $id ";
					mysqli_query($con ,$NAISS ) or die ("ERROR IN $NAISS".mysqli_error($con ));
				
					$INSERT_NN =" INSERT INTO t$Ti (nummi, id, aged, sexe, Dipl, EtatM_3112, aleaM) VALUES ($N , $Id_kid , -1, 1+rand(),'Z',1,1)	";
					mysqli_query($con ,$INSERT_NN ) or die ("ERROR IN $INSERT_NN".mysqli_error($con ));
					$n++ ;
					$Id_kid++ ; #echo $Id_kid ;
				     }
			     }
//							
			if($M = 0){
				$DEAD ="UPDATE t$Ti SET EtatM_3112 = 0 WHERE Id  = $Id ";
				mysqli_query($con ,$DEAD );
				}
			else{
				$CODE =	"$A$S$D";
				#echo "</br>$CODE";
			
				$VAL= "SELECT valeur FROM morta WHERE code = '".$CODE."'";
				$SEL_VAL = mysqli_query($con ,$VAL ) or die ("ERROR IN VAL" .mysqli_error($con ));
				$row = mysqli_fetch_array($SEL_VAL);
				$SEUIL = $row ["valeur"]/10;
				
				if($RAND > $SEUIL ){
					$SURVIE = " UPDATE t$Ti SET EtatM_3112 = 1 WHERE id = $id ";
					mysqli_query($con ,$SURVIE ) or die ("ERROR IN $SURVIE".mysqli_error($con ));
					}
				else{
				$MORT ="UPDATE t$Ti SET EtatM_3112 = 0 WHERE id = $id ";
				mysqli_query($con, $MORT) or die ("ERROR in $MORT".mysqli_query($MORT));
				}
			     }	
		}}
### TRANSFERT N+1
$T_plusun = $Ti + 1;

if($T_plusun < 2044){
	$INSERT = "INSERT INTO t$T_plusun (Id, Nummi, Aged, Dipl, Sexe, EtatM_0101) SELECT id, nummi, aged, dipl, sexe, EtatM_3112 FROM t$Ti ";
	mysqli_query($con ,$INSERT ) or die ("Error in query :  $INSERT "."</br>".mysqli_error($con));
			
	$UPD_AGED = "UPDATE T$T_plusun SET aged = aged + 1;";
	mysqli_query($con,$UPD_AGED);
			
	$UPD_AGED100 = "UPDATE T$T_plusun SET aged = 100 where aged > 100;";
	mysqli_query($con,$UPD_AGED100);
	}	
$i++;}

}


//
###	TOTAL POP / ANNEE POUR GRAPH -> JSON
	$t=2013;
	while($t<2044)
	{$res1 = "SELECT count(id) AS POP FROM  t$t where EtatM_0101 = 1";
					$result = mysqli_query($con,$res1);
					while($row=mysqli_fetch_array($result))
					{
					$evol_pop[]=$row["POP"]*1;
					$t++;
					}}
	#print_r($evol_pop);
	$A =json_encode($evol_pop);
	#echo "</br>".$A;
	
	
###	DETAILS AGE x SEXE / ANNEE + INIT (2013) POUR PYRA -> JSON
	if(empty($_POST['Range']))
		{
		$AN_PYRA = 2013;}
		else{
		$AN_PYRA = $_POST['Range'];}
		$SERIE_F="SELECT FLOOR(Aged / 5) * 5 AS Tranche_Age, count(id) AS Serie_F FROM t$AN_PYRA WHERE aged > -1 AND sexe = 2 AND etatM_0101=1 group by Tranche_age";
		$result_SERIE_F = mysqli_query($con,$SERIE_F);
					while($row=mysqli_fetch_array($result_SERIE_F))
					{
					$SF[]=$row["Serie_F"]*1;
					}
					
	#print_r($SF);
	$SF =json_encode($SF);
	
	#	2013	
	$SERIE_F13="SELECT FLOOR(Aged / 5) * 5 AS Tranche_Age, count(id) AS Serie_F13 FROM t2013 WHERE aged > -1 AND sexe = 2 AND etatM_0101=1 group by Tranche_age";
	$result_SERIE_F13 = mysqli_query($con,$SERIE_F13);
					while($row=mysqli_fetch_array($result_SERIE_F13))
					{
					$SF13[]=$row["Serie_F13"]*1;
					}
			
	#print_r($SF);
	$SF13 =json_encode($SF13);
		
	#	H
	$SERIE_M="SELECT FLOOR(Aged / 5) * 5 AS Tranche_Age, count(id) AS Serie_M FROM t$AN_PYRA WHERE aged > -1 AND sexe = 1 AND etatM_0101=1 group by Tranche_age";
	$result_SERIE_M = mysqli_query($con,$SERIE_M);
					while($row=mysqli_fetch_array($result_SERIE_M))
					{
					$SM[]=$row["Serie_M"]*-1;
					}
	#print_r($SM);
	$SM =json_encode($SM);		
	
	#	2013
	$SERIE_M13="SELECT FLOOR(Aged / 5) * 5 AS Tranche_Age, count(id) AS Serie_M13 FROM t2013 WHERE aged > -1 AND sexe = 1 AND etatM_0101=1 group by Tranche_age";
	$result_SERIE_M13 = mysqli_query($con,$SERIE_M13);
					while($row=mysqli_fetch_array($result_SERIE_M13))
					{
					$SM13[]=$row["Serie_M13"]*-1;
					}
	#print_r($SM);
	$SM13 =json_encode($SM13);	
	
###	AGE
	$age=0;	
	while($age<101)
					{
					$aged[]=$age;
					$age=$age+5;
					}
	#print_r($aged);
	$aged2 =json_encode($aged);			
?>
\end{lstlisting}
\newpage
\begin{lstlisting}[language= HTML, caption=Script mixte html/php permettant d'intégrer des résultats variables dans des cadres fixes]
<div id="TAB">
 <table BORDER="1" >
	<tr BGCOLOR="#FF6347">
		<td>1.1.N</td>
		<td>Effectif</td>
		<td>Nb de menages</td>
		<td>Nb de pers/men</td>
		<td>Nb de naissances</td>
		<td>Âge moyen</td>
	</tr>
    <?php 
        for ($t = 2013; $t <= 2043; $t++){ 
    ?>
      <tr>
			<td	BGCOLOR="#FF6347"><?php echo $t; ?>	</td>
		   	<td align="right"><?php 
				{$res1 = "SELECT count(id) AS POP FROM  t$t where EtatM_0101 = 1";
				$result = mysqli_query($con,$res1);
				$row=mysqli_fetch_array($result);
				$count=$row["POP"];
				echo "$count</br>";
				} ?></td>
			<td align="right"><?php 
				{$res1 = "SELECT count(NB) AS NBM FROM (SELECT count(nummi) AS NB from t$t AS B where etatm_0101 = 1 group by nummi) AS A";
				$result = mysqli_query($con,$res1);
				$row=mysqli_fetch_array($result);
				$count=$row["NBM"];
				echo "$count</br>";
				} ?></td>
			<td align="right"><?php 	
				{$res1 = "SELECT avg(NB) AS TMM FROM (SELECT count(nummi) AS NB from t$t AS B where etatm_0101 = 1 group by nummi) AS A";
				$result = mysqli_query($con,$res1);
				$row=mysqli_fetch_array($result);
				$count=$row["TMM"];
				echo "$count</br>";
				}?></td>
			<td align="right"><?php 
				{$res1 = "SELECT count(id) from t$t where etatF = 1";
				$result = mysqli_query($con,$res1);
				$row=mysqli_fetch_array($result);
				$count=$row["count(id)"];
				echo "$count</br>";
				} ?></td>
			<td align="right"><?php 
				{$res1 = "SELECT avg(aged) AS POP FROM  t$t where EtatM_0101 = 1";
				$result = mysqli_query($con,$res1);
				$row=mysqli_fetch_array($result);
				$POP=$row["POP"];
				echo "$POP </br>";
				} ?>
					</td>
		</tr>

     <?php   
        } 
     ?> 
 </table>
 </div>
 
<div align="center"  style="min-width: auto; height: auto; margin: 0 auto">
	<form action="#" method="post" name='AN_PYRA' oninput="result.value=Range.value" >
		<fieldset>Année <output for="out" name="result"></output></br>
			2013<input type="range" name="Range"  step="1"  
			min="2013" max="2043" default='2013' title="Année d'observation.value" value="" />2043
			<span class="range__value"></span>
			<input type="submit" class="button" value="OK" align="right" bgcolor='pink'/>
		</fieldset>
	</form>
</div>

<div id="container" style="min-width: 310px; max-width: 800px; height: 400px; margin: 0 auto">
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
\end{lstlisting}
\newpage
\lstset{
   language=JavaScript,
   extendedchars=true,
   showstringspaces=false,
   showspaces=false,
   numbers=left,
   numberstyle=\footnotesize,
   numbersep=9pt,
   tabsize=2,
   breaklines=true,
   showtabs=false,
   captionpos=b
}
\begin{lstlisting}[caption =Graphique Javascript avec récuperation de données en Json avec renvois php , language = JavaScript]
<script type="text/javascript">

// Data gathered from http://populationpyramid.net/germany/2015/

// Age categories
var categories = <?php echo $aged2; ?>;
$(document).ready(function () {
    Highcharts.chart('container', {
        chart: {
            type: 'bar'
        },
        title: {
            text: 'Pyramide des âges par sexe dans Rennes Métropole'
        },
        subtitle: {
            text: 'Source: <a href="http://populationpyramid.net/germany/2015/">*</a>'
        },
        xAxis: [{
            categories: categories,
            reversed: false,
            labels: {
                step: 5
            }
        }],
        yAxis: {
            title: {
                text: null
            },
            labels: {
                formatter: function () {
                    return Math.abs(this.value) ;
                }
            }
        },

        plotOptions: {
             series: {
            stacking: false,
            groupPadding : 0,
            pointPadding : 0,
            pointWidth : 10
            }
        },

        tooltip: {
            formatter: function () {
                return '<b>' + this.series.name + ', age ' + this.point.category + '</b><br/>' +
                    'Population: ' + Highcharts.numberFormat(Math.abs(this.point.y), 0);
            }
        },
        
        series: [
        {stack: false,
            name: '2013',
            data: <?php echo $SM13; ?>,
            color : '#FF6347'
        }, {stack: false,
        name: ' '
            data: <?php echo $SF13; ?>,
            color : '#FF6347'
        },
        {

			stack: false,
            name: '<?php echo $AN_PYRA;?>',
            
            data: <?php echo $SM; ?>,
            color: 'pink'
        }, {stack: false,
            name: ' ',
            data: <?php echo $SF; ?>,
            color: 'pink'
        }]
    });
});
</script>
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script src="https://code.highcharts.com/modules/exporting.js"></script>
	<div id="AA" style="min-width: 150px; height: 400px; margin: 0 " >

 
<script type="text/javascript">


Highcharts.chart('container2', {
    chart: {
        type: 'area'
    },
    title: {
        text: 'Projection de population Rennes Métropole'
    },
    subtitle: {
        text: 'Source: <a href="http://thebulletin.metapress.com/content/c4120650912x74k7/fulltext.pdf">' +
            '*</a>'
    },
    xAxis: {
        allowDecimals: false,
        labels: {
            formatter: function () {
                return this.value ; // clean, unformatted number for year
            }
        }
    },
    yAxis: {
        title: {
            text: 'Habitants (milliers)'
        },
        labels: {
            formatter: function () {
                return this.value / 1000 + 'k';
            }
        }
    },
    tooltip: {
        pointFormat: '{series.name} comptera <b>{point.y:,.0f}</b><br/>habitants en {point.x}',
        color : 'green',
        symbol : 'cross',
        shadow : false
    },
    
    plotOptions: {
        area: {
            pointStart: 2013,
            marker: {
                enabled: false,
                symbol: 'cross',
                radius: 1,
                states: {
                    hover: {
                        enabled: true
                    }
                }
            }
        }
    },
    series: [{
        name: 'Rennes Métropole',
        data:<?php echo $A; ?>,
        color:'pink'
    }]
});
\end{lstlisting}
\begin{lstlisting}[language=HTML]
</script>
</div>

</html>
\end{lstlisting}
\newpage
\begin{figure} \centering
\includegraphics[width=\textwidth]{projection/table_classique.png}
\caption{Vue de la table MySql individus recomposée, en 2013, avant l'application des hypothèses, dans l'interface phpMyAdmin}
\label{Table générale}
\end{figure}
\newpage
\begin{figure} \centering
\rotatebox{90}{\includegraphics[width=\textheight]{projection/Visualisation_res2.png}}
\caption{Interface HTML générée après l'application des calculs de projection}
\end{figure}
\clearemptydoublepage
\part[Migrations résidentielles]{Etudes sur les migrations résidentielles}
\chapter[Publication INSEE-AUDIAR]{Publication INSEE-AUDIAR}
La publication faite en partenariat avec l'INSEE n'est, à ce jour, pas disponible, puisque la sortie est prévue pour début octobre 2017. L'ensemble des productions sont gardées par l'INSEE bien que les participations soient partagées. Seuls quelques documents de travail sont ici présentés à titre indicatif.\\\\
\begin{figure}
\centering
\includegraphics[width=\textwidth]{insee/insee1.png}
\caption{Description des classes obtenues lors de la CAH par modalités les plus représentées}
\begin{flushright}
\champ{Champ : Ensemble des nouveaux entrants dans Rennes Métropole en 2014\\}
\source{Source : FiDéli 2015, traitement INSEE Bretagne}
\end{flushright}
\end{figure}
\newpage
\begin{figure}
\centering
\includegraphics[width=\textwidth]{insee/insee2.png}
\caption{Schéma de ré-attribution des individus dans les classes constituées par la CAH}
\begin{flushright}
\champ{Champ : Ensemble des nouveaux entrants dans Rennes Métropole en 2014\\}
\source{Source : FiDéli 2015, traitement INSEE Bretagne}
\end{flushright}
\end{figure}
\begin{figure}
\centering
\includegraphics[width=\textwidth]{insee/insee3.png}
\caption{Poids relatif de chaque classe issue de la CAH, selon le type de migration}
\begin{flushright}
\champ{Champ : Ensemble des migrations dans Rennes Métropole en 2014\\}
\source{Source : FiDéli 2015, traitement INSEE Bretagne}
\end{flushright}
\end{figure}
\chapter[Publication Audiar]{Publication Audiar}
Le document qui suit est actuellement la dernière version, et devrait subir des modifications à la marge avant d'être publiée en même temps que la première étude. J'ai constitué l'ensemble des figures et traitements associés (à l'exception du schéma sur les cycles de vie), dans le cadre du processus définit dans le rapport de stage. La rédaction est en revanche faite intégralement par Isabelle de Boismenu. L'ensemble du fichier Excel est disponible sur l'espace de dépôt.
\includepdfmerge[nup=1x1, linktodoc, scale = 0.80, offset =30mm -30mm]
{Mobilites-residentielles_V1_PRINT.pdf, 1}
\includepdfmerge[nup=1x2, angle=90, linktodoc, offset =30mm -30mm, scale =0.80, frame = true]
{Mobilites-residentielles_V1_PRINT.pdf, 3-2,
Mobilites-residentielles_V1_PRINT.pdf, 5-4,
Mobilites-residentielles_V1_PRINT.pdf, 7-6,
Mobilites-residentielles_V1_PRINT.pdf, 9-8,
Mobilites-residentielles_V1_PRINT.pdf, 11-10,
Mobilites-residentielles_V1_PRINT.pdf, 13-12,
Mobilites-residentielles_V1_PRINT.pdf, 15-14,
Mobilites-residentielles_V1_PRINT.pdf, 17-16,
Mobilites-residentielles_V1_PRINT.pdf, 19-18,
Mobilites-residentielles_V1_PRINT.pdf, 21-20,
Mobilites-residentielles_V1_PRINT.pdf, 23-22,
Mobilites-residentielles_V1_PRINT.pdf, 25-24,
Mobilites-residentielles_V1_PRINT.pdf, 27-26,
Mobilites-residentielles_V1_PRINT.pdf, 29-28,
Mobilites-residentielles_V1_PRINT.pdf, 31-30,
Mobilites-residentielles_V1_PRINT.pdf, 33-32,
Mobilites-residentielles_V1_PRINT.pdf, 35-34,
Mobilites-residentielles_V1_PRINT.pdf, 37-36,
Mobilites-residentielles_V1_PRINT.pdf, 39-38,
Mobilites-residentielles_V1_PRINT.pdf, 41-40,
Mobilites-residentielles_V1_PRINT.pdf, 43-42,
Mobilites-residentielles_V1_PRINT.pdf, 45-44}
\includepdfmerge
[nup=1x1, linktodoc, scale = 0.80, offset =30mm -30mm]
{Mobilites-residentielles_V1_PRINT.pdf, 48}
\clearemptydoublepage
\part[Elements divers]{Elements divers}
\lstset{
  language        = HTML,
	upquote					= true,
  basicstyle      = \scriptsize,
  keywordstyle    = \color{dkblue},
  commentstyle    = \color{gray},
	rulecolor				= \color{mypink},
	backgroundcolor	=\color{myblue!5},
	breaklines,
	showspaces 			= False,
	showtabs				= false,
	alsodigit				=	{.:;},
	numbers					= left,
	stepnumber			= 5,
	firstnumber			= 1,
	numberfirstline = true,
	frame						= lines,
	columns					= fullflexible
	}
\begin{lstlisting}[language= HTML, caption=Page HTML intégrant le diagramme de chord et la cartograhie dynamique]
<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style>
body {
  font: 10px sans-serif;
}

svg text{
  fill:grey;
  font-size:15px;
	font : arial;
}
svg .values text{
  pointer-events:none;
  stroke-width: 0.5px;
}
.groups:hover{
  cursor:pointer;
  font-weight:bold;
}

</style>

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="./resources/ol.css" />
<link rel="stylesheet" href="./resources/ol3-layerswitcher.css">
<link rel="stylesheet" href="./resources/qgis2web.css">
<style>
        html, body {
            background-color: #ffffff;
        }
        </style>
        <style>
        html, 	body, #map {
            	width	: 100%;
            	height	: 100%;
            	padding	: 0;
            	margin	: 0;
        	}
        </style>
        <title></title>    
<div>
<font size=8>
Migrations residentielles en nombre de personnes </br> ayant transite par Rennes Metropole(43) durant l'annee 2012.
</font>
</div>  
 
</head>

<body>

<div id="2">
<i><font size=4>
</br></br>
Rennes : Commune de Rennes </br>
Coeur : Saint Gregoire / Cesson / Chantepie / Saint Jacques </br>
Pole : Pole structurant de Rennes Metropole ie. Betton / Pace / Le Rheu (j'ai oublie le nom des autres) </br>
Rennes Metropole : Autres communes de RM, non concernees par la typologie precedente </br>
</br>
Aire urbaine : Communes de l'Aire urbaine de Rennes (011) moins les communes de RM</br>
Proximite : Commune des departements 35(non AU)/ 22 / 56 / 50 / 53 /44 </br>
Grand Ouest : Communes des departements 29 / 14 / 49 /61 / 72 / 85 </br>
Ile-de-France : Communes des departements 75/ 77/ 78/ 91/ 92/ 93/ 94 / 94 / 95 </br>
France entiere : Communes des departements francais non cites, dont DOM TOM</br>
ZZZ : !!!!!! AUTRES
</i></font>
</div>

<div id="2">
<i>
<font size=2>
</br>
</br>
Note de lecture :</br>
En 2012, 5 525 personnes ont change de domicile alors qu'elles habitaient dans le Coeur de Metropole.</br>
Parmi elles, 756 sont parties s'installer dans le reste de l'Aire Urbaine. [Donnees apparaissant au survol de la categorie]</br>
A contrario, 928 ont choisi de s'installer dans la commune de Rennes.</br>
</i>
</font>
</div>


<!--	 Cartogprahie -->
	<
<div id="map" style="height:500x; width: 500px; float: right; margin-right : 40px;">
	<div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        	<div id="popup-content"> </div>
	</div>
</div>

<!-- References aux exports qgis2web, place dans la dossier racine de la page html -->

<script src="resources/polyfills.js"></script>
<script src="./resources/ol.js"></script>
<script src="./resources/ol3-layerswitcher.js"></script>
<script src="layers/France.js"></script><script src="layers/IledeFrance.js"></script><script src="layers/GrandOuest.js"></script><script src="layers/AireUrbainedeRennes.js"></script><script src="layers/RennesMetropoleEstOuest.js"></script><script src="layers/RennesMetropoleNordSud.js"></script><script src="layers/RennesMtropole.js"></script><script src="layers/CoeurdeMetropole.js"></script><script src="layers/Coeur1.js"></script><script src="layers/Coeur2.js"></script><script src="layers/Rennes.js"></script><script src="layers/Polestructurant.js"></script>
<script src="styles/France_style.js"></script><script src="styles/IledeFrance_style.js"></script><script src="styles/GrandOuest_style.js"></script><script src="styles/AireUrbainedeRennes_style.js"></script><script src="styles/RennesMetropoleEstOuest_style.js"></script><script src="styles/RennesMetropoleNordSud_style.js"></script><script src="styles/RennesMtropole_style.js"></script><script src="styles/CoeurdeMetropole_style.js"></script><script src="styles/Coeur1_style.js"></script><script src="styles/Coeur2_style.js"></script><script src="styles/Rennes_style.js"></script><script src="styles/Polestructurant_style.js"></script>
<script src="./layers/layers.js" type="text/javascript"></script> 
<script src="./resources/qgis2web.js"></script>
<script src="./resources/Autolinker.min.js"></script>
        
        
<!--	Diagramme de chord -->

<div id="diagramme" style="height:1200x; width: 1100px; float: right; margin-left : 40px;">

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://vizjs.org/viz.v1.1.0.min.js"></script>
<script>

var data = [
 ['Rennes','Rennes',19888]
,['Rennes','Coeur',1540]
,['Rennes','Pole',1437]
,['Rennes','Rennes Metropole',1920]
,['Rennes','Aire Urbaine',2346]
,['Rennes','Grand Ouest',6854]
,['Rennes','Ile-de-France',2506]
,['Rennes','France entiere',4545]
,['Rennes','99999',0]
,['Coeur','Rennes',928]
,['Coeur','Coeur',1652]
,['Coeur','Pole',423]
,['Coeur','Rennes Metropole',560]
,['Coeur','Aire Urbaine',756]
,['Coeur','Grand Ouest',652]
,['Coeur','Ile-de-France',189]
,['Coeur','France entiere',365]
,['Coeur','99999',0]
,['Pole','Rennes',825]
,['Pole','Coeur',219]
,['Pole','Pole',2538]
,['Pole','Rennes Metropole',1032]
,['Pole','Aire Urbaine',1264]
,['Pole','Grand Ouest',1044]
,['Pole','Ile-de-France',292]
,['Pole','France entiere',545]
,['Pole','99999',0]
,['Rennes Metropole','Rennes',897]
,['Rennes Metropole','Coeur',344]
,['Rennes Metropole','Pole',783]
,['Rennes Metropole','Rennes Metropole',3413]
,['Rennes Metropole','Aire Urbaine',2058]
,['Rennes Metropole','Grand Ouest',1325]
,['Rennes Metropole','Ile-de-France',251]
,['Rennes Metropole','France entiere',558]
,['Rennes Metropole','99999',0]
,['Aire Urbaine','Rennes',1914]
,['Aire Urbaine','Coeur',451]
,['Aire Urbaine','Pole',751]
,['Aire Urbaine','Rennes Metropole',1221]
,['Aire Urbaine','Aire Urbaine',0]
,['Aire Urbaine','Grand Ouest',0]
,['Aire Urbaine','Ile-de-France',0]
,['Aire Urbaine','France entiere',0]
,['Aire Urbaine','99999',0]
,['Grand Ouest','Rennes',10259]
,['Grand Ouest','Coeur',1218]
,['Grand Ouest','Pole',1593]
,['Grand Ouest','Rennes Metropole',1516]
,['Grand Ouest','Aire Urbaine',0]
,['Grand Ouest','Grand Ouest',0]
,['Grand Ouest','Ile-de-France',0]
,['Grand Ouest','France entiere',0]
,['Grand Ouest','99999',0]
,['Ile-de-France','Rennes',2475]
,['Ile-de-France','Coeur',555]
,['Ile-de-France','Pole',409]
,['Ile-de-France','Rennes Metropole',365]
,['Ile-de-France','Aire Urbaine',0]
,['Ile-de-France','Grand Ouest',0]
,['Ile-de-France','Ile-de-France',0]
,['Ile-de-France','France entiere',0]
,['Ile-de-France','99999',0]
,['France entiere','Rennes',4128]
,['France entiere','Coeur',576]
,['France entiere','Pole',748]
,['France entiere','Rennes Metropole',634]
,['France entiere','Aire Urbaine',0]
,['France entiere','Grand Ouest',0]
,['France entiere','Ile-de-France',0]
,['France entiere','France entiere',0]
,['France entiere','99999',0]
,['99999','Rennes',2117]
,['99999','Coeur',247]
,['99999','Pole',287]
,['99999','Rennes Metropole',153]
,['99999','Aire Urbaine',0]
,['99999','Grand Ouest',0]
,['99999','Ile-de-France',0]
,['99999','France entiere',0]
,['99999','99999',0]

];

var colors = {
"Rennes"		: "#fec00f"
,"Coeur"		: "#d9df5e"
,"Pole"			: "#9bbb59"
,"Rennes Metropole"	: "#8064a2"
,"Aire Urbaine"		: "#eb4ddc"
,"Grand Ouest"		: "#f78746"
,"Ile-de-France"	: "#3333cc"
,"France entiere"	: "#00000"
,"99999"		: "#4e7bda"
};

var sortOrder =[
 "Rennes"
,"Coeur"
,"Pole"
,"Rennes Metropole"
,"Aire Urbaine"
,"Grand Ouest"
,"Ile-de-France"
,"France entiere"
,"99999"
];

function sort(a,b){ return d3.ascending(sortOrder.indexOf(a),sortOrder.indexOf(b)); }

var ch = viz.ch().data(data)
      	.padding(.01)
      	.sort(sort)
	.innerRadius(430)
	.outerRadius(450)
	.duration(1000)
	.chordOpacity(0.3)
	.labelPadding(.03)
      	.fill(function(d){ 
			return colors[d];
		}
	 	);

var width=1200, height=1100;

var svg = d3.select("body").append("svg").attr("height",height).attr("width",width);

svg.append("g").attr("transform", "translate(600,550)").call(ch);

// adjust height of frame in bl.ocks.org

d3.select(self.frameElement).style("height", height+"px").style("width", width+"px");     

</script>
</body>
\end{lstlisting}
\newpage
\begin{figure} \centering
		\includegraphics[width=\textwidth]{diagramme/web1.png}
			\caption{\label{Vue statique du diagramme de chord} Vue initiale 		de 	la page html contenant le diagramme de chord et la cartographie dynamique}
	\end{figure}
\begin{figure} \centering
		\includegraphics[width=\textwidth]{diagramme/web2.png}
		\caption{\label{Vue dynamique du diagramme de chord} Vue au survol d'une modalité de la page html contenant le diagramme de chord et la cartographie dynamique}
	\end{figure}

\backmatter
\clearemptydoublepage
\listoffigures
\addcontentsline{toc}{part}{Liste des figures}
\clearemptydoublepage
\listoftables
\addcontentsline{toc}{part}{Liste des tableaux}
\clearemptydoublepage
\lstlistoflistings
\addcontentsline{toc}{part}{Liste des listings}
\clearemptydoulepage
\end{document}